<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>íˆ¬ì–´íŒ¨ìŠ¤ì‚¬ì—…ë¶€ 2025 ì›Œí¬ìƒµ | TRAVEL SHIFT</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:'Noto Sans KR',sans-serif;background:#f2f4f9;min-height:100vh;color:#222}
  .app-container{max-width:420px;margin:0 auto;background:#fff;min-height:100vh;border-left:1px solid #eee;border-right:1px solid #eee}
  .app-header{background:#ffffff;border-bottom:1px solid #eee;text-align:center;padding:18px 12px;position:sticky;top:0;z-index:5}
  .app-title{font-size:1.05rem;font-weight:800;letter-spacing:.2px}
  .app-subtitle{font-size:.82rem;color:#667;}
  .status-bar{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-bottom:1px solid #eee;background:#fafbff}
  .connection-status{display:flex;align-items:center;gap:8px;font-size:.85em}
  .status-dot{width:8px;height:8px;border-radius:50%}
  .status-online{background:#2ecc71}.status-offline{background:#ff6b6b}
  .main-content{padding:16px}
  .google-login{background:#fff;border:1px solid #eee;border-radius:12px;padding:18px}
  .login-btn{width:100%;background:#111827;color:#fff;border:none;border-radius:10px;padding:12px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px}
  .login-btn:hover{opacity:.92}
  .user-info{display:none;align-items:center;gap:12px;padding:14px;background:#f6f7fb;border:1px solid #eee;border-radius:10px;margin-top:12px}
  .user-avatar{width:40px;height:40px;border-radius:50%;background:#111827;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800}
  .user-details h4{font-size:.98em}
  .user-details p{font-size:.78em;color:#666}

  /* ---- ë©”ë‰´ íƒ€ì¼ ---- */
  .menu-grid{display:none;grid-template-columns:1fr 1fr;gap:12px;margin:16px 0 8px}
  .menu-item{
    position:relative;border:1px solid #eee;border-radius:14px;padding:16px;
    cursor:pointer;transition:transform .18s ease, box-shadow .18s ease;background:#fff;overflow:hidden;
    box-shadow:0 4px 14px rgba(16,24,40,.04);
  }
  .menu-item:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(16,24,40,.08)}
  .menu-item:active{transform:scale(.98)}
  .menu-item::before{
    content:"";position:absolute;inset:0;z-index:0;
    background:
      radial-gradient(30% 40% at 90% 10%, rgba(0,0,0,.04), transparent 60%),
      radial-gradient(25% 35% at 0% 100%, rgba(0,0,0,.04), transparent 60%),
      linear-gradient(180deg,#ffffff 0%,#f8fafc 100%);
  }
  .menu-item::after{
    content:attr(data-mark);
    position:absolute;right:-6px;bottom:-10px;z-index:0;
    font-size:56px;opacity:.08;color:#000;font-weight:900;pointer-events:none;
  }
  .menu-item > *{position:relative;z-index:1}
  .menu-icon{font-size:2em;margin-bottom:6px;color:#111827}
  .menu-title{font-size:.92em;font-weight:800}
  .menu-desc{font-size:.72em;color:#606}

  .app-translate{background:#fff;border:1px solid #eee;border-radius:12px;padding:14px}

  /* ëª¨ë‹¬ */
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:1000}
  .modal-content{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border-radius:14px;max-width:92%;width:360px;max-height:88%;overflow:auto;box-shadow:0 24px 48px rgba(16,24,40,.24)}
  .modal-header{padding:18px 18px 0}
  .close-btn{position:absolute;top:10px;right:12px;background:#fff;border:1px solid #eee;border-radius:8px;font-size:1rem;padding:4px 8px;cursor:pointer}

  /* ì°¸ê°€ì */
  .participants-list{max-height:360px;overflow:auto;padding:0 16px 16px}
  .participant-item{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid #f0f0f0}
  .participant-avatar{width:30px;height:30px;border-radius:50%;background:#111827;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:.85em}
  .sync-btn{background:#111827;color:#fff;border:none;border-radius:10px;padding:10px 12px;cursor:pointer}

  /* MBTI */
  .mbti-test{padding:18px}
  .question-card{background:#f7f7fb;border:1px solid #eee;border-radius:12px;padding:16px}
  .question-number{color:#111827;font-weight:800;margin-bottom:8px}
  .question-text{line-height:1.5;margin-bottom:14px}
  .answer-btn{width:100%;background:#fff;border:2px solid #eee;border-radius:10px;padding:12px;text-align:left;margin-top:10px;cursor:pointer}
  .answer-btn:hover{border-color:#111827;background:#f4f5f7}
  .answer-btn.selected{border-color:#111827;background:#111827;color:#fff}
  .progress-bar{height:4px;background:#eee;border-radius:2px;margin-bottom:12px}
  .progress-fill{height:100%;width:0;background:#111827;border-radius:2px;transition:width .3s}

  /* ê´€ê³„ë„(ì¹´í…Œê³ ë¦¬ ì¹´ë“œ) */
  .rel-cat{margin-bottom:18px}
  .rel-head{display:flex;align-items:center;gap:8px;color:#fff;padding:10px 12px;border-radius:10px;margin-bottom:10px;font-weight:900}
  .rel-box{background:#fafbff;border:1px solid #eee;border-radius:10px;padding:12px}
  .rel-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:10px}
  .rel-card{background:#fff;border:1px solid #eee;border-left:4px solid #000;border-radius:8px;padding:10px}
  .rel-row{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .badge{background:#111827;color:#fff;padding:4px 8px;border-radius:6px;font-size:.78em;font-weight:800}
  .muted{font-size:.8em;color:#666;margin-top:6px}

  /* ì¼ì •(ê°„ë‹¨) */
  .schedule-item{display:flex;align-items:flex-start;padding:10px 0;border-bottom:1px solid #eee}
  .schedule-item:last-child{border-bottom:none}
  .schedule-item .time{width:60px;font-weight:800;color:#111827}
  .schedule-item .activity{flex:1;margin:0 10px}
  .schedule-item .location{width:120px;color:#666;text-align:right}

  /* ì‘ì€ í™”ë©´ */
  @media (max-width:480px){.app-container{max-width:100%}.menu-icon{font-size:1.8em}}
</style>
</head>
<body>
  <div class="app-container">
    <div class="app-header">
      <div class="app-title">íˆ¬ì–´íŒ¨ìŠ¤ì‚¬ì—…ë¶€ 2025 ì›Œí¬ìƒµ</div>
      <div class="app-subtitle">TRAVEL SHIFT</div>
    </div>

    <div class="status-bar">
      <div class="connection-status">
        <div id="connectionDot" class="status-dot"></div>
        <span id="connectionText">ì—°ê²° í™•ì¸ ì¤‘...</span>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <div id="lastSync">ë™ê¸°í™”: -</div>
        <button onclick="syncData()" title="ë°ì´í„° ë™ê¸°í™”" style="background:none;border:none;cursor:pointer;font-size:1.05em">ğŸ”„</button>
        <button id="logoutBtn" onclick="logout()" style="background:#fff;border:1px solid #ddd;border-radius:8px;padding:6px 10px;cursor:pointer">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>

    <div class="main-content">
      <!-- ë¡œê·¸ì¸ -->
      <div id="loginSection" class="google-login">
        <button id="googleLoginBtn" class="login-btn">
          <i class="fab fa-google"></i> ì´ë¦„+MBTIë¡œ ë¡œê·¸ì¸
        </button>
        <p style="font-size:.82em;color:#666;margin-top:10px;text-align:center">
          ì›Œí¬ìƒµ ì°¸ì—¬ë¥¼ ìœ„í•´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤
        </p>
      </div>

      <!-- ì‚¬ìš©ì ì •ë³´ -->
      <div id="userInfo" class="user-info">
        <div id="userAvatar" class="user-avatar">U</div>
        <div class="user-details">
          <h4 id="userName">ì‚¬ìš©ì</h4>
          <p id="userEmail"></p>
          <p id="userDept" style="margin-top:2px"></p>
        </div>
      </div>

      <!-- ë©”ë‰´ -->
<div id="mainMenu" class="menu-grid">
  <div class="menu-item" data-action="participants" data-mark="ğŸ‘¥" onclick="openModal('participantsModal')">
    <div class="menu-icon">ğŸ‘¥</div>
    <div class="menu-title">ì°¸ê°€ì í˜„í™©</div>
    <div class="menu-desc">MBTI ë° íŒ€ êµ¬ì„± ë³´ê¸°</div>
  </div>

  <!-- ë³€ê²½: ì¼ì • í´ë¦­ ì‹œ ìƒì„¸ ì¼ì • ë°”ë¡œ ì˜¤í”ˆ -->
  <div class="menu-item" data-action="schedule" data-mark="ğŸ“…" onclick="showDetailedSchedule()">
    <div class="menu-icon">ğŸ“…</div>
    <div class="menu-title">ì›Œí¬ìƒµ ì¼ì •</div>
    <div class="menu-desc">ìƒì„¸ ì¼ì • ë° í”„ë¡œê·¸ë¨</div>
  </div>

  <div class="menu-item" data-action="mbti" data-mark="ğŸ§ " onclick="startMBTITest()">
    <div class="menu-icon">ğŸ§ </div>
    <div class="menu-title">MBTI ê²€ì‚¬</div>
    <div class="menu-desc">ì„±ê²© ìœ í˜• ê²€ì‚¬ ì‹¤ì‹œ</div>
  </div>

  <!-- ë³€ê²½: 4ë²ˆì§¸ ìë¦¬ì— 'íˆ¬ì–´íŒ¨ìŠ¤ ë³´ê´€í•¨' ì´ë™ -->
  <div class="menu-item" data-action="tourpassbox" data-mark="ğŸ“¦" onclick="openModal('tourpassBoxModal')">
    <div class="menu-icon">ğŸ“¦</div>
    <div class="menu-title">íˆ¬ì–´íŒ¨ìŠ¤ ë³´ê´€í•¨</div>
    <div class="menu-desc">ê°œì¸ ë§í¬ ì €ì¥ì†Œ</div>
  </div>

  <div class="menu-item" data-action="survey" data-mark="ğŸ“" onclick="openModal('surveyModal')">
    <div class="menu-icon">ğŸ“</div>
    <div class="menu-title">ì„¤ë¬¸ì¡°ì‚¬</div>
    <div class="menu-desc">ì›Œí¬ìƒµ ë§Œì¡±ë„</div>
  </div>

  <!-- ë³€ê²½: ê¸°ì¡´ 'íˆ¬ì–´íŒ¨ìŠ¤ ë³´ê´€í•¨' ìë¦¬(6ë²ˆì§¸)ì— 'ì›Œí¬ìˆ ì±—ë´‡' ìƒì„± -->
  <div class="menu-item" data-action="chatbot" data-mark="ğŸ¤–" onclick="openWorkshopChatbot()">
    <div class="menu-icon">ğŸ¤–</div>
    <div class="menu-title">ì›Œí¬ìˆ ì±—ë´‡</div>
    <div class="menu-desc">ëŒ€í™”í˜• ë„ìš°ë¯¸ ë°”ë¡œê°€ê¸°</div>
  </div>
</div>

      <!-- ë²ˆì—­ -->
      <div class="app-translate">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <h4>ğŸŒ ì•± ë²ˆì—­í•˜ê¸°</h4>
          <select id="languageSelect" onchange="translateApp()" style="padding:6px;border-radius:8px;border:1px solid #ddd">
            <option value="ko">í•œêµ­ì–´</option><option value="en">English</option><option value="ja">æ—¥æœ¬èª</option><option value="zh">ä¸­æ–‡</option>
          </select>
        </div>
        <div style="font-size:.82em;color:#666">ì–¸ì–´ë¥¼ ì„ íƒí•˜ë©´ ì•± ì „ì²´ê°€ ë²ˆì—­ë©ë‹ˆë‹¤</div>
      </div>
    </div>
  </div>

  <!-- ì°¸ê°€ì ëª¨ë‹¬ -->
  <div id="participantsModal" class="modal">
    <div class="modal-content" style="width:760px;max-width:95%">
      <button class="close-btn" onclick="closeModal('participantsModal')">&times;</button>
      <div class="modal-header"><h3>ì°¸ê°€ì í˜„í™©</h3></div>
      <div style="padding:10px 0 6px 0">
        <div class="participants-list" id="participantsList"></div>
        <div style="display:flex;gap:8px;align-items:center;padding:0 16px 16px">
          <button class="sync-btn" style="flex:1" onclick="showMBTIRelationship()">MBTI ê´€ê³„ë„ ë³´ê¸°</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MBTI ê²€ì‚¬ ëª¨ë‹¬ -->
  <div id="mbtiModal" class="modal">
    <div class="modal-content" style="width:760px;max-width:95%">
      <button class="close-btn" onclick="closeMBTITest()">&times;</button>
      <div class="mbti-test">
        <div class="progress-bar"><div id="progressBar" class="progress-fill"></div></div>
        <div class="question-card">
          <div id="questionNumber" class="question-number">ì§ˆë¬¸ 1/10</div>
          <div id="questionText" class="question-text">ìƒˆë¡œìš´ ì‚¬ëŒì„ ë§Œë‚¬ì„ ë•Œ</div>
          <div id="answerOptions"></div>
        </div>
        <button id="nextBtn" onclick="nextQuestion()" style="display:none;background:#111827;color:#fff;border:none;border-radius:8px;padding:12px 18px;cursor:pointer;margin-top:14px">
          ë‹¤ìŒ ì§ˆë¬¸
        </button>
      </div>
    </div>
  </div>


 
  <!-- ì„¤ë¬¸ ëª¨ë‹¬ -->
  <div id="surveyModal" class="modal">
    <div class="modal-content" style="width:760px;max-width:95%">
      <button class="close-btn" onclick="closeModal('surveyModal')">&times;</button>
      <div class="modal-header"><h3>ì›Œí¬ìƒµ ë§Œì¡±ë„ ì¡°ì‚¬</h3></div>
      <div style="padding:16px 18px 22px">
        <div id="surveyForm">
          <div style="margin-bottom:16px">
            <label style="display:block;margin-bottom:8px;font-weight:700">ì „ì²´ì ì¸ ë§Œì¡±ë„</label>
            <input id="satisfaction" type="range" min="1" max="5" value="3" style="width:100%" oninput="document.getElementById('satisfactionValue').textContent=this.value">
            <div style="text-align:center;margin-top:6px"><span id="satisfactionValue">3</span>/5</div>
          </div>
          <div style="margin-bottom:16px">
            <label style="display:block;margin-bottom:8px;font-weight:700">ê°€ì¥ ë§Œì¡±í–ˆë˜ í™œë™</label>
            <select id="bestActivity" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:10px">
              <option value="">ì„ íƒí•´ì£¼ì„¸ìš”</option>
              <option value="wonjun-tour">ì›ì¤€ë‹˜ì˜ ë„ìŠ¨íŠ¸ íˆ¬ì–´</option>
              <option value="accommodation">ìˆ™ì†Œ</option>
              <option value="chungnam-tourpass">ì¶©ë‚¨íˆ¬ì–´íŒ¨ìŠ¤ ì²´í—˜</option>
              <option value="food">ìŒì‹</option>
              <option value="performance-sharing">ì„±ê³¼ê³µìœ  ë° ë¹„ì „ê³µìœ </option>
            </select>
          </div>
          <div style="margin-bottom:16px">
            <label style="display:block;margin-bottom:8px;font-weight:700">ê°œì„  ì˜ê²¬ ë° í”¼ë“œë°±</label>
            <textarea id="feedback" placeholder="ììœ ë¡­ê²Œ ì˜ê²¬ì„ ì‘ì„±í•´ì£¼ì„¸ìš”..." style="width:100%;height:90px;padding:10px;border:1px solid #ddd;border-radius:10px;resize:vertical"></textarea>
          </div>
          <button onclick="submitWorkshopSurvey()" class="sync-btn" style="width:100%">ì„¤ë¬¸ì¡°ì‚¬ ì œì¶œ</button>
        </div>
      </div>
    </div>
  </div>

 <script>
// ì›Œí¬ìˆ ì±—ë´‡ ë§í¬ ì˜¤í”ˆ
function openWorkshopChatbot() {
  window.open(
    'https://chatgpt.com/g/g-6899821cd87481919c7a20d26b89f0ce-tueopaeseusaeobbu-weokeusyob-aieosiseuteonteu',
    '_blank'
  );
}
</script>

  <!-- íˆ¬ì–´íŒ¨ìŠ¤ ë³´ê´€í•¨ ëª¨ë‹¬ -->
  <div id="tourpassBoxModal" class="modal">
    <div class="modal-content" style="width:760px;max-width:95%">
      <button class="close-btn" onclick="closeModal('tourpassBoxModal')">&times;</button>
      <div class="modal-header"><h3>ğŸ“¦ íˆ¬ì–´íŒ¨ìŠ¤ ë³´ê´€í•¨</h3></div>
      <div style="padding:16px 18px 22px">
        <div style="margin-bottom:14px">
          <button onclick="showAddLinkForm()" style="background:#2ecc71;color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer">â• ìƒˆ ë§í¬ ì¶”ê°€</button>
        </div>
        <div id="addLinkForm" style="display:none;background:#f8f9fb;border:1px solid #eee;padding:14px;border-radius:12px;margin-bottom:14px">
          <h4 style="margin-bottom:10px">ğŸ”— ìƒˆ ë§í¬ ì¶”ê°€</h4>
          <div style="margin-bottom:8px">
            <label style="display:block;margin-bottom:6px;font-weight:700">ì œëª©</label>
            <input id="linkTitle" type="text" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:10px">
          </div>
          <div style="margin-bottom:8px">
            <label style="display:block;margin-bottom:6px;font-weight:700">URL</label>
            <input id="linkUrl" type="url" placeholder="https://example.com" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:10px">
          </div>
          <div style="margin-bottom:10px">
            <label style="display:block;margin-bottom:6px;font-weight:700">ë¹„ë°€ë²ˆí˜¸(ì„ íƒ)</label>
            <input id="linkPassword" type="password" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:10px">
          </div>
          <div style="display:flex;gap:8px">
            <button onclick="saveNewLink()" class="sync-btn">ğŸ’¾ ì €ì¥</button>
            <button onclick="cancelAddLink()" style="background:#9aa0a6;color:#fff;border:none;border-radius:10px;padding:10px 12px;cursor:pointer">âŒ ì·¨ì†Œ</button>
          </div>
        </div>
        <div id="linksList" style="max-height:340px;overflow:auto"></div>
      </div>
    </div>
  </div>

<script>
/* =========================
   0) ìƒìˆ˜/ì „ì—­
========================= */
const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyQyuXtoF6LOh7Ag8w1N9yVbTV9MecJSg16UyP5VSb1kt2SDplndvsxX6OpDgGIXiv8/exec';

let currentUser = null;
let isOnline = false;
let currentQuestion = 0;
let mbtiAnswers = [];

/* =========================
   1) ì´ë¦„ â†’ ë¶€ì„œ/ì§ê¸‰ ë§¤í•‘
========================= */
const DIRECTORY = {
  "ë‚¨ë„í˜„": { team:"íˆ¬ì–´íŒ¨ìŠ¤ì‚¬ì—…ë¶€", position:"ì´ì‚¬" },
  "ê¹€ìˆ˜ì¸": { team:"íˆ¬ì–´íŒ¨ìŠ¤ì‚¬ì—…ë¶€ ì˜ì—… 1íŒ€", position:"íŒ€ì¥" },
  "ê³ ë‹¤í˜„": { team:"íˆ¬ì–´íŒ¨ìŠ¤ì‚¬ì—…ë¶€ ì˜ì—… 1íŒ€", position:"ì‚¬ì›" },
  "ì‹¬ì¬í¬": { team:"íˆ¬ì–´íŒ¨ìŠ¤ì‚¬ì—…ë¶€ ì˜ì—… 1íŒ€", position:"ë§¤ë‹ˆì €" },
  "íŒí‹°ë‹ˆì•ˆ": { team:"íˆ¬ì–´íŒ¨ìŠ¤ì‚¬ì—…ë¶€ ì˜ì—… 1íŒ€", position:"ë§¤ë‹ˆì €" },
  "ê¹€í˜„ì² ": { team:"íˆ¬ì–´íŒ¨ìŠ¤ì‚¬ì—…ë¶€ ì˜ì—… 2íŒ€", position:"íŒ€ì¥" },
  "ì´ìœ ì§„": { team:"íˆ¬ì–´íŒ¨ìŠ¤ì‚¬ì—…ë¶€ ì˜ì—… 2íŒ€", position:"ì‚¬ì›" },
  "ì •ì–´ì§„": { team:"íˆ¬ì–´íŒ¨ìŠ¤ì‚¬ì—…ë¶€ ì˜ì—… 2íŒ€", position:"ì‚¬ì›" },
  "ì¥ì›ì¤€": { team:"íˆ¬ì–´íŒ¨ìŠ¤ì‚¬ì—…ë¶€ ì˜ì—… 2íŒ€", position:"ì‚¬ì›" },
  "ê¹€ëŒ€ì§„": { team:"íˆ¬ì–´íŒ¨ìŠ¤ì‚¬ì—…ë¶€ ì˜ì—… 2íŒ€", position:"íŒ€ì¥" },
  "ì†í˜„ìš°": { team:"íˆ¬ì–´íŒ¨ìŠ¤ì‚¬ì—…ë¶€ ì˜ì—… 2íŒ€", position:"ëŒ€ë¦¬" },
  "ì´ì£¼ì•„": { team:"íˆ¬ì–´íŒ¨ìŠ¤ì‚¬ì—…ë¶€ ì˜ì—… 2íŒ€", position:"ì£¼ì„" },
  "ì¥ì€ì§„": { team:"íˆ¬ì–´íŒ¨ìŠ¤ì‚¬ì—…ë¶€ ì˜ì—… 2íŒ€", position:"ì£¼ì„" },
};
function applyDirectoryToUser(u){
  const dir = DIRECTORY[u.name];
  if (dir){
    u.team = dir.team;
    u.position = dir.position;
  }
  return u;
}

/* =========================
   2) í†µì‹  í—¬í¼
========================= */
async function callGoogleAppsScript(data, method='GET'){
  let url = GAS_WEB_APP_URL;
  const opts = { method };
  if (method==='GET'){ url += '?' + new URLSearchParams(data).toString(); }
  else{
    opts.headers = { 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' };
    opts.body = new URLSearchParams({ payload: JSON.stringify(data) }).toString();
  }
  const res = await fetch(url, opts);
  const text = await res.text();
  let result; try{ result = JSON.parse(text); }catch{ throw new Error('ì„œë²„ ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨'); }
  if (!result.success) throw new Error(result.data?.error || 'ì„œë²„ ì˜¤ë¥˜');
  return result.data;
}

/* =========================
   3) ì—°ê²°/ì´ˆê¸°í™”
========================= */
function updateConnectionStatus(){
  const dot=document.getElementById('connectionDot');
  const text=document.getElementById('connectionText');
  if (isOnline){ dot.className='status-dot status-online'; text.textContent='ì˜¨ë¼ì¸'; }
  else { dot.className='status-dot status-offline'; text.textContent='ì˜¤í”„ë¼ì¸'; }
}
function checkConnection(){
  isOnline = navigator.onLine; updateConnectionStatus();
  window.addEventListener('online', ()=>{ isOnline=true; updateConnectionStatus(); syncData(); });
  window.addEventListener('offline', ()=>{ isOnline=false; updateConnectionStatus(); });
}
async function checkBackendConnection(){ try{ await callGoogleAppsScript({action:'healthCheck'}); return true; }catch{return false;} }
function syncData(){ document.getElementById('lastSync').textContent='ë™ê¸°í™”: '+new Date().toLocaleTimeString(); }

/* =========================
   4) ì„¸ì…˜/ë¡œê·¸ì¸  (ë³€ê²½ë¨)
========================= */
function logout(){
  localStorage.removeItem('tourpassUser'); currentUser=null;
  document.getElementById('userInfo').style.display='none';
  document.getElementById('mainMenu').style.display='none';
  document.getElementById('loginSection').style.display='block';
}

/* ì´ë¦„ + MBTI ë¡œê·¸ì¸ */
async function googleLogin(){
  const btn=document.getElementById('googleLoginBtn');
  try{
    btn.innerHTML='â³ ë¡œê·¸ì¸ ì¤‘...';

    // ì´ë¦„ ì…ë ¥
    let name = prompt('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:');
    if (!name){ btn.innerHTML='<i class="fab fa-google"></i> ì´ë¦„+MBTIë¡œ ë¡œê·¸ì¸'; return; }
    name = name.trim();

    // MBTI ì…ë ¥
    let mbti = prompt('MBTIë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ENTP, INFJ ë“± 4ìë¦¬):');
    if (!mbti){ btn.innerHTML='<i class="fab fa-google"></i> ì´ë¦„+MBTIë¡œ ë¡œê·¸ì¸'; return; }
    mbti = mbti.trim().toUpperCase();

    // MBTI í˜•ì‹ ê²€ì¦
    if (!/^(E|I)(S|N)(T|F)(J|P)$/.test(mbti)){
      alert('MBTI í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. ì˜ˆ: ENFP, ISTJ');
      btn.innerHTML='<i class="fab fa-google"></i> ì´ë¦„+MBTIë¡œ ë¡œê·¸ì¸';
      return;
    }

    // ì´ì „ ë¡œê·¸ì¸ê³¼ ë™ì¼ì„± ê²€ì‚¬ (ì´ë¦„+MBTI ë™ì¼í•´ì•¼ í•¨)
    const savedRaw = localStorage.getItem('tourpassUser');
    if (savedRaw){
      const saved = JSON.parse(savedRaw);
      if (saved && (saved.name !== name || (saved.mbti||'').toUpperCase() !== mbti)){
        alert('ê¸°ì¡´ ë¡œê·¸ì¸ ì •ë³´ì™€ ë¶ˆì¼ì¹˜í•©ë‹ˆë‹¤. ë™ì¼í•œ ì´ë¦„ê³¼ MBTIë¡œë§Œ ë¡œê·¸ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        btn.innerHTML='<i class="fab fa-google"></i> ì´ë¦„+MBTIë¡œ ë¡œê·¸ì¸';
        return;
      }
    }

    // (í˜¸í™˜ìš©) ì„œë²„/ë‹¤ë¥¸ í•¨ìˆ˜ì—ì„œ emailì„ ì°¸ì¡°í•˜ë¯€ë¡œ ê°€ì§œ ì´ë©”ì¼ì„ ìƒì„±
    const pseudoEmail = `${name}+${mbti}@local`;

    // ì‚¬ìš©ì ê°ì²´
    let u = {
      name,
      mbti,
      email: pseudoEmail, // í˜¸í™˜ìš©
      team: 'íˆ¬ì–´íŒ¨ìŠ¤ì‚¬ì—…ë¶€',
      position: 'ì§ì›',
      avatar: name.substring(0,1)
    };

    // ëª…ë‹¨ ë§¤í•‘(ë¶€ì„œ/ì§ê¸‰)
    u = applyDirectoryToUser(u);

    // ì„¸ì…˜ ì €ì¥ ë° í‘œì‹œ
    currentUser = u;
    localStorage.setItem('tourpassUser', JSON.stringify(currentUser));
    showMainApp();
    btn.innerHTML='<i class="fab fa-google"></i> ì´ë¦„+MBTIë¡œ ë¡œê·¸ì¸';
  }catch(err){
    console.error(err); alert('ë¡œê·¸ì¸ ì˜¤ë¥˜: '+(err.message||err));
    btn.innerHTML='<i class="fab fa-google"></i> ì´ë¦„+MBTIë¡œ ë¡œê·¸ì¸';
  }
}

/* ê¸°ì¡´ ì‚¬ìš©ìë¡œ ì´ì–´ì„œ ì ‘ì† */
function checkLoginStatus(){
  const saved = localStorage.getItem('tourpassUser');
  if (saved){
    const u = JSON.parse(saved);
    if (confirm(`${u.name} (MBTI: ${u.mbti||'-'}) ì‚¬ìš©ìë¡œ ì´ì–´ì„œ ì´ìš©í•˜ì‹œê² ì–´ìš”?`)){
      currentUser=u;
      showMainApp();
    }else{
      logout();
    }
  }
}

/* ìƒë‹¨ ì‚¬ìš©ì ì¹´ë“œì— MBTI ë…¸ì¶œ, email ìˆ¨ê¹€ */
function showMainApp(){
  document.getElementById('loginSection').style.display='none';
  document.getElementById('userInfo').style.display='flex';
  document.getElementById('mainMenu').style.display='grid';
  document.getElementById('userName').textContent=currentUser.name;
  document.getElementById('userEmail').textContent='';
  document.getElementById('userDept').textContent = `${currentUser.team||''} ${currentUser.position||''}  ${currentUser.mbti?`| MBTI: ${currentUser.mbti}`:''}`;
  document.getElementById('userAvatar').textContent=currentUser.avatar;
  localStorage.setItem('tourpassUser', JSON.stringify(currentUser));
  setTimeout(updateMBTIButtonState, 60);
  syncData();
}

/* =========================
   5) ëª¨ë‹¬/ë©”ë‰´
========================= */
function activateMenuButton(a){ document.querySelectorAll('.menu-item').forEach(i=>i.classList.remove('active')); const t=document.querySelector(`[data-action="${a}"]`); if (t) t.classList.add('active'); }
function deactivateMenuButton(a){ const t=document.querySelector(`[data-action="${a}"]`); if (t) t.classList.remove('active'); }
function openModal(id){
  const action=id.replace('Modal',''); activateMenuButton(action);
  document.getElementById(id).style.display='block';
  if (id==='participantsModal') renderParticipants();
  if (id==='tourpassBoxModal') updateLinksList();
}
function closeModal(id){ const action=id.replace('Modal',''); deactivateMenuButton(action); document.getElementById(id).style.display='none'; }

/* =========================
   6) ì°¸ê°€ì/ê´€ê³„ë„
========================= */
function renderParticipants(){
  const listEl=document.getElementById('participantsList');
  const arr = JSON.parse(localStorage.getItem('mbtiResults')||'[]');
  const onlyWhitelisted = arr.filter(r=> DIRECTORY[r.name]);
  if (onlyWhitelisted.length===0){
    listEl.innerHTML='<div style="text-align:center;color:#666;padding:20px">í‘œì‹œí•  ì°¸ê°€ì ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return;
  }
  const filled = onlyWhitelisted.map(r=>({...r, team: DIRECTORY[r.name].team, position: DIRECTORY[r.name].position}));
  listEl.innerHTML = filled
    .sort((a,b)=> (a.name||'').localeCompare(b.name||'','ko'))
    .map(p=>`
      <div class="participant-item">
        <div class="participant-avatar">${(p.name||'?').substring(0,1)}</div>
        <div>
          <div><strong>${p.name}</strong> ${p.mbtiType?`<span style="color:#111827">[${p.mbtiType}]</span>`:''}</div>
          <div style="font-size:.8em;color:#666">${p.team} ${p.position}</div>
        </div>
      </div>
    `).join('');
}

function mbtiCompatibility(a,b){
  const perfect = {
    ENFP:['INTJ','INFJ'], ENTP:['INTJ','INFJ'],
    INFP:['ENTJ','ENFJ'], INTP:['ENTJ','ENFJ'],
    ENFJ:['INFP','INTP'], ENTJ:['INFP','INTP'],
    INFJ:['ENFP','ENTP'], INTJ:['ENFP','ENTP'],
    ESFP:['ISTJ','ISFJ'], ESTP:['ISTJ','ISFJ'],
    ISFP:['ESTJ','ESFJ'], ISTP:['ESTJ','ESFJ'],
    ESFJ:['ISFP','ISTP'], ESTJ:['ISFP','ISTP'],
    ISFJ:['ESFP','ESTP'], ISTJ:['ESFP','ESTP'],
  };
  if (perfect[a]?.includes(b)) return {score:96, level:'perfect'};
  let s=70;
  if (a[0]!==b[0]) s+=8; else s+=3;
  if (a[1]===b[1]) s+=10; else s-=5;
  if (a[2]!==b[2]) s+=7; else s+=4;
  if (a[3]!==b[3]) s+=6; else s+=2;
  s = Math.max(55, Math.min(95, s));
  const level = s>=95?'perfect':s>=85?'great':s>=70?'good':s>=60?'okay':'challenging';
  return {score:s, level};
}

function showMBTIRelationship(){
  if (!currentUser || !currentUser.mbti){
    alert('ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ MBTIê°€ í•„ìš”í•©ë‹ˆë‹¤. ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
    return;
  }

  const arr = JSON.parse(localStorage.getItem('mbtiResults')||'[]');
  const others = arr.filter(r=> DIRECTORY[r.name]);

  if (others.length===0){
    alert('ê´€ê³„ë„ë¥¼ í‘œì‹œí•  ì°¸ê°€ì ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }

  const me = { name: currentUser.name, mbtiType: currentUser.mbti };

  const buckets = { perfect:[], great:[], good:[], okay:[], challenging:[] };
  others.forEach(o=>{
    if (!o.mbtiType) return;
    const {score, level} = mbtiCompatibility(me.mbtiType, o.mbtiType);
    buckets[level].push({...o, score, team:DIRECTORY[o.name]?.team, position:DIRECTORY[o.name]?.position});
  });

  const cats = [
    { key:'perfect', title:'í™˜ìƒì˜ ê¶í•©', emoji:'ğŸ’–', color:'#ff4d6d', bg:'#ffe3ea' },
    { key:'great',   title:'ìµœê³ ì˜ íŒŒíŠ¸ë„ˆ', emoji:'ğŸŒŸ', color:'#ff8f1f', bg:'#fff0e0' },
    { key:'good',    title:'ì¢‹ì€ í˜‘ë ¥ì',   emoji:'ğŸ¤', color:'#22c55e', bg:'#eaf7ef' },
    { key:'okay',    title:'í‰ë²”í•œ ê´€ê³„',   emoji:'ğŸ˜Š', color:'#2563eb', bg:'#e8f0fe' },
    { key:'challenging', title:'ì„±ì¥ì˜ ê¸°íšŒ', emoji:'ğŸ’ª', color:'#7c3aed', bg:'#efe7ff' },
  ];

  const html = `
    <div class="modal" id="mbtiRelationshipModal" style="display:block">
      <div class="modal-content" style="width:860px;max-width:96%">
        <button class="close-btn" onclick="closeMBTIRelationship()">&times;</button>
        <div class="modal-header">
          <h3>${me.name}ë‹˜ì˜ MBTI ê´€ê³„ë„</h3>
          <p style="color:#111827;font-weight:800;margin-top:6px">ë‹¹ì‹ ì˜ ìœ í˜•: ${me.mbtiType}</p>
        </div>
        <div style="padding:16px 18px 22px">
          ${cats.map(c=>{
            const list = buckets[c.key];
            if (!list || list.length===0) return '';
            return `
              <div class="rel-cat">
                <div class="rel-head" style="background:${c.color}">
                  <span style="font-size:1.1em">${c.emoji}</span> ${c.title} <span style="opacity:.85;margin-left:6px">(${list.length}ëª…)</span>
                </div>
                <div class="rel-box" style="background:${c.bg}">
                  <div class="rel-grid">
                    ${list.sort((a,b)=> b.score-a.score).map(m=>`
                      <div class="rel-card" style="border-left-color:${c.color}">
                        <div class="rel-row">
                          <div>
                            <strong>${m.name}</strong>
                            <div class="muted">${m.team||''} ${m.position||''}</div>
                          </div>
                          <div class="badge">${m.mbtiType}</div>
                        </div>
                        <div class="muted">ê¶í•©ë„: ${m.score}%</div>
                      </div>
                    `).join('')}
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', html);
}
function closeMBTIRelationship(){ const m=document.getElementById('mbtiRelationshipModal'); if (m) m.remove(); }

/* =========================
   7) ì—¬í–‰ì‹¬ë¦¬í…ŒìŠ¤íŠ¸ (ì œê³µ ëª¨ë“ˆ í˜¸í™˜ ì–´ëŒ‘í„°)
   - ì™¸ë¶€ ê³„ì•½ ìœ ì§€: startMBTITest, updateMBTIQuestion, selectAnswer, nextQuestion, showMBTIResult, closeMBTITest
   - ê¸°ì¡´ ëª¨ë‹¬/ë²„íŠ¼/DOM id ì¬ì‚¬ìš©
   - ë¡œì»¬ ì €ì¥ + GAS ì „ì†¡ ìœ ì§€
========================= */

/* ---- (1) ì§ˆë¬¸/ë¶„ì„/ìš´ì„¸/ìŠ¤íƒ€ì¼/í˜¸í™˜ì„±: ì œê³µ ì½”ë“œ ê·¸ëŒ€ë¡œ ---- */
let psychologyAnswers = []; // ì„ íƒ ê¸°ë¡ (ì „ì—­ currentQuestionëŠ” ìƒë‹¨ì—ì„œ ì´ë¯¸ ì„ ì–¸ë¨! ì¬ì„ ì–¸ ê¸ˆì§€)

const psychologyQuestions = [
  { q:'ì„ í˜¸í•˜ëŠ” íœ´ê°€ ë°©ì‹ì€?', a:[
    { t:'ğŸ–ï¸ í•´ë³€ì—ì„œ ì—¬ìœ ë¡­ê²Œ íœ´ì‹', type:'calm', emoji:'ğŸ–ï¸' },
    { t:'ğŸ”ï¸ ì‚°ê³¼ ìì—° ì†ì—ì„œ ëª¨í—˜', type:'adventure', emoji:'ğŸ”ï¸' },
    { t:'ğŸ›ï¸ ë¬¸í™”ì™€ ì—­ì‚¬ íƒë°©',     type:'culture', emoji:'ğŸ›ï¸' },
    { t:'ğŸ›ï¸ ë„ì‹œì—ì„œ ì‡¼í•‘ê³¼ ë§›ì§‘', type:'city', emoji:'ğŸ›ï¸' }
  ]},
  { q:'ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ë°›ì„ ë•Œ í•´ì†Œ ë°©ë²•ì€?', a:[
    { t:'ğŸµ ìŒì•…ì„ ë“£ê±°ë‚˜ ë…¸ë˜í•˜ê¸°', type:'artistic', emoji:'ğŸµ' },
    { t:'ğŸƒâ€â™€ï¸ ìš´ë™ìœ¼ë¡œ ëª¸ì„ ì›€ì§ì´ê¸°', type:'active',   emoji:'ğŸƒâ€â™€ï¸' },
    { t:'ğŸ‘¥ ì¹œêµ¬ë“¤ê³¼ ìˆ˜ë‹¤ë–¨ê¸°',      type:'social',   emoji:'ğŸ‘¥' },
    { t:'ğŸ“š í˜¼ìë§Œì˜ ì‹œê°„ ê°–ê¸°',     type:'solitary', emoji:'ğŸ“š' }
  ]},
  { q:'ì´ìƒì ì¸ ì£¼ë§ ì €ë…ì€?', a:[
    { t:'ğŸ¿ ì§‘ì—ì„œ ì˜í™”ë‚˜ ë“œë¼ë§ˆ ë³´ê¸°', type:'home',     emoji:'ğŸ¿' },
    { t:'ğŸ» ì¹œêµ¬ë“¤ê³¼ ì™¸ì‹í•˜ë©° ìˆ˜ë‹¤',    type:'social',   emoji:'ğŸ»' },
    { t:'ğŸ¨ ì·¨ë¯¸í™œë™ì´ë‚˜ ìƒˆë¡œìš´ ë°°ì›€',  type:'creative', emoji:'ğŸ¨' },
    { t:'ğŸ›Œ í‘¹ ì‰¬ë©´ì„œ ì—ë„ˆì§€ ì¶©ì „',     type:'rest',     emoji:'ğŸ›Œ' }
  ]},
  { q:'ìƒˆë¡œìš´ ë„ì „ ì•ì—ì„œ ë‚˜ëŠ”?', a:[
    { t:'âš¡ ì¦‰ì‹œ ë„ì „í•˜ê³  ê²½í—˜í•´ë³´ê¸°', type:'impulsive', emoji:'âš¡' },
    { t:'ğŸ“‹ ì‹ ì¤‘í•˜ê²Œ ê³„íš ì„¸ìš°ê³  ì¤€ë¹„', type:'planned',   emoji:'ğŸ“‹' },
    { t:'ğŸ‘‚ ë‹¤ë¥¸ ì‚¬ëŒ ê²½í—˜ë‹´ ë¨¼ì € ë“£ê¸°', type:'cautious',  emoji:'ğŸ‘‚' },
    { t:'ğŸ’­ ì¶©ë¶„íˆ ìƒê°í•œ í›„ ê²°ì •',    type:'thoughtful',emoji:'ğŸ’­' }
  ]},
  { q:'ê°€ì¥ ì¤‘ìš”í•˜ê²Œ ìƒê°í•˜ëŠ” ê°€ì¹˜ëŠ”?', a:[
    { t:'ğŸ’° ì•ˆì •ì ì¸ ê²½ì œì  ê¸°ë°˜',    type:'security',     emoji:'ğŸ’°' },
    { t:'â¤ï¸ ì‚¬ë‘í•˜ëŠ” ì‚¬ëŒë“¤ê³¼ì˜ ê´€ê³„', type:'relationship', emoji:'â¤ï¸' },
    { t:'ğŸ† ê°œì¸ì  ì„±ì·¨ì™€ ì„±ê³µ',      type:'achievement',  emoji:'ğŸ†' },
    { t:'ğŸŒŸ ììœ ë¡œìš´ ì‚¶ê³¼ ê°œì„±',      type:'freedom',      emoji:'ğŸŒŸ' }
  ]},
  { q:'íŒ€ í”„ë¡œì íŠ¸ì—ì„œ ë‚´ ì—­í• ì€?', a:[
    { t:'ğŸ¯ ëª©í‘œ ì„¤ì •í•˜ê³  ë°©í–¥ ì œì‹œ', type:'leader',  emoji:'ğŸ¯' },
    { t:'ğŸ” ìë£Œ ì¡°ì‚¬í•˜ê³  ë¶„ì„í•˜ê¸°',  type:'analyst', emoji:'ğŸ”' },
    { t:'ğŸ¤ íŒ€ì›ë“¤ ì¡°ìœ¨í•˜ê³  ì†Œí†µ',    type:'mediator',emoji:'ğŸ¤' },
    { t:'âœ¨ ì°½ì˜ì  ì•„ì´ë””ì–´ ì œê³µ',    type:'creative',emoji:'âœ¨' }
  ]},
  { q:'í–‰ìš´ì´ ì°¾ì•„ì˜¬ ê²ƒ ê°™ì€ ë•ŒëŠ”?', a:[
    { t:'ğŸŒ… ìƒˆë¡œìš´ ì‹œì‘ì„ í•  ë•Œ', type:'beginning', emoji:'ğŸŒ…' },
    { t:'ğŸ¤² ë‚¨ì„ ë„ì™€ì¤„ ë•Œ',     type:'helping',   emoji:'ğŸ¤²' },
    { t:'ğŸ’ª ì—´ì‹¬íˆ ë…¸ë ¥í•  ë•Œ',   type:'effort',    emoji:'ğŸ’ª' },
    { t:'ğŸ˜Š ë§ˆìŒì´ í‰ì˜¨í•  ë•Œ',   type:'peace',     emoji:'ğŸ˜Š' }
  ]}
];

function analyzePsychologyType(answers){
  const typeCount={};
  answers.forEach(a=>{ typeCount[a.type]=(typeCount[a.type]||0)+1; });
  const top = Object.entries(typeCount).sort((a,b)=>b[1]-a[1])[0]?.[0];
  const map={
    calm:{ name:'ğŸ¨ ì½”ì•Œë¼í˜•', desc:'í‰ì˜¨í•˜ê³  ì—¬ìœ ë¡œìš´' },
    adventure:{ name:'ğŸ¦… ë…ìˆ˜ë¦¬í˜•', desc:'ëª¨í—˜ì„ ì¦ê¸°ëŠ”' },
    culture:{ name:'ğŸ¦‰ ì˜¬ë¹¼ë¯¸í˜•', desc:'ì§€í˜œë¡­ê³  íƒêµ¬í•˜ëŠ”' },
    city:{ name:'ğŸ¿ï¸ ë‹¤ëŒì¥í˜•', desc:'í™œë°œí•˜ê³  ë°”ìœ' },
    artistic:{ name:'ğŸ¦‹ ë‚˜ë¹„í˜•', desc:'ì•„ë¦„ë‹¤ì›€ì„ ì¶”êµ¬í•˜ëŠ”' },
    active:{ name:'ğŸ ë§í˜•', desc:'ì—ë„ˆì§€ ë„˜ì¹˜ëŠ”' },
    social:{ name:'ğŸ¬ ëŒê³ ë˜í˜•', desc:'ì‚¬êµì ì´ê³  ì¹œê·¼í•œ' },
    solitary:{ name:'ğŸº ëŠ‘ëŒ€í˜•', desc:'ë…ë¦½ì ì´ê³  ê°•ì¸í•œ' },
    home:{ name:'ğŸ» ê³°í˜•', desc:'ì•ˆì •ì„ ì¶”êµ¬í•˜ëŠ”' },
    creative:{ name:'ğŸ¦Š ì—¬ìš°í˜•', desc:'ì°½ì˜ì ì´ê³  ì˜ë¦¬í•œ' },
    rest:{ name:'ğŸ¼ íŒë‹¤í˜•', desc:'ì—¬ìœ ë¡­ê³  í‰í™”ë¡œìš´' },
    impulsive:{ name:'ğŸ… í˜¸ë‘ì´í˜•', desc:'ì§ê°ì ì´ê³  ìš©ë§¹í•œ' },
    planned:{ name:'ğŸ˜ ì½”ë¼ë¦¬í˜•', desc:'ì‹ ì¤‘í•˜ê³  ê³„íšì ì¸' },
    cautious:{ name:'ğŸ¢ ê±°ë¶ì´í˜•', desc:'ì‹ ì¤‘í•˜ê³  ê¾¸ì¤€í•œ' },
    thoughtful:{ name:'ğŸ¦Œ ì‚¬ìŠ´í˜•', desc:'ì‚¬ìƒ‰ì ì´ê³  ìš°ì•„í•œ' },
    security:{ name:'ğŸƒ í™©ì†Œí˜•', desc:'ì•ˆì •ê³¼ í˜„ì‹¤ì„ ì¤‘ì‹œí•˜ëŠ”' },
    relationship:{ name:'ğŸ° í† ë¼í˜•', desc:'ê°ì •ì´ í’ë¶€í•˜ê³  ë”°ëœ»í•œ' },
    achievement:{ name:'ğŸ¦ ì‚¬ìí˜•', desc:'ì„±ì·¨ìš•ì´ ê°•í•œ' },
    freedom:{ name:'ğŸ¦ ìƒˆí˜•', desc:'ììœ ë¡œìš´ ì˜í˜¼ì˜' },
    leader:{ name:'ğŸ¦ˆ ìƒì–´í˜•', desc:'ë¦¬ë”ì‹­ ìˆëŠ”' },
    analyst:{ name:'ğŸ™ ë¬¸ì–´í˜•', desc:'ë¶„ì„ì ì´ê³  ë‹¤ì¬ë‹¤ëŠ¥í•œ' },
    mediator:{ name:'ğŸ³ ê³ ë˜í˜•', desc:'ì¡°í™”ë¥¼ ì´ë£¨ëŠ”' },
    beginning:{ name:'ğŸ£ ë³‘ì•„ë¦¬í˜•', desc:'ìƒˆë¡œìš´ ì‹œì‘ì„ ì¢‹ì•„í•˜ëŠ”' },
    helping:{ name:'ğŸ• ê°œí˜•', desc:'ì¶©ì„±ìŠ¤ëŸ½ê³  ë„ì›€ì„ ì£¼ëŠ”' },
    effort:{ name:'ğŸœ ê°œë¯¸í˜•', desc:'ë¶€ì§€ëŸ°í•˜ê³  ë…¸ë ¥í•˜ëŠ”' },
    peace:{ name:'ğŸ•Šï¸ ë¹„ë‘˜ê¸°í˜•', desc:'í‰í™”ë¡œìš´' }
  };
  return map[top] || { name:'ğŸ¦„ ìœ ë‹ˆì½˜í˜•', desc:'íŠ¹ë³„í•˜ê³  ì‹ ë¹„ë¡œìš´' };
}

function generateFortune(psychologyTypeName, name){
  const fortunes={
    'ğŸ¨ ì½”ì•Œë¼í˜•':{ today:'ğŸŒ¿ ì˜¤ëŠ˜ì€ ë§ˆìŒì˜ í‰í™”ë¥¼â€¦', lucky:'ğŸŸ¢ ì´ˆë¡ìƒ‰', number:'7ï¸âƒ£', advice:'ì²œì²œíˆ í•œ ê±¸ìŒì”©â€¦' },
    'ğŸ¦… ë…ìˆ˜ë¦¬í˜•':{ today:'âš¡ ìƒˆë¡œìš´ ë„ì „ì´â€¦', lucky:'ğŸŸ  ì£¼í™©ìƒ‰', number:'3ï¸âƒ£', advice:'ì§ê°ì„ ë¯¿ê³ â€¦' },
    'ğŸ¦‰ ì˜¬ë¹¼ë¯¸í˜•':{ today:'ğŸ“š ì§€ì  í˜¸ê¸°ì‹¬ì´â€¦', lucky:'ğŸŸ£ ë³´ë¼ìƒ‰', number:'9ï¸âƒ£', advice:'ì—­ì‚¬ ì†ì—ì„œ ì§€í˜œë¥¼â€¦' },
    'ğŸ¿ï¸ ë‹¤ëŒì¥í˜•':{ today:'ğŸ’¨ ì—ë„ˆì§€ê°€ ë„˜ì¹˜ëŠ”â€¦', lucky:'ğŸ”´ ë¹¨ê°„ìƒ‰', number:'5ï¸âƒ£', advice:'íŒ€ì›Œí¬ê°€ ì¤‘ìš”â€¦' },
    'ğŸ¦‹ ë‚˜ë¹„í˜•':{ today:'ğŸ¨ ì°½ì¡°ì  ì˜ê°ì´â€¦', lucky:'ğŸ©· ë¶„í™ìƒ‰', number:'2ï¸âƒ£', advice:'ì•„ë¦„ë‹¤ì›€ì— ì‹œê°„ì„â€¦' },
    'ğŸ ë§í˜•':{ today:'ğŸƒâ€â™€ï¸ í™œë ¥ì´ ì¶©ë§Œâ€¦', lucky:'ğŸŸ¢ ì´ˆë¡ìƒ‰', number:'8ï¸âƒ£', advice:'ë°±ë§ˆê°• ì‚°ì±…â€¦' },
    'ğŸ¬ ëŒê³ ë˜í˜•':{ today:'ğŸ‘« ì¸ê°„ê´€ê³„ ì¢‹ì€ ì†Œì‹â€¦', lucky:'ğŸŸ¡ ë…¸ë€ìƒ‰', number:'6ï¸âƒ£', advice:'ì§„ì‹¬ìœ¼ë¡œ ë‹¤ê°€ê°€ë©´â€¦' },
    'ğŸº ëŠ‘ëŒ€í˜•':{ today:'ğŸŒ™ í˜¼ìë§Œì˜ ì‹œê°„ì´â€¦', lucky:'âšª í°ìƒ‰', number:'1ï¸âƒ£', advice:'ê³ ë€ì‚¬ ëª…ìƒâ€¦' }
  };
  return fortunes[psychologyTypeName] || { today:'ğŸŒŸ íŠ¹ë³„í•œ í•˜ë£¨', lucky:'ğŸŒˆ ë¬´ì§€ê°œìƒ‰', number:'0ï¸âƒ£', advice:'ìì‹ ë§Œì˜ ê¸¸' };
}

function getTravelStyle(psychologyTypeName){
  const styles={
    'ğŸ¨ ì½”ì•Œë¼í˜•':{ style:'íë§ ì—¬í–‰ëŸ¬', preference:'ìì—° ì† íœ´ì–‘', destinations:['ì œì£¼ ìˆ²ê¸¸','ê°•ì› íœì…˜','ì˜¨ì²œ ë¦¬ì¡°íŠ¸','í•œì í•œ í•´ë³€'], activities:['ì‚°ì±…','ë…ì„œ','ì˜¨ì²œ','ìš”ê°€','ëª…ìƒ'], accommodation:'ì¡°ìš©í•œ íœì…˜/ë¦¬ì¡°íŠ¸', planning:'ì—¬ìœ  ì¼ì •', companion:'ê°€ì¡±/ì—°ì¸ ì†Œê·œëª¨', motto:'ì—¬í–‰ì€ ë§ˆìŒì˜ ì¬ì¶©ì „' },
    'ğŸ¦… ë…ìˆ˜ë¦¬í˜•':{ style:'ì–´ë“œë²¤ì²˜ ì—¬í–‰ëŸ¬', preference:'ìŠ¤ë¦´/ë„ì „', destinations:['íˆë§ë¼ì•¼','ë‰´ì§ˆëœë“œ','ì‚¬íŒŒë¦¬','ì•Œë˜ìŠ¤ì¹´'], activities:['ë“±ì‚°','ìŠ¤ì¹´ì´ë‹¤ì´ë¹™','ë˜í”„íŒ…','ì•”ë²½','íŒ¨ëŸ¬'], accommodation:'ìº í•‘/ì‚°ì¥', planning:'ë„ì „ ëª©í‘œ+ì•ˆì „', companion:'ëª¨í—˜ ë™ë£Œ', motto:'í•œê³„ë¥¼ ë›°ì–´ë„˜ëŠ” ë„ì „' },
    'ğŸ¦‰ ì˜¬ë¹¼ë¯¸í˜•':{ style:'ë¬¸í™”íƒë°© ì—¬í–‰ëŸ¬', preference:'ì—­ì‚¬/ë¬¸í™” íƒêµ¬', destinations:['ìœ ëŸ½ ë°•ë¬¼ê´€','êµí† ','ì´ì§‘íŠ¸','ê·¸ë¦¬ìŠ¤'], activities:['ë°•ë¬¼ê´€','ìœ ì ','ê³µë¶€','ê³µì˜ˆ'], accommodation:'ì „í†µ/ì—­ì‚¬ í˜¸í…”', planning:'ì‚¬ì „ ì¡°ì‚¬Â·ì„¸ë°€ ì¼ì •', companion:'ì§€ì  í˜¸ê¸°ì‹¬ ì†Œìˆ˜', motto:'ì‚´ì•„ìˆëŠ” ì—­ì‚¬ì±…' },
    'ğŸ¿ï¸ ë‹¤ëŒì¥í˜•':{ style:'ë„ì‹œíƒí—˜ ì—¬í–‰ëŸ¬', preference:'ë„ì‹œ ì´ì²´ ì²´í—˜', destinations:['ë‰´ìš•','ë„ì¿„','ëŸ°ë˜','íŒŒë¦¬'], activities:['ì‡¼í•‘','ë§›ì§‘','í´ëŸ½/ë°”','ë®¤ì§€ì»¬','ì‹œì¥'], accommodation:'ì‹œë‚´ ì¤‘ì‹¬ í˜¸í…”', planning:'ë¹¡ë¹¡í•œ ì¼ì •', companion:'ì—ë„ˆì§€ ë„˜ì¹˜ëŠ” ì¹œêµ¬', motto:'ë„ì‹œ ë§¤ë ¥ í¡ìˆ˜' }
  };
  return styles[psychologyTypeName] || { style:'ììœ ë¡œìš´ ì—¬í–‰ëŸ¬', preference:'ë‹¤ì–‘í•œ ìŠ¤íƒ€ì¼ ì‹œë„', destinations:['ì–´ë””ë“ ì§€'], activities:['ìƒˆë¡œìš´ ê²½í—˜'], accommodation:'ìƒí™© ë§ì¶¤', planning:'ìœ ì—° ê³„íš', companion:'ëˆ„êµ¬ë“ ì§€', motto:'ìƒˆë¡œìš´ ë‚˜ë¥¼ ë°œê²¬' };
}

function travelPartnerCompatibility(a,b){
  const map={
    'ğŸ¨ ì½”ì•Œë¼í˜•':{ perfect:['ğŸ¦Œ ì‚¬ìŠ´í˜•','ğŸ³ ê³ ë˜í˜•','ğŸ•Šï¸ ë¹„ë‘˜ê¸°í˜•'], challenging:['ğŸ¦… ë…ìˆ˜ë¦¬í˜•','ğŸ¿ï¸ ë‹¤ëŒì¥í˜•','ğŸ¦ˆ ìƒì–´í˜•'] },
    'ğŸ¦… ë…ìˆ˜ë¦¬í˜•':{ perfect:['ğŸ… í˜¸ë‘ì´í˜•','ğŸ ë§í˜•','ğŸ¦ˆ ìƒì–´í˜•'], challenging:['ğŸ¨ ì½”ì•Œë¼í˜•','ğŸ» ê³°í˜•','ğŸ¼ íŒë‹¤í˜•'] },
    'ğŸ¦‰ ì˜¬ë¹¼ë¯¸í˜•':{ perfect:['ğŸ™ ë¬¸ì–´í˜•','ğŸ¦Š ì—¬ìš°í˜•','ğŸ¦Œ ì‚¬ìŠ´í˜•'], challenging:['ğŸ¬ ëŒê³ ë˜í˜•','ğŸ¿ï¸ ë‹¤ëŒì¥í˜•','ğŸ£ ë³‘ì•„ë¦¬í˜•'] },
    'ğŸ¿ï¸ ë‹¤ëŒì¥í˜•':{ perfect:['ğŸ¬ ëŒê³ ë˜í˜•','ğŸ¦‹ ë‚˜ë¹„í˜•','ğŸ¦Š ì—¬ìš°í˜•'], challenging:['ğŸ¨ ì½”ì•Œë¼í˜•','ğŸº ëŠ‘ëŒ€í˜•','ğŸ¦‰ ì˜¬ë¹¼ë¯¸í˜•'] }
  };
  const prof=map[a]||{perfect:[],challenging:[]};
  if (prof.perfect.includes(b)) return {score:95, level:'perfect'};
  if (prof.challenging.includes(b)) return {score:45, level:'challenging'};
  let s=70; if(a===b) s+=15; else s+=Math.floor(Math.random()*15)+5;
  const level = s>=90?'perfect':s>=80?'great':s>=70?'good':s>=50?'okay':'challenging';
  return {score:s, level};
}

function getCompleteResult(answers, userName){
  const type = analyzePsychologyType(answers);
  const fortune = generateFortune(type.name, userName);
  const travel = getTravelStyle(type.name);
  return {
    user:userName, type, fortune, travel,
    compatibility:(otherType)=> travelPartnerCompatibility(type.name, otherType)
  };
}

/* ---- (2) ì•± ê³„ì•½ ì–´ëŒ‘í„°: ê¸°ì¡´ í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜/DOM ë§ì¶¤ ---- */
function startMBTITest(){
  // ê¸°ì¡´ íë¦„ ìœ ì§€: ëª¨ë‹¬ ì˜¤í”ˆ + ìƒíƒœ ì´ˆê¸°í™”
  window.travelTestStart = Date.now();
  currentQuestion = 0;               // ìƒë‹¨ ì „ì—­ ì‚¬ìš© (ì¬ì„ ì–¸ ê¸ˆì§€)
  psychologyAnswers = [];
  updateMBTIQuestion();
  openModal('mbtiModal');            // ê¸°ì¡´ ëª¨ë‹¬ ì¬ì‚¬ìš©
}

function updateMBTIQuestion(){
  if (currentQuestion >= psychologyQuestions.length){ showMBTIResult(); return; }
  const q = psychologyQuestions[currentQuestion];

  // ìƒë‹¨ ì§„í–‰ë°”/ë¬¸í•­ í…ìŠ¤íŠ¸
  document.getElementById('questionNumber').textContent = `ì§ˆë¬¸ ${currentQuestion+1}/${psychologyQuestions.length}`;
  document.getElementById('questionText').textContent = q.q;

  // ë³´ê¸° ë²„íŠ¼ ë Œë”ë§
  const box = document.getElementById('answerOptions');
  box.innerHTML = '';
  q.a.forEach((opt,i)=>{
    const btn = document.createElement('button');
    btn.className = 'answer-btn';
    btn.textContent = opt.t;
    btn.onclick = ()=> selectAnswer(i);
    box.appendChild(btn);
  });

  // ì§„í–‰ë°”/ë‹¤ìŒë²„íŠ¼
  document.getElementById('progressBar').style.width = (currentQuestion/psychologyQuestions.length*100)+'%';
  document.getElementById('nextBtn').style.display='none';
}

function selectAnswer(answerIndex){
  // ë²„íŠ¼ ìŠ¤íƒ€ì¼ í† ê¸€
  document.querySelectorAll('.answer-btn').forEach(b=>b.classList.remove('selected'));
  const selected = document.querySelectorAll('.answer-btn')[answerIndex];
  if (selected) selected.classList.add('selected');

  // ì„ íƒ ì €ì¥
  psychologyAnswers[currentQuestion] = psychologyQuestions[currentQuestion].a[answerIndex];

  // ë‹¤ìŒ ë²„íŠ¼ ë…¸ì¶œ
  document.getElementById('nextBtn').style.display='inline-block';
}

function nextQuestion(){
  currentQuestion++;
  updateMBTIQuestion();
}

async function showMBTIResult(){
  // ê²°ê³¼ ê³„ì‚°
  const result = getCompleteResult(psychologyAnswers, (currentUser?.name||'ì‚¬ìš©ì'));
  const durationSec = Math.floor((Date.now()-(window.travelTestStart||Date.now()))/1000);

  // ë¡œì»¬ ì €ì¥ (email ê¸°ì¤€ ë‹¨ê±´ ê°±ì‹ )
  try{
    const arr = JSON.parse(localStorage.getItem('travelTestResults')||'[]')
      .filter(r=> !currentUser || r.email !== (currentUser.email||''));
    arr.push({
      name: currentUser?.name || 'ì‚¬ìš©ì',
      email: currentUser?.email || '',
      personaName: result.type.name,
      personaDesc: result.type.desc,
      fortune: result.fortune,
      travel: result.travel,
      answers: psychologyAnswers,
      timestamp: new Date().toISOString(),
      team: currentUser?.team, position: currentUser?.position
    });
    localStorage.setItem('travelTestResults', JSON.stringify(arr));
  }catch(_){}

  // ì„œë²„ ì „ì†¡ (ê¸°ì¡´ ì•¡ì…˜ ê·¸ëŒ€ë¡œ, ì¶”ê°€ í•„ë“œë§Œ ë§ë¶™ì„ â†’ ë°±ì—”ë“œ ë¬´ê´€)
  try{
    await callGoogleAppsScript({
      action:'saveMBTIResult',
      name: currentUser?.name || 'ì‚¬ìš©ì',
      email: currentUser?.email || '',
      mbtiType: currentUser?.mbti || '',
      travelPersona: { name: result.type.name, desc: result.type.desc },
      travelStyle: result.travel,
      travelFortune: result.fortune,
      testDuration: durationSec,
      testKind: 'travel-animal'
    }, 'POST');
  }catch(_){}

  // ê²°ê³¼ ëª¨ë‹¬ í‘œì‹œ
  openTravelResultModal(result.type, result.travel, result.fortune, durationSec);

  // ê¸°ì¡´ íë¦„ê³¼ ë™ì¼í•˜ê²Œ í…ŒìŠ¤íŠ¸ ëª¨ë‹¬ ë‹«ê¸°
  closeMBTITest();
}

/* ê²°ê³¼ ëª¨ë‹¬ (ì´ ë¸”ë¡ì— í•¨ê»˜ í¬í•¨) */
function openTravelResultModal(type, travel, fortune, sec){
  const wrap = (label,val)=>`<div style="margin:6px 0"><strong>${label}</strong> <div style="margin-top:4px;color:#333">${val}</div></div>`;
  const list = (title, arr)=>`${wrap(title, Array.isArray(arr)?arr.join(' Â· '):arr)}`;

  const html = `
    <div class="modal" id="travelResultModal" style="display:block">
      <div class="modal-content" style="width:760px;max-width:96%">
        <button class="close-btn" onclick="closeTravelResultModal()">&times;</button>
        <div class="modal-header">
<script>
// ===== ì—¬í–‰ì‹¬ë¦¬í…ŒìŠ¤íŠ¸ ê²°ê³¼ ëª¨ë‹¬ (ìƒˆ UI + ê¶í•©ë„) =====
const ALL_ANIMAL_TYPES = [
  'ğŸ¨ ì½”ì•Œë¼í˜•','ğŸ¦… ë…ìˆ˜ë¦¬í˜•','ğŸ¦‰ ì˜¬ë¹¼ë¯¸í˜•','ğŸ¿ï¸ ë‹¤ëŒì¥í˜•','ğŸ¦‹ ë‚˜ë¹„í˜•','ğŸ ë§í˜•',
  'ğŸ¬ ëŒê³ ë˜í˜•','ğŸº ëŠ‘ëŒ€í˜•','ğŸ» ê³°í˜•','ğŸ¦Š ì—¬ìš°í˜•','ğŸ¼ íŒë‹¤í˜•','ğŸ… í˜¸ë‘ì´í˜•',
  'ğŸ˜ ì½”ë¼ë¦¬í˜•','ğŸ¢ ê±°ë¶ì´í˜•','ğŸ¦Œ ì‚¬ìŠ´í˜•','ğŸƒ í™©ì†Œí˜•','ğŸ° í† ë¼í˜•','ğŸ¦ ì‚¬ìí˜•',
  'ğŸ¦ ìƒˆí˜•','ğŸ¦ˆ ìƒì–´í˜•','ğŸ™ ë¬¸ì–´í˜•','ğŸ³ ê³ ë˜í˜•','ğŸ£ ë³‘ì•„ë¦¬í˜•','ğŸ• ê°œí˜•','ğŸœ ê°œë¯¸í˜•','ğŸ•Šï¸ ë¹„ë‘˜ê¸°í˜•'
];

function getCompatibilityBuckets(selfType){
  const buckets = { perfect:[], great:[], good:[], okay:[], challenging:[] };
  ALL_ANIMAL_TYPES.forEach(t=>{
    if (t===selfType) return;
    const {score, level} = travelPartnerCompatibility(selfType, t);
    buckets[level].push({ name:t, score });
  });
  Object.keys(buckets).forEach(k=> buckets[k].sort((a,b)=>b.score-a.score));
  return buckets;
}
const levelClass = (l)=>({perfect:'lv-perfect',great:'lv-great',good:'lv-good',okay:'lv-okay',challenging:'lv-challenging'}[l]||'lv-good');
const levelColor = (l)=>({perfect:'#ff4d6d',great:'#ff8f1f',good:'#22c55e',okay:'#2563eb',challenging:'#7c3aed'}[l]||'#22c55e');
const levelCopy  = (l)=>({perfect:'ì°°ë–¡ê¶í•©! ì‹œë„ˆì§€ê°€ í­ë°œí•´ìš”',great:'ì•„ì£¼ ì˜ ë§ì•„ìš”. í•¨ê»˜í•˜ë©´ ë“ ë“ !',good:'ë¬´ë‚œí•˜ê²Œ ì˜ ë§ëŠ” í¸',okay:'ì„œë¡œ ë°°ë ¤í•˜ë©´ ì¶©ë¶„íˆ ì¢‹ì•„ìš”',challenging:'ê´€ì  ì°¨ì´ê°€ ì»¤ìš”. ì—­í• /ì†ë„ ì¡°ìœ¨ í•„ìˆ˜'}[l]||'');

function openTravelResultModal(type, travel, fortune, sec){
  const emoji = (type.name||'').split(' ')[0] || 'ğŸ§­';
  const selfType = type.name;
  const buckets = getCompatibilityBuckets(selfType);
  const defaultPartner = (buckets.perfect[0]?.name) || 'ğŸ¦‰ ì˜¬ë¹¼ë¯¸í˜•';
  const modalId = 'travelResultModal';
  const chip = (label)=>`<span class="chip" onclick="document.getElementById('compSelect').value='${label}'; updateCompatibilityView('${selfType}')">${label}</span>`;
  const chips = (arr, max=6)=> arr.slice(0,max).map(x=>chip(x.name||x)).join('') || '<span style="color:#666">-</span>';

  const html = `
    <div class="modal" id="${modalId}" style="display:block">
      <div class="modal-content" style="width:820px;max-width:96%">
        <button class="close-btn" onclick="closeTravelResultModal()">&times;</button>

        <div class="result-wrap" style="padding:16px 18px 22px">
          <div class="result-head">
            <div class="result-emoji">${emoji}</div>
            <div style="flex:1;min-width:0">
              <div class="result-title">${type.name}</div>
              <div class="result-desc">${type.desc||''}</div>
            </div>
            <span class="pill"><span>ì—¬í–‰ ìŠ¤íƒ€ì¼</span><span>Â·</span><span>${travel.style||'-'}</span></span>
          </div>

          <div style="color:#666;margin:-4px 0 12px">ì†Œìš”ì‹œê°„: ${sec}ì´ˆ</div>

          <div class="grid-2">
            <div class="card">
              <div style="font-weight:800;margin-bottom:6px">ì—¬í–‰ ìŠ¤íƒ€ì¼</div>
              <div class="kv"><strong>ì„ í˜¸</strong><div>${travel.preference||'-'}</div></div>
              <div class="kv"><strong>ëª©ì ì§€</strong><div class="chips">${(travel.destinations||[]).map(d=>`<span class="chip">${d}</span>`).join('')}</div></div>
              <div class="kv"><strong>í™œë™</strong><div class="chips">${(travel.activities||[]).map(d=>`<span class="chip">${d}</span>`).join('')}</div></div>
              <div class="grid-2" style="gap:10px;margin-top:6px">
                <div class="kv"><strong>ìˆ™ì†Œ</strong><div>${travel.accommodation||'-'}</div></div>
                <div class="kv"><strong>ë™í–‰</strong><div>${travel.companion||'-'}</div></div>
              </div>
              <div class="kv"><strong>ê¸°íš</strong><div>${travel.planning||'-'}</div></div>
              <div class="kv"><strong>ëª¨í† </strong><div>â€œ${travel.motto||'-'}â€</div></div>
            </div>

            <div class="card">
              <div style="font-weight:800;margin-bottom:6px">ì˜¤ëŠ˜ì˜ ìš´ì„¸ (ë¶€ì—¬ ì—ë””ì…˜)</div>
              <div class="kv"><strong>ë©”ì‹œì§€</strong><div>${fortune.today}</div></div>
              <div class="grid-2" style="gap:10px;margin-top:6px">
                <div class="kv"><strong>ëŸ­í‚¤ ì»¬ëŸ¬</strong><div>${fortune.lucky}</div></div>
                <div class="kv"><strong>ëŸ­í‚¤ ë„˜ë²„</strong><div>${fortune.number}</div></div>
              </div>
              <div class="kv"><strong>ì¡°ì–¸</strong><div>${fortune.advice}</div></div>
            </div>
          </div>

          <div class="card" style="margin-top:12px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div style="font-weight:800">ì—¬í–‰ íŒŒíŠ¸ë„ˆ ê¶í•©ë„</div>
              <div>
                <select id="compSelect" style="padding:8px 10px;border-radius:10px;border:1px solid #ddd">
                  ${ALL_ANIMAL_TYPES.map(t=>`<option value="${t}" ${t===defaultPartner?'selected':''}>${t}</option>`).join('')}
                </select>
              </div>
            </div>
            <div id="compMeterBox" style="margin-top:6px"></div>
            <div class="sep"></div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
              <div>
                <div class="level-badge lv-perfect">ì°°ë–¡ ê¶í•©</div>
                <div class="chips" style="margin-top:8px">${chips(buckets.perfect)}</div>
              </div>
              <div>
                <div class="level-badge lv-challenging">ì£¼ì˜ í•„ìš”</div>
                <div class="chips" style="margin-top:8px">${chips(buckets.challenging)}</div>
              </div>
            </div>
          </div>

          <div style="margin-top:14px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="sync-btn" onclick="navigator.clipboard.writeText('[ì—¬í–‰ì‹¬ë¦¬í…ŒìŠ¤íŠ¸] ${type.name} | ${travel.style||''}')">ê²°ê³¼ ë³µì‚¬</button>
            <button class="sync-btn" style="background:#111827" onclick="closeTravelResultModal()">ë‹«ê¸°</button>
          </div>
        </div>
      </div>
    </div>`;
  document.body.insertAdjacentHTML('beforeend', html);
  updateCompatibilityView(selfType);
}

function updateCompatibilityView(selfType){
  const partner = document.getElementById('compSelect').value;
  const box = document.getElementById('compMeterBox');
  const {score, level} = travelPartnerCompatibility(selfType, partner);
  box.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <div style="font-weight:800">${partner}</div>
      <div class="level-badge ${levelClass(level)}">${level.toUpperCase()} Â· ${score}%</div>
    </div>
    <div class="meter"><div class="meter-fill" style="background:${levelColor(level)};width:${score}%"></div></div>
    <div class="note">${levelCopy(level)}</div>`;
}

function closeTravelResultModal(){ const m=document.getElementById('travelResultModal'); if (m) m.remove(); }
</script>

/* =========================
   8) ì„¤ë¬¸
========================= */
async function submitWorkshopSurvey(){
  const satisfaction=document.getElementById('satisfaction').value;
  const bestActivity=document.getElementById('bestActivity').value;
  const feedback=document.getElementById('feedback').value;
  if (!bestActivity){ alert('ê°€ì¥ ë§Œì¡±í–ˆë˜ í™œë™ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
  try{
    await callGoogleAppsScript({action:'saveSurvey',name:currentUser.name,email:currentUser.email,satisfaction:parseInt(satisfaction,10),feedback,answers:{bestActivity,satisfactionLevel:satisfaction}},'POST');
    alert('ì„¤ë¬¸ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤!');
  }catch(e){ alert('ì„¤ë¬¸ ì €ì¥ ì‹¤íŒ¨: '+(e.message||e)); }
  closeModal('surveyModal');
}

/* =========================
   9) ì¼ì •
========================= */
function openScheduleOptions(){
  activateMenuButton('schedule');
  const html=`
    <div class="modal" id="scheduleOptionsModal" style="display:block">
      <div class="modal-content" style="width:440px">
        <button class="close-btn" onclick="closeScheduleOptions()">&times;</button>
        <div class="modal-header"><h3>ì›Œí¬ìƒµ ì¼ì • ì„ íƒ</h3></div>
        <div style="padding:16px">
          <div onclick="openScheduleLink('phase1')" style="display:flex;gap:12px;align-items:center;padding:12px;border:1px solid #eee;border-radius:12px;margin-bottom:12px;cursor:pointer">
            <i class="fas fa-graduation-cap" style="color:#2ecc71;font-size:1.2em"></i><div><div style="font-weight:800">1ì°¨ ì—­ëŸ‰ê°•í™” ì›Œí¬ìƒµ</div></div>
          </div>
          <div onclick="openScheduleLink('phase2')" style="display:flex;gap:12px;align-items:center;padding:12px;border:1px solid #eee;border-radius:12px;margin-bottom:12px;cursor:pointer">
            <i class="fas fa-users" style="color:#111827;font-size:1.2em"></i><div><div style="font-weight:800">2ì°¨ ì†Œí†µê°•í™” ì›Œí¬ìƒµ(ìƒì„¸)</div></div>
          </div>
          <div onclick="openScheduleLink('phase3')" style="display:flex;gap:12px;align-items:center;padding:12px;border:1px solid #eee;border-radius:12px;cursor:pointer">
            <i class="fas fa-rocket" style="color:#ff8f1f;font-size:1.2em"></i><div><div style="font-weight:800">3ì°¨ ì„œë°‹/ì—‘ìŠ¤í¬ ì„¸ë¯¸ë‚˜</div></div>
          </div>
        </div>
      </div>
    </div>`;
  document.body.insertAdjacentHTML('beforeend', html);
}
function closeScheduleOptions(){ const m=document.getElementById('scheduleOptionsModal'); if (m) m.remove(); deactivateMenuButton('schedule'); }
function openScheduleLink(phase){
  const links={ phase1:'https://form.naver.com/response/ktPwJoHoW2VFRo8AUa6yrg', phase2:'detailed', phase3:'https://www.aisummit.co.kr/' };
  if (phase==='phase2') showDetailedSchedule();
  else if (links[phase]) window.open(links[phase],'_blank'); else alert('ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.');
  closeScheduleOptions();
}
function showDetailedSchedule(){
  const html=`
    <div class="modal" id="detailedScheduleModal" style="display:block">
      <div class="modal-content" style="width:760px;max-width:96%">
        <button class="close-btn" onclick="closeDetailedSchedule()">&times;</button>
        <div class="modal-header"><h3>2ì°¨ ì†Œí†µê°•í™” ì›Œí¬ìƒµ ìƒì„¸ì¼ì •</h3></div>
        <div style="padding:16px 18px 22px">
          <div style="margin-bottom:16px;background:#f7f7fb;border:1px solid #eee;border-radius:12px;padding:12px">
            <h4 style="margin-bottom:8px;color:#111827">1day</h4>
            <div class="schedule-item"><div class="time">14:50</div><div class="activity">ì½”ë¹„ ì§‘í•©</div><div class="location">ë¶€ì—¬ë°±ì œë§ˆë¦¬ì¡°íŠ¸</div></div>
            <div class="schedule-item"><div class="time">15:10</div><div class="activity">ì²´í¬ì¸ ë° ë°©ë°°ì •</div><div class="location">êµ¬ë“œë ˆì„ ì‹ë‹¹</div></div>
            <div class="schedule-item"><div class="time">15:50</div><div class="activity">ë¯¼ì†ì˜ ê°€ëŒê³¨ íƒë°©</div><div class="location">ë‚™í™”ì•”/ê³ ë€ì‚¬</div></div>
            <div class="schedule-item"><div class="time">18:30</div><div class="activity">ì €ë…ì‹ì‚¬</div><div class="location">ì„œë™í•œì˜¥</div></div>
          </div>
          <div style="background:#f7f7fb;border:1px solid #eee;border-radius:12px;padding:12px">
            <h4 style="margin-bottom:8px;color:#111827">2day</h4>
            <div class="schedule-item"><div class="time">11:00</div><div class="activity">ë¸Œë¦¬í•‘ & ì ì‹¬</div><div class="location">í˜„ì¥</div></div>
            <div class="schedule-item"><div class="time">13:10</div><div class="activity">ì„±ê³¼ ê³µìœ  ì‹œê°„</div><div class="location">ì„¸ì…˜ë£¸</div></div>
            <div class="schedule-item"><div class="time">14:10</div><div class="activity">ë§ˆë¬´ë¦¬</div><div class="location">-</div></div>
          </div>
        </div>
      </div>
    </div>`;
  document.body.insertAdjacentHTML('beforeend', html);
}
function closeDetailedSchedule(){ const m=document.getElementById('detailedScheduleModal'); if (m) m.remove(); }

/* =========================
   10) íˆ¬ì–´íŒ¨ìŠ¤ ë³´ê´€í•¨
========================= */
function showAddLinkForm(){ document.getElementById('addLinkForm').style.display='block'; document.getElementById('linkTitle').focus(); }
function cancelAddLink(){ document.getElementById('addLinkForm').style.display='none'; linkTitle.value=''; linkUrl.value=''; linkPassword.value=''; }
function isValidUrl(s){ try{ new URL(s); return true; }catch{return false;} }
function saveNewLink(){
  const title=linkTitle.value.trim(); const url=linkUrl.value.trim(); const pw=linkPassword.value.trim();
  if (!title){ alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
  if (!url || !isValidUrl(url)){ alert('ì˜¬ë°”ë¥¸ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
  const links=JSON.parse(localStorage.getItem('tourpassLinks')||'[]');
  links.push({id:Date.now(),title,url,password:pw||null,createdAt:new Date().toISOString()});
  localStorage.setItem('tourpassLinks', JSON.stringify(links)); updateLinksList(); cancelAddLink(); alert('ë§í¬ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
}
function updateLinksList(){
  const list=document.getElementById('linksList');
  const links=JSON.parse(localStorage.getItem('tourpassLinks')||'[]');
  if (links.length===0){
    list.innerHTML='<div style="text-align:center;color:#666;padding:28px"><i class="fas fa-inbox" style="font-size:2.2em;margin-bottom:12px"></i><div>ì €ì¥ëœ ë§í¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div></div>'; return;
  }
  list.innerHTML = links.map(l=>`
    <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;border:1px solid #eee;border-radius:12px;margin-bottom:10px">
      <div style="flex:1;min-width:0">
        <div style="font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${l.title}</div>
        <div style="font-size:.82em;color:#666;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${l.url}</div>
      </div>
      <div style="display:flex;gap:6px;margin-left:8px">
        <button onclick="setDefaultTourpass(${l.id})" title="ê¸°ë³¸ì„¤ì •" style="background:#2ecc71;color:#fff;border:none;border-radius:10px;padding:8px 10px;cursor:pointer;font-size:.82em">ê¸°ë³¸</button>
        <button onclick="openLink(${l.id})" title="ì—´ê¸°" style="background:#111827;color:#fff;border:none;border-radius:10px;padding:8px 10px;cursor:pointer"><i class="fas fa-external-link-alt"></i></button>
      </div>
    </div>`).join('');
}
function openLink(id){ const links=JSON.parse(localStorage.getItem('tourpassLinks')||'[]'); const l=links.find(x=>x.id===id); if (l) window.open(l.url,'_blank'); }
function setDefaultTourpass(id){ localStorage.setItem('defaultTourpass', id); alert('ê¸°ë³¸ íˆ¬ì–´íŒ¨ìŠ¤ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!'); }
function openTourpassTicket(){
  activateMenuButton('ticket');
  const links=JSON.parse(localStorage.getItem('tourpassLinks')||'[]');
  if (links.length===0){ alert('ë³´ê´€í•¨ì— ë§í¬ë¥¼ ë¨¼ì € ì¶”ê°€í•´ì£¼ì„¸ìš”.'); deactivateMenuButton('ticket'); return; }
  const def=localStorage.getItem('defaultTourpass'); if (def){ const d=links.find(l=> l.id==def); if (d && confirm(`ê¸°ë³¸ íˆ¬ì–´íŒ¨ìŠ¤ë¥¼ ì—´ê¹Œìš”?\n${d.title}`)){ openLink(d.id); deactivateMenuButton('ticket'); return; } }
  showTourpassSelector(links);
}
function showTourpassSelector(links){
  const html=`
    <div class="modal" id="tourpassSelectorModal" style="display:block">
      <div class="modal-content" style="width:560px;max-width:96%">
        <button class="close-btn" onclick="closeTourpassSelector()">&times;</button>
        <div class="modal-header"><h3>ğŸ« íˆ¬ì–´íŒ¨ìŠ¤ ì„ íƒ</h3></div>
        <div style="padding:16px">
          ${links.map(l=>`
            <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;border:1px solid #eee;border-radius:12px;margin-bottom:10px">
              <div style="min-width:0">
                <div style="font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${l.title}</div>
                <div style="font-size:.82em;color:#666;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${l.url}</div>
              </div>
              <div style="display:flex;gap:6px;margin-left:8px">
                <button onclick="event.stopPropagation(); setDefaultTourpass(${l.id})" style="background:#2ecc71;color:#fff;border:none;border-radius:10px;padding:8px 10px;cursor:pointer;font-size:.8em">ê¸°ë³¸ì„¤ì •</button>
                <button onclick="event.stopPropagation(); selectTourpass(${l.id})" style="background:#111827;color:#fff;border:none;border-radius:10px;padding:8px 10px;cursor:pointer;font-size:.8em">ì—´ê¸°</button>
              </div>
            </div>`).join('')}
        </div>
      </div>
    </div>`;
  document.body.insertAdjacentHTML('beforeend', html);
}
function selectTourpass(id){ openLink(id); closeTourpassSelector(); }
function closeTourpassSelector(){ const m=document.getElementById('tourpassSelectorModal'); if (m) m.remove(); deactivateMenuButton('ticket'); }

/* =========================
   11) ë²ˆì—­(ê°„ë‹¨)
========================= */
function translateApp(){
  const lang=document.getElementById('languageSelect').value;
  const map={
    ko:{title:'íˆ¬ì–´íŒ¨ìŠ¤ì‚¬ì—…ë¶€ 2025 ì›Œí¬ìƒµ',sub:'TRAVEL SHIFT',login:'ì´ë¦„+MBTIë¡œ ë¡œê·¸ì¸',online:'ì˜¨ë¼ì¸',offline:'ì˜¤í”„ë¼ì¸',checking:'ì—°ê²° í™•ì¸ ì¤‘...',sync:'ë™ê¸°í™”: '},
    en:{title:'TourPass BU 2025 Workshop',sub:'TRAVEL SHIFT',login:'Sign in with Name+MBTI',online:'Online',offline:'Offline',checking:'Checking connection...',sync:'Sync: '},
    ja:{title:'ãƒ„ã‚¢ãƒ¼ãƒ‘ã‚¹äº‹æ¥­éƒ¨ 2025 ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—',sub:'TRAVEL SHIFT',login:'åå‰+MBTIã§ãƒ­ã‚°ã‚¤ãƒ³',online:'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³',offline:'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³',checking:'æ¥ç¶šç¢ºèªä¸­...',sync:'åŒæœŸ: '},
    zh:{title:'æ—…æ¸¸é€šè¡Œè¯äº‹ä¸šéƒ¨ 2025 ç ”ä¹ ç­',sub:'TRAVEL SHIFT',login:'ç”¨å§“å+MBTIç™»å½•',online:'åœ¨çº¿',offline:'ç¦»çº¿',checking:'æ£€æŸ¥è¿æ¥ä¸­...',sync:'åŒæ­¥: '}
  };
  // ì´í•˜ ë™ì¼
}

/* =========================
   12) ë¶€íŒ…
========================= */
async function initializeApp(){
  checkConnection();
  const ok=await checkBackendConnection();
  const dot=document.getElementById('connectionDot'); const text=document.getElementById('connectionText');
  if (ok){ dot.className='status-dot status-online'; text.textContent='ì˜¨ë¼ì¸'; } else { dot.className='status-dot status-offline'; text.textContent='ì˜¤í”„ë¼ì¸'; }
  checkLoginStatus();
}
document.addEventListener('DOMContentLoaded', ()=>{
  initializeApp();
  document.getElementById('googleLoginBtn').addEventListener('click', googleLogin);
});
</script>
</body>
</html>
