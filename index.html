<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>투어패스사업부 2025 워크숍</title>
  <style>
    @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css');

    :root {
      --primary-brand: #1e40af;
      --secondary-brand: #3b82f6;
      --accent-warm: #f59e0b;
      --accent-cool: #06b6d4;
      --text-primary: #0f172a;
      --text-secondary: #475569;
      --text-muted: #64748b;
      --surface-primary: #ffffff;
      --surface-secondary: #f8fafc;
      --surface-elevated: #f1f5f9;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --gradient-brand: linear-gradient(135deg, var(--primary-brand), var(--secondary-brand));
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
      --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.1);
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Pretendard',-apple-system,BlinkMacSystemFont,'Segoe UI','Malgun Gothic','맑은 고딕',sans-serif;background:var(--surface-secondary);color:var(--text-primary);line-height:1.7}
    .container{max-width:428px;margin:0 auto;padding:1.5rem;min-height:100vh;transition:filter .25s ease}
    .blurred{filter:blur(6px)}
    .overlay {
      position: fixed; inset: 0; background: rgba(15,23,42,.45);
      display: none; align-items: center; justify-content: center; z-index: 2000;
      backdrop-filter: blur(2px);
    }
    .overlay-card {
      background:#fff;border-radius:20px;padding:1.5rem 1.25rem;max-width:420px;width:90%;text-align:center;
      box-shadow: var(--shadow-xl);
    }
    .overlay h2{font-size:1.35rem;margin-bottom:.5rem}
    .overlay p{color:var(--text-secondary);margin-bottom:1rem}

    .header{text-align:center;margin-bottom:2rem;padding:2.25rem 0}
    .header h1{font-size:2.15rem;font-weight:800;margin-bottom:.25rem}
    .header p{font-size:1.1rem;color:var(--text-secondary)}
    .card{background:var(--surface-primary);border-radius:24px;padding:1.5rem;margin-bottom:1.25rem;box-shadow:var(--shadow-md);border:1px solid rgba(59,130,246,.08)}
    .form-group{margin-bottom:1rem}
    label{display:block;font-weight:600;margin-bottom:.5rem;font-size:.9rem}
    select,input,textarea{width:100%;padding:1rem 1.1rem;border:1.5px solid #e2e8f0;border-radius:16px;font-size:1rem;font-family:inherit}
    select:focus,input:focus,textarea:focus{outline:none;border-color:var(--secondary-brand);box-shadow:0 0 0 3px rgba(59,130,246,.1)}
    .btn{padding:1rem 1.25rem;border:none;border-radius:16px;font-size:1rem;font-weight:700;cursor:pointer;transition:.2s;width:100%}
    .btn-primary{background:var(--gradient-brand);color:#fff}
    .btn-primary:hover{transform:translateY(-1px);box-shadow:var(--shadow-lg)}
    .btn-secondary{background:var(--surface-elevated);color:var(--text-primary)}
    .btn-link{background:#fff;border:1px solid #e2e8f0}
    .menu-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-top:1rem}
    .menu-item{background:var(--surface-primary);border:1.5px solid rgba(59,130,246,.08);border-radius:20px;padding:1.25rem;text-align:center;cursor:pointer;transition:.3s;text-decoration:none;color:inherit}
    .menu-item:hover{transform:translateY(-3px);box-shadow:var(--shadow-xl);border-color:var(--secondary-brand)}
    .menu-title{font-weight:800;font-size:1.05rem;margin-bottom:.35rem}
    .menu-desc{font-size:.85rem;color:var(--text-secondary)}
    .timer-card{background:var(--gradient-brand);color:#fff;text-align:center}
    .timer-display{font-size:3rem;font-weight:900}
    .user-info{border:1.5px solid rgba(59,130,246,.08);padding:1.25rem;border-radius:20px;margin-bottom:1rem;text-align:center}
    .alert{padding:.85rem;border-radius:16px;margin-bottom:1rem;text-align:center}
    .alert-success{background:rgba(16,185,129,.1);color:#047857;border:1px solid rgba(16,185,129,.25)}
    .alert-error{background:rgba(239,68,68,.1);color:#dc2626;border:1px solid rgba(239,68,68,.25)}
    .hidden{display:none}

    /* Modal */
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:1000;overflow-y:auto}
    .modal-content{background:#fff;margin:50px auto;padding:0;width:90%;max-width:600px;border-radius:24px}
    .modal-header{padding:1.25rem 1.25rem;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center}
    .modal-header h2{margin:0;font-size:1.3rem}
    .close-btn{background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--text-muted)}
    .modal-body{padding:1.25rem}
    .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem}
    .stat-card{background:var(--surface-elevated);padding:1.25rem;border-radius:16px;text-align:center}
    .stat-number{font-size:1.75rem;font-weight:900;color:var(--primary-brand)}
    .stat-label{font-size:.85rem;color:var(--text-secondary)}
    .mbti-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:.6rem}
    .mbti-item{background:var(--surface-elevated);padding:.8rem;border-radius:12px;text-align:center;border:1px solid #e2e8f0}
    .mbti-type{font-weight:800;color:var(--primary-brand);font-size:.8rem;margin-bottom:.2rem}
    .mbti-count{font-size:1.25rem;font-weight:900}

    /* 설문 UI 개편 */
    .q-card{background:#fff;border:1px solid #e2e8f0;border-radius:16px;padding:1rem;margin-bottom:1rem}
    .q-title{font-weight:800;margin-bottom:.6rem}
    .scale{display:flex;gap:.5rem;justify-content:space-between}
    .scale input{display:none}
    .scale label{
      flex:1; text-align:center; padding:.75rem 0; border:1px solid #e2e8f0; border-radius:12px; cursor:pointer;
      user-select:none; transition:.15s; font-weight:700;
    }
    .scale input:checked + label{border-color:var(--secondary-brand);box-shadow:0 0 0 3px rgba(59,130,246,.12)}
    .pill-group{display:grid;grid-template-columns:1fr 1fr;gap:.6rem}
    .pill{display:block;border:1px solid #e2e8f0;border-radius:999px;padding:.75rem 1rem;text-align:center;cursor:pointer;font-weight:700}
    .radio-hidden{display:none}
    .radio-hidden:checked + .pill{border-color:var(--secondary-brand);box-shadow:0 0 0 3px rgba(59,130,246,.12)}
  </style>
</head>
<body>
  <div id="blurTarget" class="container">
    <div class="header">
      <h1>투어패스사업부</h1>
      <p>2025 워크숍</p>
    </div>

    <!-- 로그인 -->
    <div id="loginScreen" class="card">
      <div class="form-group">
        <label for="userName">이름을 선택하세요</label>
        <select id="userName" required>
          <option value="">이름을 선택해주세요</option>
          <option value="남도현">남도현</option>
          <option value="김수인">김수인</option>
          <option value="고다현">고다현</option>
          <option value="심재희">심재희</option>
          <option value="판티니안">판티니안</option>
          <option value="김현철">김현철</option>
          <option value="이유진">이유진</option>
          <option value="정어진">정어진</option>
          <option value="장원준">장원준</option>
          <option value="김대진">김대진</option>
          <option value="손현우">손현우</option>
          <option value="이주아">이주아</option>
          <option value="장은진">장은진</option>
        </select>
      </div>
      <div class="form-group">
        <label for="userMBTI">MBTI를 선택하세요</label>
        <select id="userMBTI" required>
          <option value="">MBTI를 선택해주세요</option>
          <option>INTJ</option><option>INTP</option><option>ENTJ</option><option>ENTP</option>
          <option>INFJ</option><option>INFP</option><option>ENFJ</option><option>ENFP</option>
          <option>ISTJ</option><option>ISFJ</option><option>ESTJ</option><option>ESFJ</option>
          <option>ISTP</option><option>ISFP</option><option>ESTP</option><option>ESFP</option>
        </select>
      </div>
      <button class="btn btn-primary" id="loginBtn">로그인</button>
    </div>

    <!-- 메인 -->
    <div id="mainScreen" class="hidden">
      <div class="user-info">
        <h3 id="userNameDisplay"></h3>
        <p id="userTeamDisplay"></p>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:.6rem;margin-top:.6rem;">
          <button class="btn btn-link" id="logoutBtn">로그아웃</button>
          <!-- [1] 워크숍 참여하기 버튼 -->
          <button class="btn btn-primary" id="startBtn">워크숍 참여하기</button>
        </div>
      </div>

      <div id="timerCard" class="card timer-card">
        <div style="font-size:1.05rem;margin-bottom:.6rem;opacity:.9;">워크숍 남은 시간</div>
        <div id="timerDisplay" class="timer-display">48:00:00</div>
      </div>

      <div class="menu-grid">
        <div class="menu-item" id="mbtiMenu">
          <div class="menu-title">참가자 현황</div>
          <div class="menu-desc">MBTI 분포</div>
        </div>

        <div class="menu-item" id="scheduleMenu">
          <div class="menu-title">워크샵 일정</div>
          <div class="menu-desc">프로그램</div>
        </div>

        <div class="menu-item" id="linkMenu">
          <div class="menu-title">링크 보관함</div>
          <div class="menu-desc">자료 저장</div>
        </div>

        <a class="menu-item" id="aiMenu" href="#" target="_blank" rel="noopener">
          <div class="menu-title">AI 챗봇</div>
          <div class="menu-desc">워크숍 전용 헬퍼</div>
        </a>
      </div>
    </div>

    <!-- 알림 -->
    <div id="alertMessage" class="hidden"></div>
  </div>

  <!-- 타이머 종료 오버레이 -->
  <div id="overlay" class="overlay">
    <div class="overlay-card">
      <h2>워크숍이 종료되었습니다</h2>
      <p>설문을 진행해 주세요.</p>
      <button class="btn btn-primary" id="openSurveyFromOverlay">설문 시작하기</button>
    </div>
  </div>

  <!-- MBTI 모달 -->
  <div id="mbtiModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>참가자 현황</h2>
        <button class="close-btn" data-close="mbtiModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number" id="totalParticipants">0</div>
            <div class="stat-label">총 참가자</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="onlineCount">0</div>
            <div class="stat-label">현재 접속</div>
          </div>
        </div>
        <h3>MBTI 분포</h3>
        <div class="mbti-grid" id="mbtiDistribution"></div>

        <!-- [2] MBTI 관계도 링크 버튼 -->
        <div style="margin-top:1rem;display:flex;gap:.6rem;">
          <a id="relationBtn" href="#" class="btn btn-link" target="_blank" rel="noopener">MBTI 관계도 보기</a>
        </div>
      </div>
    </div>
  </div>

  <!-- 일정 모달 -->
  <div id="scheduleModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>워크숍 일정</h2>
        <button class="close-btn" data-close="scheduleModal">&times;</button>
      </div>
      <div class="modal-body">
        <h3>1일차</h3>
        <div class="card"><div class="q-title">14:50 로비 집합</div><div class="text-sm">부여롯데리조트</div></div>
        <div class="card"><div class="q-title">15:30 체크인 및 백제문화단지</div><div class="text-sm">관광 및 체험</div></div>
        <div class="card"><div class="q-title">18:30 저녁식사</div><div class="text-sm">서동한우 구양점</div></div>
        <div class="card"><div class="q-title">21:00 회식 및 레크레이션</div><div class="text-sm">부여롯데리조트</div></div>
        <h3 style="margin-top:1rem;">2일차</h3>
        <div class="card"><div class="q-title">11:00 아침겸 점심</div><div class="text-sm">장원막국수</div></div>
        <div class="card"><div class="q-title">12:30 워크숍</div><div class="text-sm">사비123창작센터</div></div>
        <div class="card"><div class="q-title">14:10 귀가</div><div class="text-sm">워크숍 종료</div></div>
      </div>
    </div>
  </div>

  <!-- 링크 모달 -->
  <div id="linkModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>링크 보관함</h2>
        <button class="close-btn" data-close="linkModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="card">
          <h3>새 링크 추가</h3>
          <div class="form-group"><input type="text" id="linkTitle" placeholder="제목"></div>
          <div class="form-group"><input type="url" id="linkUrl" placeholder="URL (https://...)"></div>
          <div class="form-group">
            <select id="linkCategory">
              <option>워크숍 자료</option><option>업무 도구</option>
              <option>참고 자료</option><option>기타</option>
            </select>
          </div>
          <div class="form-group"><textarea id="linkDescription" rows="3" placeholder="설명 (선택)"></textarea></div>
          <button class="btn btn-primary" id="saveLinkBtn">링크 저장</button>
        </div>

        <h3 style="margin-top:1rem;">저장된 링크</h3>
        <div id="linksList"></div>
      </div>
    </div>
  </div>

  <!-- [3] 설문 모달 (개편 버전) -->
  <div id="surveyModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>만족도 설문조사</h2>
        <button class="close-btn" data-close="surveyModal">&times;</button>
      </div>
      <div class="modal-body">

        <!-- Q1: 5점 척도 -->
        <div class="q-card">
          <div class="q-title">1. 워크숍 전체 만족도</div>
          <div class="scale">
            <input type="radio" name="q1" id="q1_1" value="1"><label for="q1_1">1</label>
            <input type="radio" name="q1" id="q1_2" value="2"><label for="q1_2">2</label>
            <input type="radio" name="q1" id="q1_3" value="3"><label for="q1_3">3</label>
            <input type="radio" name="q1" id="q1_4" value="4"><label for="q1_4">4</label>
            <input type="radio" name="q1" id="q1_5" value="5"><label for="q1_5">5</label>
          </div>
        </div>

        <!-- Q2: 가장 마음에 들었던 프로그램 -->
        <div class="q-card">
          <div class="q-title">2. 가장 마음에 들었던 프로그램</div>
          <div class="pill-group">
            <input class="radio-hidden" type="radio" name="q2" id="q2_a" value="숙소"><label class="pill" for="q2_a">숙소</label>
            <input class="radio-hidden" type="radio" name="q2" id="q2_b" value="음식"><label class="pill" for="q2_b">음식</label>
            <input class="radio-hidden" type="radio" name="q2" id="q2_c" value="충남투어패스"><label class="pill" for="q2_c">충남투어패스</label>
            <input class="radio-hidden" type="radio" name="q2" id="q2_d" value="워크숍 (사비123)"><label class="pill" for="q2_d">워크숍 (사비123)</label>
          </div>
        </div>

        <!-- Q3: 개선사항 -->
        <div class="q-card">
          <div class="q-title">3. 개선사항 및 의견</div>
          <textarea id="feedback" rows="5" placeholder="자유롭게 작성해주세요"></textarea>
        </div>

        <button class="btn btn-primary" id="submitSurveyBtn">설문 제출</button>
      </div>
    </div>
  </div>

  <script>
    /***** 설정 *****/
    const API_URL = 'https://script.google.com/macros/s/AKfycbxP7oI1CUK7vvga2HJbUp6r_U5bOsFWwFzcIAhIrRjKfCbUf7Mwlu56Ayqa3EokUJXz/exec'; // 예: https://script.google.com/macros/s/AKfycb.../exec
    const RELATION_URL = '<<MBTI_관계도_URL(추후_교체)>>';
    const AI_CHATBOT_URL = 'https://chatgpt.com/g/g-689acc0b7bd08191bb31112e0a19cffc-tueopaeseu-saeobjeanseo-ai-eosiseunteu';

    /***** 상태 *****/
    let currentUser = null;
    let sessionId = null;
    let timerInterval = null;
    let timerRunning = false;
    let workshopEndAt = null; // Date

    const TEMP_USER_DATA = {
      "남도현": { team:"투어패스사업부", position:"이사" },
      "김수인": { team:"투어패스사업부 영업 1팀", position:"팀장" },
      "고다현": { team:"투어패스사업부 영업 1팀", position:"사원" },
      "심재희": { team:"투어패스사업부 영업 1팀", position:"매니저" },
      "판티니안": { team:"투어패스사업부 영업 1팀", position:"매니저" },
      "김현철": { team:"투어패스사업부 영업 2팀", position:"팀장" },
      "이유진": { team:"투어패스사업부 영업 2팀", position:"사원" },
      "정어진": { team:"투어패스사업부 영업 2팀", position:"사원" },
      "장원준": { team:"투어패스사업부 영업 2팀", position:"사원" },
      "김대진": { team:"투어패스사업부 영업 2팀", position:"팀장" },
      "손현우": { team:"투어패스사업부 영업 2팀", position:"대리" },
      "이주아": { team:"투어패스사업부 영업 2팀", position:"주임" },
      "장은진": { team:"투어패스사업부 영업 2팀", position:"주임" }
    };

    /***** 유틸 *****/
    function escapeHtml(s=''){return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;')}
    function showAlert(message, type='success') {
      const alert = document.getElementById('alertMessage');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      alert.classList.remove('hidden');
      setTimeout(() => alert.classList.add('hidden'), 2500);
    }
    function fmt(ms){
      const total = Math.max(0, Math.floor(ms/1000));
      const h = String(Math.floor(total/3600)).padStart(2,'0');
      const m = String(Math.floor((total%3600)/60)).padStart(2,'0');
      const s = String(total%60).padStart(2,'0');
      return `${h}:${m}:${s}`;
    }

    /***** API *****/
    async function apiRequest(action, data = {}) {
      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' }, // preflight 회피
          body: JSON.stringify({ action, sessionId, ...data })
        });
        if (!res.ok) return { success: false, error: `HTTP ${res.status}` };
        return await res.json();
      } catch (e) {
        return { success: false, error: e.message };
      }
    }

    /***** 로그인/메인 *****/
    async function handleLogin() {
      const userName = document.getElementById('userName').value;
      const userMBTI = document.getElementById('userMBTI').value;
      if (!userName || !userMBTI) return showAlert('이름과 MBTI를 모두 선택해주세요','error');

      currentUser = userName;
      sessionId = 'session_' + Date.now();
      const userInfo = TEMP_USER_DATA[userName];

      const res = await apiRequest('login', { userName, mbti: userMBTI, team: userInfo.team, position: userInfo.position });
      if (!res.success) return showAlert('로그인 실패: ' + (res.error || ''), 'error');

      localStorage.setItem('currentUser', userName);
      localStorage.setItem('userMBTI', userMBTI);
      localStorage.setItem('sessionId', sessionId);

      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('mainScreen').classList.remove('hidden');
      document.getElementById('userNameDisplay').textContent = currentUser;
      document.getElementById('userTeamDisplay').textContent = `${userInfo.team} | ${userInfo.position}`;
      showAlert(`환영합니다, ${currentUser}님!`);
    }

    async function handleLogout() {
      if (!currentUser) return location.reload();
      if (!confirm('로그아웃하시겠습니까?')) return;
      await apiRequest('updateUserStatus', { userName: currentUser, status: 'offline' });
      localStorage.clear();
      location.reload();
    }

    /***** [1] 타이머: 참여 버튼 클릭 시 시작 → 종료 시 블러 & 설문 호출 *****/
    function startTimer() {
      if (timerRunning) return;
      timerRunning = true;

      // 48시간 후 종료
      workshopEndAt = new Date(Date.now() + 48*60*60*1000);
      tick(); // 즉시 1회 갱신
      timerInterval = setInterval(tick, 1000);

      function tick(){
        const remain = workshopEndAt - Date.now();
        document.getElementById('timerDisplay').textContent = fmt(remain);
        if (remain <= 0) {
          clearInterval(timerInterval);
          timerRunning = false;
          endFlow();
        }
      }
      showAlert('카운트다운을 시작합니다.');
    }

    function endFlow(){
      // 블러 & 오버레이, 설문 자동 오픈
      document.getElementById('blurTarget').classList.add('blurred');
      const overlay = document.getElementById('overlay');
      overlay.style.display = 'flex';
      openSurvey(); // 자동 오픈
    }

    /***** MBTI *****/
    async function loadMBTIStats() {
      document.getElementById('mbtiModal').style.display = 'block';
      const res = await apiRequest('getMBTIStats');
      if (!res.success) return showAlert('통계를 불러오지 못했습니다','error');
      document.getElementById('totalParticipants').textContent = res.totalParticipants || 0;
      document.getElementById('onlineCount').textContent = res.onlineUsers || 0;
      const grid = document.getElementById('mbtiDistribution');
      grid.innerHTML = '';
      const all = ['INTJ','INTP','ENTJ','ENTP','INFJ','INFP','ENFJ','ENFP','ISTJ','ISFJ','ESTJ','ESFJ','ISTP','ISFP','ESTP','ESFP'];
      all.forEach(t=>{
        const c = (res.mbtiDistribution && res.mbtiDistribution[t]) || 0;
        const el = document.createElement('div');
        el.className = 'mbti-item';
        if (c>0){ el.style.background='rgba(59,130,246,.1)'; el.style.borderColor='var(--secondary-brand)'; }
        el.innerHTML = `<div class="mbti-type">${t}</div><div class="mbti-count">${c}</div>`;
        grid.appendChild(el);
      });
      // 링크 세팅
      const btn = document.getElementById('relationBtn');
      btn.href = RELATION_URL !== '<<MBTI_관계도_URL(추후_교체)>>' ? RELATION_URL : '#';
      if (btn.href.endsWith('#')) btn.textContent = 'MBTI 관계도 (URL 준비 중)';
    }

    /***** 링크 저장/조회 *****/
    async function saveLink() {
      const title = document.getElementById('linkTitle').value.trim();
      const url = document.getElementById('linkUrl').value.trim();
      const category = document.getElementById('linkCategory').value;
      const description = document.getElementById('linkDescription').value.trim();
      if (!title || !url) return showAlert('제목과 URL을 입력해주세요','error');

      const res = await apiRequest('saveLink', { user: currentUser, title, url, category, description });
      if (!res.success) return showAlert('링크 저장 실패: ' + (res.error || ''), 'error');

      showAlert('링크가 저장되었습니다');
      document.getElementById('linkTitle').value = '';
      document.getElementById('linkUrl').value = '';
      document.getElementById('linkDescription').value = '';
      loadLinks();
    }

    async function loadLinks() {
      const target = document.getElementById('linksList');
      target.innerHTML = '<div class="alert">불러오는 중...</div>';
      const res = await apiRequest('getLinks', { user: currentUser });
      if (!res.success) return target.innerHTML = '<div class="alert alert-error">링크를 불러오지 못했습니다</div>';
      const items = res.items || [];
      if (items.length === 0) return target.innerHTML = '<div class="alert">저장된 링크가 없습니다</div>';
      target.innerHTML = items.map(l=>`
        <div class="card" style="margin-bottom:.6rem;">
          <strong>${escapeHtml(l.title)}</strong><br>
          <a href="${escapeHtml(l.url)}" target="_blank" style="color: var(--secondary-brand);">${escapeHtml(l.url)}</a><br>
          <small style="color: var(--text-secondary);">${escapeHtml(l.category||'')}</small>
          ${l.description?`<br><small>${escapeHtml(l.description)}</small>`:''}
        </div>
      `).join('');
    }

    /***** [3] 설문 제출 *****/
    function openSurvey(){
      document.getElementById('surveyModal').style.display = 'block';
    }

    async function submitSurvey() {
      const q1 = document.querySelector('input[name="q1"]:checked');
      const q2 = document.querySelector('input[name="q2"]:checked');
      const feedback = document.getElementById('feedback').value;
      if (!q1 || !q2) return showAlert('문항 1, 2를 선택해주세요','error');

      // 서버 기존 스키마에 맞춰 전달(필드명 매핑)
      const res = await apiRequest('saveSurvey', {
        user: currentUser,
        satisfaction: q1.value,                 // 1~5
        useful_program: q2.value,               // 선택값
        feedback
      });
      if (!res.success) return showAlert('설문 제출 실패: ' + (res.error || ''), 'error');

      showAlert('설문이 제출되었습니다. 감사합니다!');
      document.getElementById('surveyModal').style.display = 'none';
    }

    /***** 초기화 및 이벤트 *****/
    document.addEventListener('DOMContentLoaded', () => {
      // 로그인/로그아웃/참여
      document.getElementById('loginBtn').addEventListener('click', handleLogin);
      document.getElementById('logoutBtn').addEventListener('click', handleLogout);
      document.getElementById('startBtn').addEventListener('click', startTimer);

      // 메뉴
      document.getElementById('mbtiMenu').addEventListener('click', loadMBTIStats);
      document.getElementById('scheduleMenu').addEventListener('click', ()=> document.getElementById('scheduleModal').style.display='block');
      document.getElementById('linkMenu').addEventListener('click', ()=> { document.getElementById('linkModal').style.display='block'; loadLinks(); });

      // AI 챗봇
      const ai = document.getElementById('aiMenu');
      ai.href = AI_CHATBOT_URL;

      // 모달 닫기 & 외부 클릭 닫기
      document.querySelectorAll('.close-btn').forEach(btn=>{
        btn.addEventListener('click', function(){
          const id = this.getAttribute('data-close');
          if (id) document.getElementById(id).style.display='none';
          else this.closest('.modal').style.display='none';
        })
      });
      window.addEventListener('click', e=>{
        if (e.target.classList && e.target.classList.contains('modal')) e.target.style.display='none';
      });

      // 링크 저장/설문 제출
      document.getElementById('saveLinkBtn').addEventListener('click', saveLink);
      document.getElementById('submitSurveyBtn').addEventListener('click', submitSurvey);

      // 오버레이 버튼
      document.getElementById('openSurveyFromOverlay').addEventListener('click', ()=>{
        document.getElementById('surveyModal').style.display='block';
      });

      // 세션 복원
      const savedUser = localStorage.getItem('currentUser');
      if (savedUser) {
        currentUser = savedUser;
        sessionId = localStorage.getItem('sessionId');
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('mainScreen').classList.remove('hidden');

        const info = TEMP_USER_DATA[currentUser];
        document.getElementById('userNameDisplay').textContent = currentUser;
        document.getElementById('userTeamDisplay').textContent = `${info.team} | ${info.position}`;
      }
    });
  </script>
</body>
</html>
