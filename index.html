<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>투어패스사업부 2025 워크샵 | TRAVEL SHIFT</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:'Noto Sans KR',sans-serif;background:#f2f4f9;min-height:100vh;color:#222}
  .app-container{max-width:420px;margin:0 auto;background:#fff;min-height:100vh;border-left:1px solid #eee;border-right:1px solid #eee}
  .app-header{background:#ffffff;border-bottom:1px solid #eee;text-align:center;padding:18px 12px;position:sticky;top:0;z-index:5}
  .app-title{font-size:1.05rem;font-weight:800;letter-spacing:.2px}
  .app-subtitle{font-size:.82rem;color:#667;}
  .status-bar{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-bottom:1px solid #eee;background:#fafbff}
  .connection-status{display:flex;align-items:center;gap:8px;font-size:.85em}
  .status-dot{width:8px;height:8px;border-radius:50%}
  .status-online{background:#2ecc71}.status-offline{background:#ff6b6b}
  .main-content{padding:16px}
  .google-login{background:#fff;border:1px solid #eee;border-radius:12px;padding:18px}
  .login-btn{width:100%;background:#111827;color:#fff;border:none;border-radius:10px;padding:12px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px}
  .login-btn:hover{opacity:.92}
  .user-info{display:none;align-items:center;gap:12px;padding:14px;background:#f6f7fb;border:1px solid #eee;border-radius:10px;margin-top:12px}
  .user-avatar{width:40px;height:40px;border-radius:50%;background:#111827;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800}
  .user-details h4{font-size:.98em}
  .user-details p{font-size:.78em;color:#666}
  /* ---- 메뉴 타일: 이미지형(보라 오버레이 제거) ---- */
  .menu-grid{display:none;grid-template-columns:1fr 1fr;gap:12px;margin:16px 0 8px}
  .menu-item{
    position:relative;border:1px solid #eee;border-radius:14px;padding:16px;
    cursor:pointer;transition:transform .18s ease, box-shadow .18s ease;background:#fff;overflow:hidden;
    box-shadow:0 4px 14px rgba(16,24,40,.04);
  }
  .menu-item:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(16,24,40,.08)}
  .menu-item:active{transform:scale(.98)}
  /* 배경 이미지 느낌(라이트 패턴 + 워터마크 아이콘) */
  .menu-item::before{
    content:"";position:absolute;inset:0;z-index:0;
    background:
      radial-gradient(30% 40% at 90% 10%, rgba(0,0,0,.04), transparent 60%),
      radial-gradient(25% 35% at 0% 100%, rgba(0,0,0,.04), transparent 60%),
      linear-gradient(180deg,#ffffff 0%,#f8fafc 100%);
  }
  .menu-item::after{
    content:attr(data-mark);
    position:absolute;right:-6px;bottom:-10px;z-index:0;
    font-size:56px;opacity:.08;color:#000;font-weight:900;pointer-events:none;
  }
  .menu-item > *{position:relative;z-index:1}
  .menu-icon{font-size:2em;margin-bottom:6px;color:#111827}
  .menu-title{font-size:.92em;font-weight:800}
  .menu-desc{font-size:.72em;color:#606}
  .app-translate{background:#fff;border:1px solid #eee;border-radius:12px;padding:14px}
  /* 모달 */
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:1000}
  .modal-content{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border-radius:14px;max-width:92%;width:360px;max-height:88%;overflow:auto;box-shadow:0 24px 48px rgba(16,24,40,.24)}
  .modal-header{padding:18px 18px 0}
  .close-btn{position:absolute;top:10px;right:12px;background:#fff;border:1px solid #eee;border-radius:8px;font-size:1rem;padding:4px 8px;cursor:pointer}
  /* 참가자 */
  .participants-list{max-height:360px;overflow:auto;padding:0 16px 16px}
  .participant-item{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid #f0f0f0}
  .participant-avatar{width:30px;height:30px;border-radius:50%;background:#111827;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:.85em}
  .sync-btn{background:#111827;color:#fff;border:none;border-radius:10px;padding:10px 12px;cursor:pointer}
  /* MBTI */
  .mbti-test{padding:18px}
  .question-card{background:#f7f7fb;border:1px solid #eee;border-radius:12px;padding:16px}
  .question-number{color:#111827;font-weight:800;margin-bottom:8px}
  .question-text{line-height:1.5;margin-bottom:14px}
  .answer-btn{width:100%;background:#fff;border:2px solid #eee;border-radius:10px;padding:12px;text-align:left;margin-top:10px;cursor:pointer}
  .answer-btn:hover{border-color:#111827;background:#f4f5f7}
  .answer-btn.selected{border-color:#111827;background:#111827;color:#fff}
  .progress-bar{height:4px;background:#eee;border-radius:2px;margin-bottom:12px}
  .progress-fill{height:100%;width:0;background:#111827;border-radius:2px;transition:width .3s}
  /* 관계도(카테고리 카드) */
  .rel-cat{margin-bottom:18px}
  .rel-head{display:flex;align-items:center;gap:8px;color:#fff;padding:10px 12px;border-radius:10px;margin-bottom:10px;font-weight:900}
  .rel-box{background:#fafbff;border:1px solid #eee;border-radius:10px;padding:12px}
  .rel-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:10px}
  .rel-card{background:#fff;border:1px solid #eee;border-left:4px solid #000;border-radius:8px;padding:10px}
  .rel-row{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .badge{background:#111827;color:#fff;padding:4px 8px;border-radius:6px;font-size:.78em;font-weight:800}
  .muted{font-size:.8em;color:#666;margin-top:6px}
  /* 일정(간단) */
  .schedule-item{display:flex;align-items:flex-start;padding:10px 0;border-bottom:1px solid #eee}
  .schedule-item:last-child{border-bottom:none}
  .schedule-item .time{width:60px;font-weight:800;color:#111827}
  .schedule-item .activity{flex:1;margin:0 10px}
  .schedule-item .location{width:120px;color:#666;text-align:right}
  /* 작은 화면 */
  @media (max-width:480px){.app-container{max-width:100%}.menu-icon{font-size:1.8em}}
</style>
</head>
<body>
  <div class="app-container">
    <div class="app-header">
      <div class="app-title">투어패스사업부 2025 워크샵</div>
      <div class="app-subtitle">TRAVEL SHIFT</div>
    </div>

    <div class="status-bar">
      <div class="connection-status">
        <div id="connectionDot" class="status-dot"></div>
        <span id="connectionText">연결 확인 중...</span>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <div id="lastSync">동기화: -</div>
        <button onclick="syncData()" title="데이터 동기화" style="background:none;border:none;cursor:pointer;font-size:1.05em">🔄</button>
        <button id="logoutBtn" onclick="logout()" style="background:#fff;border:1px solid #ddd;border-radius:8px;padding:6px 10px;cursor:pointer">로그아웃</button>
      </div>
    </div>

    <div class="main-content">
      <!-- 로그인 -->
      <div id="loginSection" class="google-login">
        <button id="googleLoginBtn" class="login-btn">
          <i class="fab fa-google"></i> 이름으로 로그인
        </button>
        <p style="font-size:.82em;color:#666;margin-top:10px;text-align:center">
          워크샵 참여를 위해 로그인이 필요합니다
        </p>
      </div>

      <!-- 사용자 정보 -->
      <div id="userInfo" class="user-info">
        <div id="userAvatar" class="user-avatar">U</div>
        <div class="user-details">
          <h4 id="userName">사용자</h4>
          <p id="userEmail">user@example.com</p>
          <p id="userDept" style="margin-top:2px"></p>
        </div>
      </div>

      <!-- 메뉴 -->
      <div id="mainMenu" class="menu-grid">
        <div class="menu-item" data-action="participants" data-mark="👥" onclick="openModal('participantsModal')">
          <div class="menu-icon">👥</div>
          <div class="menu-title">참가자 현황</div>
          <div class="menu-desc">MBTI 및 팀 구성 보기</div>
        </div>
        <div class="menu-item" data-action="schedule" data-mark="📅" onclick="openScheduleOptions()">
          <div class="menu-icon">📅</div>
          <div class="menu-title">워크샵 일정</div>
          <div class="menu-desc">상세 일정 및 프로그램</div>
        </div>
        <div class="menu-item" data-action="mbti" data-mark="🧠" onclick="startMBTITest()">
          <div class="menu-icon">🧠</div>
          <div class="menu-title">MBTI 검사</div>
          <div class="menu-desc">성격 유형 검사 실시</div>
        </div>
        <div class="menu-item" data-action="ticket" data-mark="🎫" onclick="openTourpassTicket()">
          <div class="menu-icon">🎫</div>
          <div class="menu-title">투어패스 열기</div>
          <div class="menu-desc">지정된 링크 연결</div>
        </div>
        <div class="menu-item" data-action="survey" data-mark="📝" onclick="openModal('surveyModal')">
          <div class="menu-icon">📝</div>
          <div class="menu-title">설문조사</div>
          <div class="menu-desc">워크샵 만족도</div>
        </div>
        <div class="menu-item" data-action="tourpassbox" data-mark="📦" onclick="openModal('tourpassBoxModal')">
          <div class="menu-icon">📦</div>
          <div class="menu-title">투어패스 보관함</div>
          <div class="menu-desc">개인 링크 저장소</div>
        </div>
      </div>

      <!-- 번역 -->
      <div class="app-translate">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <h4>🌐 앱 번역하기</h4>
          <select id="languageSelect" onchange="translateApp()" style="padding:6px;border-radius:8px;border:1px solid #ddd">
            <option value="ko">한국어</option><option value="en">English</option><option value="ja">日本語</option><option value="zh">中文</option>
          </select>
        </div>
        <div style="font-size:.82em;color:#666">언어를 선택하면 앱 전체가 번역됩니다</div>
      </div>
    </div>
  </div>

  <!-- 참가자 모달 -->
  <div id="participantsModal" class="modal">
    <div class="modal-content" style="width:760px;max-width:95%">
      <button class="close-btn" onclick="closeModal('participantsModal')">&times;</button>
      <div class="modal-header"><h3>참가자 현황</h3></div>
      <div style="padding:10px 0 6px 0">
        <div class="participants-list" id="participantsList"></div>
        <div style="display:flex;gap:8px;align-items:center;padding:0 16px 16px">
          <button class="sync-btn" style="flex:1" onclick="showMBTIRelationship()">MBTI 관계도 보기</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MBTI 검사 모달 -->
  <div id="mbtiModal" class="modal">
    <div class="modal-content" style="width:760px;max-width:95%">
      <button class="close-btn" onclick="closeMBTITest()">&times;</button>
      <div class="mbti-test">
        <div class="progress-bar"><div id="progressBar" class="progress-fill"></div></div>
        <div class="question-card">
          <div id="questionNumber" class="question-number">질문 1/10</div>
          <div id="questionText" class="question-text">새로운 사람을 만났을 때</div>
          <div id="answerOptions"></div>
        </div>
        <button id="nextBtn" onclick="nextQuestion()" style="display:none;background:#111827;color:#fff;border:none;border-radius:8px;padding:12px 18px;cursor:pointer;margin-top:14px">
          다음 질문
        </button>
      </div>
    </div>
  </div>

  <!-- 설문 모달 -->
  <div id="surveyModal" class="modal">
    <div class="modal-content" style="width:760px;max-width:95%">
      <button class="close-btn" onclick="closeModal('surveyModal')">&times;</button>
      <div class="modal-header"><h3>워크샵 만족도 조사</h3></div>
      <div style="padding:16px 18px 22px">
        <div id="surveyForm">
          <div style="margin-bottom:16px">
            <label style="display:block;margin-bottom:8px;font-weight:700">전체적인 만족도</label>
            <input id="satisfaction" type="range" min="1" max="5" value="3" style="width:100%" oninput="document.getElementById('satisfactionValue').textContent=this.value">
            <div style="text-align:center;margin-top:6px"><span id="satisfactionValue">3</span>/5</div>
          </div>
          <div style="margin-bottom:16px">
            <label style="display:block;margin-bottom:8px;font-weight:700">가장 만족했던 활동</label>
            <select id="bestActivity" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:10px">
              <option value="">선택해주세요</option>
              <option value="wonjun-tour">원준님의 도슨트 투어</option>
              <option value="accommodation">숙소</option>
              <option value="chungnam-tourpass">충남투어패스 체험</option>
              <option value="food">음식</option>
              <option value="performance-sharing">성과공유 및 비전공유</option>
            </select>
          </div>
          <div style="margin-bottom:16px">
            <label style="display:block;margin-bottom:8px;font-weight:700">개선 의견 및 피드백</label>
            <textarea id="feedback" placeholder="자유롭게 의견을 작성해주세요..." style="width:100%;height:90px;padding:10px;border:1px solid #ddd;border-radius:10px;resize:vertical"></textarea>
          </div>
          <button onclick="submitWorkshopSurvey()" class="sync-btn" style="width:100%">설문조사 제출</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 투어패스 보관함 모달 -->
  <div id="tourpassBoxModal" class="modal">
    <div class="modal-content" style="width:760px;max-width:95%">
      <button class="close-btn" onclick="closeModal('tourpassBoxModal')">&times;</button>
      <div class="modal-header"><h3>📦 투어패스 보관함</h3></div>
      <div style="padding:16px 18px 22px">
        <div style="margin-bottom:14px">
          <button onclick="showAddLinkForm()" style="background:#2ecc71;color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer">➕ 새 링크 추가</button>
        </div>
        <div id="addLinkForm" style="display:none;background:#f8f9fb;border:1px solid #eee;padding:14px;border-radius:12px;margin-bottom:14px">
          <h4 style="margin-bottom:10px">🔗 새 링크 추가</h4>
          <div style="margin-bottom:8px">
            <label style="display:block;margin-bottom:6px;font-weight:700">제목</label>
            <input id="linkTitle" type="text" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:10px">
          </div>
          <div style="margin-bottom:8px">
            <label style="display:block;margin-bottom:6px;font-weight:700">URL</label>
            <input id="linkUrl" type="url" placeholder="https://example.com" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:10px">
          </div>
          <div style="margin-bottom:10px">
            <label style="display:block;margin-bottom:6px;font-weight:700">비밀번호(선택)</label>
            <input id="linkPassword" type="password" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:10px">
          </div>
          <div style="display:flex;gap:8px">
            <button onclick="saveNewLink()" class="sync-btn">💾 저장</button>
            <button onclick="cancelAddLink()" style="background:#9aa0a6;color:#fff;border:none;border-radius:10px;padding:10px 12px;cursor:pointer">❌ 취소</button>
          </div>
        </div>
        <div id="linksList" style="max-height:340px;overflow:auto"></div>
      </div>
    </div>
  </div>

<script>
/* =========================
   0) 상수/전역
========================= */
const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyQyuXtoF6LOh7Ag8w1N9yVbTV9MecJSg16UyP5VSb1kt2SDplndvsxX6OpDgGIXiv8/exec';

let currentUser = null;
let isOnline = false;
let currentQuestion = 0;
let mbtiAnswers = [];

/* =========================
   1) 이름 → 부서/직급 매핑 (요청 명단)
   - 앞의 3글자가 이름 본문 기준이지만,
     비교는 전체 문자열 정확 일치 사용
========================= */
const DIRECTORY = {
  "남도현": { team:"투어패스사업부", position:"이사" },
  "김수인": { team:"투어패스사업부 영업 1팀", position:"팀장" },
  "고다현": { team:"투어패스사업부 영업 1팀", position:"사원" },
  "심재희": { team:"투어패스사업부 영업 1팀", position:"매니저" },
  "판티니안": { team:"투어패스사업부 영업 1팀", position:"매니저" },
  "김현철": { team:"투어패스사업부 영업 2팀", position:"팀장" },
  "이유진": { team:"투어패스사업부 영업 2팀", position:"사원" },
  "정어진": { team:"투어패스사업부 영업 2팀", position:"사원" },
  "장원준": { team:"투어패스사업부 영업 2팀", position:"사원" },
  "김대진": { team:"투어패스사업부 영업 2팀", position:"팀장" },
  "손현우": { team:"투어패스사업부 영업 2팀", position:"대리" },
  "이주아": { team:"투어패스사업부 영업 2팀", position:"주임" },
  "장은진": { team:"투어패스사업부 영업 2팀", position:"주임" },
};

/* =========================
   2) 통신 헬퍼
========================= */
async function callGoogleAppsScript(data, method='GET'){
  let url = GAS_WEB_APP_URL;
  const opts = { method };
  if (method==='GET'){ url += '?' + new URLSearchParams(data).toString(); }
  else{
    opts.headers = { 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' };
    opts.body = new URLSearchParams({ payload: JSON.stringify(data) }).toString();
  }
  const res = await fetch(url, opts);
  const text = await res.text();
  let result; try{ result = JSON.parse(text); }catch{ throw new Error('서버 응답 파싱 실패'); }
  if (!result.success) throw new Error(result.data?.error || '서버 오류');
  return result.data;
}

/* =========================
   3) 연결/초기화
========================= */
function updateConnectionStatus(){
  const dot=document.getElementById('connectionDot');
  const text=document.getElementById('connectionText');
  if (isOnline){ dot.className='status-dot status-online'; text.textContent='온라인'; }
  else { dot.className='status-dot status-offline'; text.textContent='오프라인'; }
}
function checkConnection(){
  isOnline = navigator.onLine; updateConnectionStatus();
  window.addEventListener('online', ()=>{ isOnline=true; updateConnectionStatus(); syncData(); });
  window.addEventListener('offline', ()=>{ isOnline=false; updateConnectionStatus(); });
}
async function checkBackendConnection(){ try{ await callGoogleAppsScript({action:'healthCheck'}); return true; }catch{return false;} }
function syncData(){ document.getElementById('lastSync').textContent='동기화: '+new Date().toLocaleTimeString(); }

/* =========================
   4) 세션/로그인
========================= */
function logout(){
  localStorage.removeItem('tourpassUser'); currentUser=null;
  document.getElementById('userInfo').style.display='none';
  document.getElementById('mainMenu').style.display='none';
  document.getElementById('loginSection').style.display='block';
}
function checkLoginStatus(){
  const saved = localStorage.getItem('tourpassUser');
  if (saved){
    const u = JSON.parse(saved);
    if (confirm(`${u.name} (${u.email}) 사용자로 이어서 이용하시겠어요?`)){
      currentUser=u; showMainApp();
    }else{ logout(); }
  }
}
function applyDirectoryToUser(u){
  const dir = DIRECTORY[u.name];
  if (dir){
    u.team = dir.team;
    u.position = dir.position;
  }
  return u;
}
function importRecordsToLocal(records, user){
  try{
    const arr = JSON.parse(localStorage.getItem('mbtiResults')||'[]').filter(r=> r.email!==user.email);
    if (records && records.mbtiLatest){
      arr.push({
        name: records.mbtiLatest.name, email: records.mbtiLatest.email,
        mbtiType: records.mbtiLatest.mbtiType, timestamp: records.mbtiLatest.timestamp,
        team: user.team, position: user.position
      });
    }
    localStorage.setItem('mbtiResults', JSON.stringify(arr));
  }catch(e){ console.warn(e); }
}
async function googleLogin(){
  const btn=document.getElementById('googleLoginBtn');
  try{
    btn.innerHTML='⏳ 로그인 중...';
    let name = prompt('이름을 입력하세요:'); if (!name){ btn.innerHTML='<i class="fab fa-google"></i> 이름으로 로그인'; return; }
    name = name.trim();
    let email = prompt('이메일을 입력하세요:'); if (!email){ btn.innerHTML='<i class="fab fa-google"></i> 이름으로 로그인'; return; }
    email = email.trim().toLowerCase();

    // 1) 기존 조회
    try{
      const found = await callGoogleAppsScript({action:'getUserBundle',name,email},'POST');
      if (found && found.user){
        let u = {
          name: found.user.name, email: found.user.email,
          team: found.user.team, position: found.user.position,
          avatar: found.user.name.substring(0,1)
        };
        u = applyDirectoryToUser(u); // 명단 매핑 우선
        currentUser = u;
        importRecordsToLocal(found.records, currentUser);
        alert(`${currentUser.name}님, 기존 기록으로 로그인되었습니다.`);
        showMainApp(); btn.innerHTML='<i class="fab fa-google"></i> 이름으로 로그인'; return;
      }
    }catch(e){
      if ((e.message||'').includes('EMAIL_NAME_MISMATCH')){
        alert('이 이메일은 다른 이름으로 등록되어 있어요. 기존 이름으로 로그인하거나 이메일을 확인해주세요.');
        btn.innerHTML='<i class="fab fa-google"></i> 이름으로 로그인'; return;
      }
      // NOT_FOUND → 신규 등록
    }

    // 2) 등록/혹은 기존 반환
    let uBody = { action:'registerUser', name, email, team:'투어패스사업부', position:'직원' };
    // 명단에 있으면 부서/직급 덮어쓰기
    if (DIRECTORY[name]){ uBody.team = DIRECTORY[name].team; uBody.position = DIRECTORY[name].position; }
    const res = await callGoogleAppsScript(uBody,'POST');
    const { user, records } = res;

    let u = {
      name: user.name, email: user.email,
      team: user.team, position: user.position,
      avatar: user.name.substring(0,1)
    };
    u = applyDirectoryToUser(u);
    currentUser = u;
    importRecordsToLocal(records, currentUser);
    showMainApp(); btn.innerHTML='<i class="fab fa-google"></i> 이름으로 로그인';

  }catch(err){
    console.error(err); alert('로그인 오류: '+(err.message||err));
    btn.innerHTML='<i class="fab fa-google"></i> 이름으로 로그인';
  }
}
function showMainApp(){
  document.getElementById('loginSection').style.display='none';
  document.getElementById('userInfo').style.display='flex';
  document.getElementById('mainMenu').style.display='grid';
  document.getElementById('userName').textContent=currentUser.name;
  document.getElementById('userEmail').textContent=currentUser.email;
  document.getElementById('userDept').textContent = `${currentUser.team||''} ${currentUser.position||''}`;
  document.getElementById('userAvatar').textContent=currentUser.avatar;
  localStorage.setItem('tourpassUser', JSON.stringify(currentUser));
  setTimeout(updateMBTIButtonState, 60);
  syncData();
}

/* =========================
   5) 모달/메뉴
========================= */
function activateMenuButton(a){ document.querySelectorAll('.menu-item').forEach(i=>i.classList.remove('active')); const t=document.querySelector(`[data-action="${a}"]`); if (t) t.classList.add('active'); }
function deactivateMenuButton(a){ const t=document.querySelector(`[data-action="${a}"]`); if (t) t.classList.remove('active'); }
function openModal(id){
  const action=id.replace('Modal',''); activateMenuButton(action);
  document.getElementById(id).style.display='block';
  if (id==='participantsModal') renderParticipants();
  if (id==='tourpassBoxModal') updateLinksList();
}
function closeModal(id){ const action=id.replace('Modal',''); deactivateMenuButton(action); document.getElementById(id).style.display='none'; }

/* =========================
   6) 참가자/관계도
========================= */
function renderParticipants(){
  const listEl=document.getElementById('participantsList');
  const arr = JSON.parse(localStorage.getItem('mbtiResults')||'[]');
  // 명단에 한정하여 표시
  const onlyWhitelisted = arr.filter(r=> DIRECTORY[r.name]);
  if (onlyWhitelisted.length===0){
    listEl.innerHTML='<div style="text-align:center;color:#666;padding:20px">표시할 참가자 데이터가 없습니다.</div>'; return;
  }
  // 팀/직급 매핑 주입
  const filled = onlyWhitelisted.map(r=>({...r, team: DIRECTORY[r.name].team, position: DIRECTORY[r.name].position}));
  listEl.innerHTML = filled
    .sort((a,b)=> (a.name||'').localeCompare(b.name||'','ko'))
    .map(p=>`
      <div class="participant-item">
        <div class="participant-avatar">${(p.name||'?').substring(0,1)}</div>
        <div>
          <div><strong>${p.name}</strong> ${p.mbtiType?`<span style="color:#111827">[${p.mbtiType}]</span>`:''}</div>
          <div style="font-size:.8em;color:#666">${p.team} ${p.position}</div>
        </div>
      </div>
    `).join('');
}

function mbtiCompatibility(a,b){
  // 간단 매트릭스 + 규칙 가중
  const perfect = {
    ENFP:['INTJ','INFJ'], ENTP:['INTJ','INFJ'],
    INFP:['ENTJ','ENFJ'], INTP:['ENTJ','ENFJ'],
    ENFJ:['INFP','INTP'], ENTJ:['INFP','INTP'],
    INFJ:['ENFP','ENTP'], INTJ:['ENFP','ENTP'],
    ESFP:['ISTJ','ISFJ'], ESTP:['ISTJ','ISFJ'],
    ISFP:['ESTJ','ESFJ'], ISTP:['ESTJ','ESFJ'],
    ESFJ:['ISFP','ISTP'], ESTJ:['ISFP','ISTP'],
    ISFJ:['ESFP','ESTP'], ISTJ:['ESFP','ESTP'],
  };
  if (perfect[a]?.includes(b)) return {score:96, level:'perfect'};
  let s=70;
  if (a[0]!==b[0]) s+=8; else s+=3;
  if (a[1]===b[1]) s+=10; else s-=5;
  if (a[2]!==b[2]) s+=7; else s+=4;
  if (a[3]!==b[3]) s+=6; else s+=2;
  s = Math.max(55, Math.min(95, s));
  const level = s>=95?'perfect':s>=85?'great':s>=70?'good':s>=60?'okay':'challenging';
  return {score:s, level};
}

function showMBTIRelationship(){
  const arr = JSON.parse(localStorage.getItem('mbtiResults')||'[]');
  const me = arr.find(r=> r.email===currentUser.email);
  if (!me){ alert('먼저 MBTI 검사를 완료해주세요.'); return; }

  // 명단에 한정
  const others = arr.filter(r=> r.email!==currentUser.email && DIRECTORY[r.name]);
  if (others.length===0){ alert('관계도를 표시할 데이터가 부족합니다.'); return; }

  // 그룹화
  const buckets = { perfect:[], great:[], good:[], okay:[], challenging:[] };
  others.forEach(o=>{
    const {score, level} = mbtiCompatibility(me.mbtiType, o.mbtiType);
    buckets[level].push({...o, score, team:DIRECTORY[o.name]?.team, position:DIRECTORY[o.name]?.position});
  });

  // 카테고리 설정(색/배경)
  const cats = [
    { key:'perfect', title:'환상의 궁합', emoji:'💖', color:'#ff4d6d', bg:'#ffe3ea' },
    { key:'great', title:'최고의 파트너', emoji:'🌟', color:'#ff8f1f', bg:'#fff0e0' },
    { key:'good', title:'좋은 협력자', emoji:'🤝', color:'#22c55e', bg:'#eaf7ef' },
    { key:'okay', title:'평범한 관계', emoji:'😊', color:'#2563eb', bg:'#e8f0fe' },
    { key:'challenging', title:'성장의 기회', emoji:'💪', color:'#7c3aed', bg:'#efe7ff' },
  ];

  const html = `
    <div class="modal" id="mbtiRelationshipModal" style="display:block">
      <div class="modal-content" style="width:860px;max-width:96%">
        <button class="close-btn" onclick="closeMBTIRelationship()">&times;</button>
        <div class="modal-header">
          <h3>${me.name}님의 MBTI 관계도</h3>
          <p style="color:#111827;font-weight:800;margin-top:6px">당신의 유형: ${me.mbtiType}</p>
        </div>
        <div style="padding:16px 18px 22px">
          ${cats.map(c=>{
            const list = buckets[c.key];
            if (!list || list.length===0) return '';
            return `
              <div class="rel-cat">
                <div class="rel-head" style="background:${c.color}">
                  <span style="font-size:1.1em">${c.emoji}</span> ${c.title} <span style="opacity:.85;margin-left:6px">(${list.length}명)</span>
                </div>
                <div class="rel-box" style="background:${c.bg}">
                  <div class="rel-grid">
                    ${list.sort((a,b)=> b.score-a.score).map(m=>`
                      <div class="rel-card" style="border-left-color:${c.color}">
                        <div class="rel-row">
                          <div>
                            <strong>${m.name}</strong>
                            <div class="muted">${m.team||''} ${m.position||''}</div>
                          </div>
                          <div class="badge">${m.mbtiType}</div>
                        </div>
                        <div class="muted">궁합도: ${m.score}%</div>
                      </div>
                    `).join('')}
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', html);
}
function closeMBTIRelationship(){ const m=document.getElementById('mbtiRelationshipModal'); if (m) m.remove(); }

/* =========================
   7) MBTI 검사
========================= */
const mbtiQuestions = [
  { q:'새로운 사람을 만났을 때', a:[{t:'먼저 다가가 분위기를 주도한다',k:'E'},{t:'상대가 먼저 다가오길 기다린다',k:'I'}]},
  { q:'주말 계획이 취소되었을 때', a:[{t:'새 약속을 잡거나 밖에서 활동',k:'E'},{t:'혼자 쉬며 재충전',k:'I'}]},
  { q:'여행 준비 스타일', a:[{t:'세부 계획을 정리해야 안심',k:'J'},{t:'대략만 정하고 현지에서 유연하게',k:'P'}]},
  { q:'문제 접근', a:[{t:'사실/데이터 기반',k:'S'},{t:'가능성/가정 탐색',k:'N'}]},
  { q:'친구가 힘들 때', a:[{t:'감정 공감 먼저',k:'F'},{t:'해결책 제시 먼저',k:'T'}]},
  { q:'새 프로젝트 참여', a:[{t:'단계별 계획부터',k:'J'},{t:'큰 방향 잡고 즉시 시작',k:'P'}]},
  { q:'회의 중 내 모습', a:[{t:'논리로 토론/반박',k:'T'},{t:'분위기 조율/공감',k:'F'}]},
  { q:'정보 습득', a:[{t:'직접 경험/구체적 사실',k:'S'},{t:'직관/느낌',k:'N'}]},
  { q:'새 동료 입사', a:[{t:'먼저 말을 걸고 친해짐',k:'E'},{t:'필요할 때 도움',k:'I'}]},
  { q:'중요한 선택', a:[{t:'객관/효율',k:'T'},{t:'마음의 편안함',k:'F'}]},
];
function startMBTITest(){
  const arr = JSON.parse(localStorage.getItem('mbtiResults')||'[]');
  const my = arr.find(r=> r.email===currentUser.email);
  if (my){
    if (confirm(`이미 MBTI를 완료했습니다.\n결과: ${my.mbtiType}\n관계도를 보시겠어요?`)){ showMBTIRelationship(); }
    return;
  }
  window.mbtiStartTime = Date.now();
  currentQuestion=0; mbtiAnswers=[]; updateMBTIQuestion(); openModal('mbtiModal');
}
function updateMBTIQuestion(){
  if (currentQuestion>=mbtiQuestions.length){ showMBTIResult(); return; }
  const q = mbtiQuestions[currentQuestion];
  document.getElementById('questionNumber').textContent=`질문 ${currentQuestion+1}/${mbtiQuestions.length}`;
  document.getElementById('questionText').textContent=q.q;
  const box=document.getElementById('answerOptions'); box.innerHTML='';
  q.a.forEach((opt,i)=>{
    const b=document.createElement('button'); b.className='answer-btn'; b.textContent=opt.t; b.onclick=()=>selectAnswer(i); box.appendChild(b);
  });
  document.getElementById('progressBar').style.width=(currentQuestion/mbtiQuestions.length*100)+'%';
  document.getElementById('nextBtn').style.display='none';
}
function selectAnswer(i){
  document.querySelectorAll('.answer-btn').forEach(b=>b.classList.remove('selected'));
  document.querySelectorAll('.answer-btn')[i].classList.add('selected');
  mbtiAnswers[currentQuestion] = mbtiQuestions[currentQuestion].a[i];
  document.getElementById('nextBtn').style.display='inline-block';
}
function nextQuestion(){ currentQuestion++; updateMBTIQuestion(); }
async function showMBTIResult(){
  const c={E:0,I:0,S:0,N:0,T:0,F:0,J:0,P:0};
  mbtiAnswers.forEach(a=>c[a.k]++);
  const type = (c.E>c.I?'E':'I')+(c.S>c.N?'S':'N')+(c.T>c.F?'T':'F')+(c.J>c.P?'J':'P');
  const testDuration = Math.floor((Date.now()-window.mbtiStartTime)/1000);
  try{
    await callGoogleAppsScript({action:'saveMBTIResult',name:currentUser.name,email:currentUser.email,mbtiType:type,answers:mbtiAnswers,testDuration},'POST');
    const arr = JSON.parse(localStorage.getItem('mbtiResults')||'[]').filter(r=> r.email!==currentUser.email);
    arr.push({name:currentUser.name,email:currentUser.email,mbtiType:type,timestamp:new Date().toISOString(),team:currentUser.team,position:currentUser.position});
    localStorage.setItem('mbtiResults', JSON.stringify(arr));
    updateMBTIButtonState();
    alert(`MBTI 검사 완료!\n유형: ${type}`);
    showMBTIRelationship();
  }catch(e){
    const arr = JSON.parse(localStorage.getItem('mbtiResults')||'[]').filter(r=> r.email!==currentUser.email);
    arr.push({name:currentUser.name,email:currentUser.email,mbtiType:type,timestamp:new Date().toISOString(),team:currentUser.team,position:currentUser.position});
    localStorage.setItem('mbtiResults', JSON.stringify(arr));
    updateMBTIButtonState();
    alert(`MBTI: ${type}\n서버 저장 실패(로컬 저장 완료).`);
    showMBTIRelationship();
  }
  closeMBTITest();
}
function updateMBTIButtonState(){
  const arr = JSON.parse(localStorage.getItem('mbtiResults')||'[]');
  const my = arr.find(r=> r.email===currentUser.email);
  const btn=document.querySelector('[data-action="mbti"]'); if (!btn) return;
  if (my){
    btn.querySelector('.menu-title').textContent='MBTI 결과';
    btn.querySelector('.menu-desc').textContent=`완료됨: ${my.mbtiType}`;
    if (!btn.querySelector('.completed-badge')){
      const b=document.createElement('div'); b.className='completed-badge'; b.textContent='✓';
      b.style.cssText='position:absolute;top:6px;right:6px;background:#2ecc71;color:#fff;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:.75em;font-weight:800';
      btn.appendChild(b);
    }
  }
}
function closeMBTITest(){ closeModal('mbtiModal'); }

/* =========================
   8) 설문
========================= */
async function submitWorkshopSurvey(){
  const satisfaction=document.getElementById('satisfaction').value;
  const bestActivity=document.getElementById('bestActivity').value;
  const feedback=document.getElementById('feedback').value;
  if (!bestActivity){ alert('가장 만족했던 활동을 선택해주세요.'); return; }
  try{
    await callGoogleAppsScript({action:'saveSurvey',name:currentUser.name,email:currentUser.email,satisfaction:parseInt(satisfaction,10),feedback,answers:{bestActivity,satisfactionLevel:satisfaction}},'POST');
    alert('설문이 저장되었습니다. 감사합니다!');
  }catch(e){ alert('설문 저장 실패: '+(e.message||e)); }
  closeModal('surveyModal');
}

/* =========================
   9) 일정
========================= */
function openScheduleOptions(){
  activateMenuButton('schedule');
  const html=`
    <div class="modal" id="scheduleOptionsModal" style="display:block">
      <div class="modal-content" style="width:440px">
        <button class="close-btn" onclick="closeScheduleOptions()">&times;</button>
        <div class="modal-header"><h3>워크샵 일정 선택</h3></div>
        <div style="padding:16px">
          <div onclick="openScheduleLink('phase1')" style="display:flex;gap:12px;align-items:center;padding:12px;border:1px solid #eee;border-radius:12px;margin-bottom:12px;cursor:pointer">
            <i class="fas fa-graduation-cap" style="color:#2ecc71;font-size:1.2em"></i><div><div style="font-weight:800">1차 역량강화 워크샵</div></div>
          </div>
          <div onclick="openScheduleLink('phase2')" style="display:flex;gap:12px;align-items:center;padding:12px;border:1px solid #eee;border-radius:12px;margin-bottom:12px;cursor:pointer">
            <i class="fas fa-users" style="color:#111827;font-size:1.2em"></i><div><div style="font-weight:800">2차 소통강화 워크샵(상세)</div></div>
          </div>
          <div onclick="openScheduleLink('phase3')" style="display:flex;gap:12px;align-items:center;padding:12px;border:1px solid #eee;border-radius:12px;cursor:pointer">
            <i class="fas fa-rocket" style="color:#ff8f1f;font-size:1.2em"></i><div><div style="font-weight:800">3차 서밋/엑스포 세미나</div></div>
          </div>
        </div>
      </div>
    </div>`;
  document.body.insertAdjacentHTML('beforeend', html);
}
function closeScheduleOptions(){ const m=document.getElementById('scheduleOptionsModal'); if (m) m.remove(); deactivateMenuButton('schedule'); }
function openScheduleLink(phase){
  const links={ phase1:'https://form.naver.com/response/ktPwJoHoW2VFRo8AUa6yrg', phase2:'detailed', phase3:'https://www.aisummit.co.kr/' };
  if (phase==='phase2') showDetailedSchedule();
  else if (links[phase]) window.open(links[phase],'_blank'); else alert('준비 중입니다.');
  closeScheduleOptions();
}
function showDetailedSchedule(){
  const html=`
    <div class="modal" id="detailedScheduleModal" style="display:block">
      <div class="modal-content" style="width:760px;max-width:96%">
        <button class="close-btn" onclick="closeDetailedSchedule()">&times;</button>
        <div class="modal-header"><h3>2차 소통강화 워크샵 상세일정</h3></div>
        <div style="padding:16px 18px 22px">
          <div style="margin-bottom:16px;background:#f7f7fb;border:1px solid #eee;border-radius:12px;padding:12px">
            <h4 style="margin-bottom:8px;color:#111827">1day</h4>
            <div class="schedule-item"><div class="time">14:50</div><div class="activity">코비 집합</div><div class="location">부여백제마리조트</div></div>
            <div class="schedule-item"><div class="time">15:10</div><div class="activity">체크인 및 방배정</div><div class="location">구드레선식당</div></div>
            <div class="schedule-item"><div class="time">15:50</div><div class="activity">민속의 가람골 탐방</div><div class="location">낙화암/고란사</div></div>
            <div class="schedule-item"><div class="time">18:30</div><div class="activity">저녁식사</div><div class="location">서동한옥</div></div>
          </div>
          <div style="background:#f7f7fb;border:1px solid #eee;border-radius:12px;padding:12px">
            <h4 style="margin-bottom:8px;color:#111827">2day</h4>
            <div class="schedule-item"><div class="time">11:00</div><div class="activity">브리핑 & 점심</div><div class="location">현장</div></div>
            <div class="schedule-item"><div class="time">13:10</div><div class="activity">성과 공유 시간</div><div class="location">세션룸</div></div>
            <div class="schedule-item"><div class="time">14:10</div><div class="activity">마무리</div><div class="location">-</div></div>
          </div>
        </div>
      </div>
    </div>`;
  document.body.insertAdjacentHTML('beforeend', html);
}
function closeDetailedSchedule(){ const m=document.getElementById('detailedScheduleModal'); if (m) m.remove(); }

/* =========================
   10) 투어패스 보관함
========================= */
function showAddLinkForm(){ document.getElementById('addLinkForm').style.display='block'; document.getElementById('linkTitle').focus(); }
function cancelAddLink(){ document.getElementById('addLinkForm').style.display='none'; linkTitle.value=''; linkUrl.value=''; linkPassword.value=''; }
function isValidUrl(s){ try{ new URL(s); return true; }catch{return false;} }
function saveNewLink(){
  const title=linkTitle.value.trim(); const url=linkUrl.value.trim(); const pw=linkPassword.value.trim();
  if (!title){ alert('제목을 입력해주세요.'); return; }
  if (!url || !isValidUrl(url)){ alert('올바른 URL을 입력해주세요.'); return; }
  const links=JSON.parse(localStorage.getItem('tourpassLinks')||'[]');
  links.push({id:Date.now(),title,url,password:pw||null,createdAt:new Date().toISOString()});
  localStorage.setItem('tourpassLinks', JSON.stringify(links)); updateLinksList(); cancelAddLink(); alert('링크가 저장되었습니다!');
}
function updateLinksList(){
  const list=document.getElementById('linksList');
  const links=JSON.parse(localStorage.getItem('tourpassLinks')||'[]');
  if (links.length===0){
    list.innerHTML='<div style="text-align:center;color:#666;padding:28px"><i class="fas fa-inbox" style="font-size:2.2em;margin-bottom:12px"></i><div>저장된 링크가 없습니다.</div></div>'; return;
  }
  list.innerHTML = links.map(l=>`
    <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;border:1px solid #eee;border-radius:12px;margin-bottom:10px">
      <div style="flex:1;min-width:0">
        <div style="font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${l.title}</div>
        <div style="font-size:.82em;color:#666;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${l.url}</div>
      </div>
      <div style="display:flex;gap:6px;margin-left:8px">
        <button onclick="setDefaultTourpass(${l.id})" title="기본설정" style="background:#2ecc71;color:#fff;border:none;border-radius:10px;padding:8px 10px;cursor:pointer;font-size:.82em">기본</button>
        <button onclick="openLink(${l.id})" title="열기" style="background:#111827;color:#fff;border:none;border-radius:10px;padding:8px 10px;cursor:pointer"><i class="fas fa-external-link-alt"></i></button>
      </div>
    </div>`).join('');
}
function openLink(id){ const links=JSON.parse(localStorage.getItem('tourpassLinks')||'[]'); const l=links.find(x=>x.id===id); if (l) window.open(l.url,'_blank'); }
function setDefaultTourpass(id){ localStorage.setItem('defaultTourpass', id); alert('기본 투어패스로 설정되었습니다!'); }
function openTourpassTicket(){
  activateMenuButton('ticket');
  const links=JSON.parse(localStorage.getItem('tourpassLinks')||'[]');
  if (links.length===0){ alert('보관함에 링크를 먼저 추가해주세요.'); deactivateMenuButton('ticket'); return; }
  const def=localStorage.getItem('defaultTourpass'); if (def){ const d=links.find(l=> l.id==def); if (d && confirm(`기본 투어패스를 열까요?\n${d.title}`)){ openLink(d.id); deactivateMenuButton('ticket'); return; } }
  showTourpassSelector(links);
}
function showTourpassSelector(links){
  const html=`
    <div class="modal" id="tourpassSelectorModal" style="display:block">
      <div class="modal-content" style="width:560px;max-width:96%">
        <button class="close-btn" onclick="closeTourpassSelector()">&times;</button>
        <div class="modal-header"><h3>🎫 투어패스 선택</h3></div>
        <div style="padding:16px">
          ${links.map(l=>`
            <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;border:1px solid #eee;border-radius:12px;margin-bottom:10px">
              <div style="min-width:0">
                <div style="font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${l.title}</div>
                <div style="font-size:.82em;color:#666;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${l.url}</div>
              </div>
              <div style="display:flex;gap:6px;margin-left:8px">
                <button onclick="event.stopPropagation(); setDefaultTourpass(${l.id})" style="background:#2ecc71;color:#fff;border:none;border-radius:10px;padding:8px 10px;cursor:pointer;font-size:.8em">기본설정</button>
                <button onclick="event.stopPropagation(); selectTourpass(${l.id})" style="background:#111827;color:#fff;border:none;border-radius:10px;padding:8px 10px;cursor:pointer;font-size:.8em">열기</button>
              </div>
            </div>`).join('')}
        </div>
      </div>
    </div>`;
  document.body.insertAdjacentHTML('beforeend', html);
}
function selectTourpass(id){ openLink(id); closeTourpassSelector(); }
function closeTourpassSelector(){ const m=document.getElementById('tourpassSelectorModal'); if (m) m.remove(); deactivateMenuButton('ticket'); }

/* =========================
   11) 번역(간단)
========================= */
function translateApp(){
  const lang=document.getElementById('languageSelect').value;
  const map={
    ko:{title:'투어패스사업부 2025 워크샵',sub:'TRAVEL SHIFT',login:'이름으로 로그인',online:'온라인',offline:'오프라인',checking:'연결 확인 중...',sync:'동기화: '},
    en:{title:'TourPass BU 2025 Workshop',sub:'TRAVEL SHIFT',login:'Sign in with name',online:'Online',offline:'Offline',checking:'Checking connection...',sync:'Sync: '},
    ja:{title:'ツアーパス事業部 2025 ワークショップ',sub:'TRAVEL SHIFT',login:'名前でログイン',online:'オンライン',offline:'オフライン',checking:'接続確認中...',sync:'同期: '},
    zh:{title:'旅游通行证事业部 2025 研习班',sub:'TRAVEL SHIFT',login:'用姓名登录',online:'在线',offline:'离线',checking:'检查连接中...',sync:'同步: '}
  };
  const t=map[lang]||map.ko;
  document.querySelector('.app-title').textContent=t.title;
  document.querySelector('.app-subtitle').textContent=t.sub;
  const ct=document.getElementById('connectionText').textContent;
  if (/온라인|Online|オンライン|在线/.test(ct)) document.getElementById('connectionText').textContent=t.online;
  else if (/오프라인|Offline|オフライン|离线/.test(ct)) document.getElementById('connectionText').textContent=t.offline;
  else document.getElementById('connectionText').textContent=t.checking;
  document.getElementById('googleLoginBtn').innerHTML=`<i class="fab fa-google"></i> ${t.login}`;
  const ls=document.getElementById('lastSync'); const time=(ls.textContent.split(': ')[1])||'-'; ls.textContent=t.sync+time;
  alert(lang==='ko'?'한국어로 번역되었습니다':lang==='en'?'Translated to English':lang==='ja'?'日本語に翻訳されました':'已翻译为中文');
}

/* =========================
   12) 부팅
========================= */
async function initializeApp(){
  checkConnection();
  const ok=await checkBackendConnection();
  const dot=document.getElementById('connectionDot'); const text=document.getElementById('connectionText');
  if (ok){ dot.className='status-dot status-online'; text.textContent='온라인'; } else { dot.className='status-dot status-offline'; text.textContent='오프라인'; }
  checkLoginStatus();
}
document.addEventListener('DOMContentLoaded', ()=>{
  initializeApp();
  document.getElementById('googleLoginBtn').addEventListener('click', googleLogin);
});
</script>
</body>
</html>
