<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>íˆ¬ì–´íŒ¨ìŠ¤ì‚¬ì—…ë¶€ 2025 ì›Œí¬ìˆ</title>
  <style>
    @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css');

    :root {
      --primary-brand: #1e40af;
      --secondary-brand: #3b82f6;
      --accent-warm: #f59e0b;
      --accent-cool: #06b6d4;
      --text-primary: #0f172a;
      --text-secondary: #475569;
      --text-muted: #64748b;
      --surface-primary: #ffffff;
      --surface-secondary: #f8fafc;
      --surface-elevated: #f1f5f9;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --gradient-brand: linear-gradient(135deg, var(--primary-brand), var(--secondary-brand));
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
      --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.1);
    }

    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Pretendard',-apple-system,BlinkMacSystemFont,'Segoe UI','Malgun Gothic','ë§‘ì€ ê³ ë”•',sans-serif;background:var(--surface-secondary);color:var(--text-primary);line-height:1.7}
    .container{max-width:428px;margin:0 auto;padding:1.5rem;min-height:100vh;transition:filter .25s ease}
    .blurred{filter:blur(6px)}

    .overlay {position: fixed; inset: 0; background: rgba(15,23,42,.45); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(2px);} 
    .overlay-card {background:#fff;border-radius:20px;padding:1.5rem 1.25rem;max-width:420px;width:90%;text-align:center; box-shadow: var(--shadow-xl);} 
    .overlay h2{font-size:1.35rem;margin-bottom:.5rem} 
    .overlay p{color:var(--text-secondary);margin-bottom:1rem}

    .header{text-align:center;margin-bottom:2rem;padding:2.25rem 0}
    .header h1{font-size:2.15rem;font-weight:800;margin-bottom:.25rem}
    .header p{font-size:1.1rem;color:var(--text-secondary)}

    .card{background:var(--surface-primary);border-radius:24px;padding:1.5rem;margin-bottom:1.25rem;box-shadow:var(--shadow-md);border:1px solid rgba(59,130,246,.08)}
    .form-group{margin-bottom:1rem}
    label{display:block;font-weight:600;margin-bottom:.5rem;font-size:.9rem}
    select,input,textarea{width:100%;padding:1rem 1.1rem;border:1.5px solid #e2e8f0;border-radius:16px;font-size:1rem;font-family:inherit}
    select:focus,input:focus,textarea:focus{outline:none;border-color:var(--secondary-brand);box-shadow:0 0 0 3px rgba(59,130,246,.1)}
    .btn{padding:1rem 1.25rem;border:none;border-radius:16px;font-size:1rem;font-weight:700;cursor:pointer;transition:.2s;width:100%}
    .btn-primary{background:var(--gradient-brand);color:#fff}
    .btn-primary:hover{transform:translateY(-1px);box-shadow:var(--shadow-lg)}
    .btn-secondary{background:var(--surface-elevated);color:var(--text-primary)}
    .btn-link{background:#fff;border:1px solid #e2e8f0}
    .btn-ghost{background:transparent;border:1px dashed #cbd5e1;color:var(--text-secondary)}

    .menu-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-top:1rem}
    .menu-item{background:var(--surface-primary);border:1.5px solid rgba(59,130,246,.08);border-radius:20px;padding:1.25rem;text-align:center;cursor:pointer;transition:.3s;text-decoration:none;color:inherit;position:relative}
    .menu-item:hover{transform:translateY(-3px);box-shadow:var(--shadow-xl);border-color:var(--secondary-brand)}
    .menu-title{font-weight:800;font-size:1.05rem;margin-bottom:.35rem;display:flex;gap:.4rem;justify-content:center;align-items:center}
    .menu-desc{font-size:.85rem;color:var(--text-secondary);min-height:1.4em}

    .timer-card{background:var(--gradient-brand);color:#fff;text-align:center}
    .timer-display{font-size:3rem;font-weight:900}

    .user-info{border:1.5px solid rgba(59,130,246,.08);padding:1.25rem;border-radius:20px;margin-bottom:1rem;text-align:center}
    .inline-grid{display:grid;grid-template-columns:1fr 1fr;gap:.6rem;margin-top:.6rem}

    .alert{padding:.85rem;border-radius:16px;margin-bottom:1rem;text-align:center}
    .alert-success{background:rgba(16,185,129,.1);color:#047857;border:1px solid rgba(16,185,129,.25)}
    .alert-error{background:rgba(239,68,68,.1);color:#dc2626;border:1px solid rgba(239,68,68,.25)}
    .hidden{display:none}

    /* Modal */
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:1000;overflow-y:auto}
    .modal-content{background:#fff;margin:50px auto;padding:0;width:90%;max-width:600px;border-radius:24px}
    .modal-header{padding:1.25rem 1.25rem;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center}
    .modal-header h2{margin:0;font-size:1.3rem}
    .close-btn{background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--text-muted)}
    .modal-body{padding:1.25rem}

    /* ì‹¬ë¦¬/ê²°ê³¼ ì¹´ë“œ (ìœ ì§€) */
    .q-card{background:#fff;border:1px solid #e2e8f0;border-radius:16px;padding:1rem;margin-bottom:1rem}
    .q-title{font-weight:800;margin-bottom:.6rem}
    .progress-wrap{display:flex;gap:.25rem;margin:.5rem 0 .75rem}
    .dot{flex:1;height:6px;border-radius:999px;background:#e2e8f0}
    .dot.on{background:linear-gradient(90deg, var(--secondary-brand), #93c5fd)}
    .ox-wrap{display:flex;gap:.6rem}
    .ox-btn{flex:1;border:1.5px solid #e2e8f0;border-radius:14px;padding:0.9rem 1rem;text-align:center;font-weight:800;cursor:pointer}
    .ox-btn:hover{box-shadow:0 0 0 3px rgba(59,130,246,.12);border-color:var(--secondary-brand)}
    .result-badge{display:inline-block;padding:.4rem .7rem;border-radius:999px;background:rgba(59,130,246,.12);color:#1e40af;font-weight:900;font-size:.85rem}

    .kawaii-card{position:relative;background:linear-gradient(180deg,#fff 0%,#f8fbff 100%);border:1.5px solid #e6eeff;border-radius:22px;padding:1.1rem;box-shadow:0 6px 20px rgba(59,130,246,.08)}
    .k-badge{display:inline-block;background:#eef4ff;border:1px dashed #93c5fd;color:#1e40af;border-radius:999px;padding:.35rem .8rem;font-weight:900;font-size:.85rem}
    .k-head{display:flex;gap:.9rem;align-items:center;justify-content:center;margin:.3rem 0 .2rem}
    .k-emoji{font-size:2.2rem;filter:drop-shadow(0 2px 0 rgba(0,0,0,.05))}
    .k-title{font-weight:900;font-size:1.1rem}
    .k-desc{color:var(--text-secondary);text-align:center}
    .k-stickers{display:flex;gap:.4rem;justify-content:center;margin-top:.35rem;font-size:1.1rem}
    .k-tags{display:flex;flex-wrap:wrap;gap:.4rem;justify-content:center;margin:.65rem 0 0}
    .k-tag{background:#fff;border:1px solid #e9eef9;border-radius:999px;padding:.35rem .6rem;font-size:.8rem}
    .k-bars{margin-top:.8rem;display:grid;gap:.45rem}
    .k-bar{background:#eff6ff;border:1px solid #e5edff;border-radius:12px;overflow:hidden;height:8px}
    .k-bar>span{display:block;height:100%;background:linear-gradient(90deg,#93c5fd,#60a5fa)}
    .k-actions{display:grid;grid-template-columns:1fr 1fr;gap:.6rem;margin-top:.9rem}
    .k-tip{font-size:.85rem;color:#6b7280;text-align:center;margin-top:.35rem}

    #confettiCanvas{position:fixed;inset:0;pointer-events:none;z-index:3000;opacity:0;transition:opacity .25s}
    #confettiCanvas.on{opacity:1}
  </style>
</head>
<body>
<div id="blurTarget" class="container">
  <div class="header">
    <h1>íˆ¬ì–´íŒ¨ìŠ¤ì‚¬ì—…ë¶€</h1>
    <p>2025 ì›Œí¬ìˆ</p>
  </div>

  <!-- ë¡œê·¸ì¸ -->
  <div id="loginScreen" class="card">
    <div class="form-group">
      <label for="userName">ì´ë¦„ì„ ì„ íƒí•˜ì„¸ìš”</label>
      <select id="userName" required>
        <option value="">ì´ë¦„ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>
        <option value="ë‚¨ë„í˜„">ë‚¨ë„í˜„</option>
        <option value="ê¹€ìˆ˜ì¸">ê¹€ìˆ˜ì¸</option>
        <option value="ê³ ë‹¤í˜„">ê³ ë‹¤í˜„</option>
        <option value="ì‹¬ì¬í¬">ì‹¬ì¬í¬</option>
        <option value="íŒí‹°ë‹ˆì•ˆ">íŒí‹°ë‹ˆì•ˆ</option>
        <option value="ê¹€í˜„ì² ">ê¹€í˜„ì² </option>
        <option value="ì´ìœ ì§„">ì´ìœ ì§„</option>
        <option value="ì •ì–´ì§„">ì •ì–´ì§„</option>
        <option value="ì¥ì›ì¤€">ì¥ì›ì¤€</option>
        <option value="ê¹€ëŒ€ì§„">ê¹€ëŒ€ì§„</option>
        <option value="ì†í˜„ìš°">ì†í˜„ìš°</option>
        <option value="ì´ì£¼ì•„">ì´ì£¼ì•„</option>
        <option value="ì¥ì€ì§„">ì¥ì€ì§„</option>
      </select>
    </div>
    <div class="form-group">
      <label for="userMBTI">MBTIë¥¼ ì„ íƒí•˜ì„¸ìš”</label>
      <select id="userMBTI" required>
        <option value="">MBTIë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</option>
        <option>INTJ</option><option>INTP</option><option>ENTJ</option><option>ENTP</option>
        <option>INFJ</option><option>INFP</option><option>ENFJ</option><option>ENFP</option>
        <option>ISTJ</option><option>ISFJ</option><option>ESTJ</option><option>ESFJ</option>
        <option>ISTP</option><option>ISFP</option><option>ESTP</option><option>ESFP</option>
      </select>
    </div>
    <button class="btn btn-primary" id="loginBtn">ë¡œê·¸ì¸</button>
  </div>

  <!-- ë©”ì¸ -->
  <div id="mainScreen" class="hidden">
    <div class="user-info">
      <h3 id="userNameDisplay"></h3>
      <p id="userTeamDisplay"></p>
      <div class="inline-grid">
        <button class="btn btn-link" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
        <button class="btn btn-primary" id="startBtn">ì›Œí¬ìˆ ì°¸ì—¬í•˜ê¸°</button>
      </div>
    </div>

    <div class="card timer-card">
      <div style="font-size:1.05rem;margin-bottom:.6rem;opacity:.9;">ì›Œí¬ìˆ ë‚¨ì€ ì‹œê°„</div>
      <div id="timerDisplay" class="timer-display">48:00:00</div>
    </div>

    <div class="menu-grid">
      <a class="menu-item" id="relationMenu" href="#" target="_blank" rel="noopener">
        <div class="menu-title">ğŸ”— MBTI ê´€ê³„ë„</div>
        <div class="menu-desc">ìƒí˜¸ ê¶í•© ë³´ê¸°</div>
      </a>

      <div class="menu-item" id="scheduleMenu">
        <div class="menu-title">ğŸ—“ï¸ ì›Œí¬ìˆ ì¼ì •</div>
        <div class="menu-desc">í”„ë¡œê·¸ë¨</div>
      </div>

      <!-- íˆ¬ì–´íŒ¨ìŠ¤ í‹°ì¼“ (ë³´ê´€í•¨ ê°œëª…) -->
      <div class="menu-item" id="vaultMenu" tabindex="0">
        <div class="menu-title">ğŸ“ íˆ¬ì–´íŒ¨ìŠ¤ í‹°ì¼“ <button id="ticketConfigOpen" class="btn btn-ghost" style="width:auto;padding:.25rem .5rem;font-size:.8rem;margin-left:.3rem">ë§í¬ ì„¤ì •</button></div>
        <div class="menu-desc" id="vaultDesc">í‹°ì¼“ ì„ íƒ í›„ ë°”ë¡œ ì´ë™</div>
      </div>

      <!-- ë§Œì¡±ë„ ì„¤ë¬¸ -->
      <div class="menu-item" id="surveyMenu">
        <div class="menu-title">ğŸ“ ë§Œì¡±ë„ ì„¤ë¬¸</div>
        <div class="menu-desc">ë°”ë¡œ ì°¸ì—¬</div>
      </div>

      <!-- ë°ì¼ë¦¬ í¬ì¶˜ -->
      <div class="menu-item" id="fortuneMenu">
        <div class="menu-title">ğŸ”® ë°ì¼ë¦¬ í¬ì¶˜</div>
        <div class="menu-desc">ì˜¤ëŠ˜ì˜ ìš´ì„¸</div>
      </div>

      <!-- íˆ¬ì–´íŒ¨ìŠ¤ v3 ì´ˆì•ˆ (ê¸°ì¡´ ìœ ì§€) -->
      <div class="menu-item" id="tpv3Menu">
        <div class="menu-title">ğŸ§© íˆ¬ì–´íŒ¨ìŠ¤ v3 ì´ˆì•ˆ</div>
        <div class="menu-desc">í”„ë¡œí† íƒ€ì…</div>
      </div>

      <!-- ëª¨ë°”ì¼í‹°ì¼“ v3 (ì‹ ê·œ ë²„íŠ¼) -->
      <div class="menu-item" id="mtv3Menu">
        <div class="menu-title">ğŸ“± ëª¨ë°”ì¼í‹°ì¼“ v3</div>
        <div class="menu-desc">ë§í¬ ì¤€ë¹„ ì¤‘</div>
      </div>

      <!-- AI ì±—ë´‡ -->
      <a class="menu-item" id="aiMenu" href="#" target="_blank" rel="noopener">
        <div class="menu-title">ğŸ¤– AI ì±—ë´‡</div>
        <div class="menu-desc">ì›Œí¬ìˆ ì „ìš© í—¬í¼</div>
      </a>
    </div>
  </div>

  <!-- ì•Œë¦¼ -->
  <div id="alertMessage" class="hidden"></div>
</div>

<!-- íƒ€ì´ë¨¸ ì¢…ë£Œ ì˜¤ë²„ë ˆì´ -->
<div id="overlay" class="overlay">
  <div class="overlay-card">
    <h2>ì›Œí¬ìˆì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤</h2>
    <p>ì„¤ë¬¸ì„ ì§„í–‰í•´ ì£¼ì„¸ìš”.</p>
    <button class="btn btn-primary" id="openSurveyFromOverlay">ì„¤ë¬¸ ì‹œì‘í•˜ê¸°</button>
  </div>
</div>

<!-- MBTI ëª¨ë‹¬(ë³´ì¡´) -->
<div id="mbtiModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ì°¸ê°€ì í˜„í™©</h2>
      <button class="close-btn" data-close="mbtiModal">&times;</button>
    </div>
    <div class="modal-body">
      <div class="stats-grid">
        <div class="card"><div class="q-title">ì´ ì°¸ê°€ì</div><div id="totalParticipants" style="font-size:1.6rem;font-weight:900;color:var(--primary-brand)">0</div></div>
        <div class="card"><div class="q-title">í˜„ì¬ ì ‘ì†</div><div id="onlineCount" style="font-size:1.6rem;font-weight:900;color:var(--primary-brand)">0</div></div>
      </div>
      <h3>MBTI ë¶„í¬</h3>
      <div class="mbti-grid" id="mbtiDistribution"></div>
      <div style="margin-top:1rem;display:flex;gap:.6rem;">
        <a id="relationBtn" href="#" class="btn btn-link" target="_blank" rel="noopener">MBTI ê´€ê³„ë„ ë³´ê¸°</a>
      </div>
    </div>
  </div>
</div>

<!-- íˆ¬ì–´íŒ¨ìŠ¤ í‹°ì¼“(ì‚¬ì „ í‹°ì¼“ ì„ íƒ/ì´ë™) -->
<div id="vaultModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>íˆ¬ì–´íŒ¨ìŠ¤ í‹°ì¼“</h2>
      <button class="close-btn" data-close="vaultModal">&times;</button>
    </div>
    <div class="modal-body">
      <div class="card">
        <div class="q-title" style="display:flex;justify-content:space-between;align-items:center;">
          <span>ì‚¬ì „ ë“±ë¡ í‹°ì¼“ ì„ íƒ</span>
          <div style="display:flex;gap:.4rem">
            <button class="btn btn-link" id="vaultClearBtn" style="width:auto;padding:.5rem .8rem">ì„ íƒ í•´ì œ</button>
            <button class="btn btn-ghost" id="ticketConfigOpen2" style="width:auto;padding:.5rem .8rem">ë§í¬ ì„¤ì •</button>
          </div>
        </div>
        <div id="presetList"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:.6rem;margin-top:.8rem;">
          <button class="btn btn-primary" id="savePresetBtn">ì„ íƒ ì €ì¥</button>
          <button class="btn btn-secondary" id="goPresetBtn">ì €ì¥ ì—†ì´ ì´ë™</button>
        </div>
        <div class="k-tip" id="currentChoiceTip" style="margin-top:.5rem;text-align:center;"></div>
      </div>
    </div>
  </div>
</div>

<!-- í‹°ì¼“ ë§í¬ ì„¤ì • ëª¨ë‹¬ -->
<div id="ticketConfigModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>í‹°ì¼“ ë§í¬ ì„¤ì •</h2>
      <button class="close-btn" data-close="ticketConfigModal">&times;</button>
    </div>
    <div class="modal-body">
      <div class="q-card">
        <div class="q-title">ì½”ë“œ 9403</div>
        <input id="cfg_9403" placeholder="ì˜ˆ: https://..." />
      </div>
      <div class="q-card">
        <div class="q-title">ì½”ë“œ 8027</div>
        <input id="cfg_8027" placeholder="ì˜ˆ: https://..." />
      </div>
      <div class="q-card">
        <div class="q-title">ì½”ë“œ 1402</div>
        <input id="cfg_1402" placeholder="ì˜ˆ: https://..." />
      </div>
      <div class="inline-grid" style="margin-top:.6rem">
        <button class="btn btn-primary" id="saveTicketConfig">ì €ì¥</button>
        <button class="btn btn-secondary" data-close="ticketConfigModal">ë‹«ê¸°</button>
      </div>
      <p class="k-tip" style="margin-top:.5rem">ì…ë ¥ê°’ì€ ì´ ë¸Œë¼ìš°ì €ì˜ ë¡œì»¬ì— ì €ì¥ë©ë‹ˆë‹¤.</p>
    </div>
  </div>
</div>

<!-- ë°ì¼ë¦¬ í¬ì¶˜ ëª¨ë‹¬ -->
<div id="fortuneModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ë°ì¼ë¦¬ í¬ì¶˜</h2>
      <button class="close-btn" data-close="fortuneModal">&times;</button>
    </div>
    <div class="modal-body" id="fortuneBody"></div>
  </div>
</div>

<!-- íˆ¬ì–´íŒ¨ìŠ¤ v3 ì´ˆì•ˆ ëª¨ë‹¬ (URL ì—†ì„ ë•Œ) -->
<div id="tpv3Modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>íˆ¬ì–´íŒ¨ìŠ¤ v3 ì´ˆì•ˆ</h2>
      <button class="close-btn" data-close="tpv3Modal">&times;</button>
    </div>
    <div class="modal-body">
      <div class="card">
        <div class="q-title">í”„ë¡œí† íƒ€ì… ì¤€ë¹„ ì¤‘</div>
        <p style="color:var(--text-secondary)">ì™¸ë¶€ URLì´ ì„¤ì •ë˜ë©´ ë°”ë¡œ ì´ë™í•©ë‹ˆë‹¤. í˜„ì¬ëŠ” ê°„ë‹¨ ìš”ì•½ë§Œ ë³´ì—¬ë“œë ¤ìš”.</p>
      </div>
      <div class="card">
        <div class="q-title">í•µì‹¬ ì²´í¬ë¦¬ìŠ¤íŠ¸</div>
        <ul style="padding-left:1rem; color:var(--text-secondary); line-height:1.9">
          <li>QR ì¸ì¦ UX: ìŠ¤ìº” â†’ ê²°ê³¼ í”¼ë“œë°± 1ì´ˆ ë‚´</li>
          <li>ê°€ë§¹ì  ì•ˆë‚´: ëŒ€ê¸°/í˜¼ì¡ë„, ì¶”ì²œ ì½”ìŠ¤, ìš´ì˜ì‹œê°„</li>
          <li>ì™¸êµ­ì–´ ëŒ€ì‘: ë‹¤êµ­ì–´ ìë™ê°ì§€ + ê°„í¸ ì „í™˜</li>
          <li>ì¿ í°/í˜œíƒ: ë‚¨ì€ì‹œê°„Â·ì”ì—¬í˜œíƒ ì‹¤ì‹œê°„ í‘œì‹œ</li>
          <li>ì ‘ê·¼ì„±: í°íŠ¸/ëŒ€ë¹„/í„°ì¹˜ ì˜ì—­ ìµœì í™”</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<script>
  /***** ì„¤ì • *****/
  const API_URL = 'https://script.google.com/macros/s/AKfycbxP7oI1CUK7vvga2HJbUp6r_U5bOsFWwFzcIAhIrRjKfCbUf7Mwlu56Ayqa3EokUJXz/exec';
  const RELATION_URL = 'https://kim950106.github.io/tour/';
  const AI_CHATBOT_URL = 'https://chatgpt.com/g/g-689acc0b7bd08191bb31112e0a19cffc-tueopaeseu-saeobjeanseo-ai-eosiseunteu';
  const TPV3_URL = ''; // v3 ì´ˆì•ˆ ì™¸ë¶€ ë§í¬ (ì˜ˆ: 'https://your-prototype-url')
  const MOBILE_TICKET_V3_URL = ''; // ì‹ ê·œ: ëª¨ë°”ì¼í‹°ì¼“ v3 ë§í¬ (ì˜ˆ: 'https://your-mobile-v3')

  // ê¸°ë³¸ í‹°ì¼“ ì •ì˜ (URLì€ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ì£¼ì…)
  const DEFAULT_TICKETS = [
    { code: '9403', name: '9403', url: '' },
    { code: '8027', name: '8027', url: '' },
    { code: '1402', name: '1402', url: '' }
  ];

  /***** ìƒíƒœ *****/
  let currentUser = null;
  let sessionId = null;
  let timerInterval = null;
  let timerRunning = false;
  let workshopEndAt = null;

  const TEMP_USER_DATA = {
    "ë‚¨ë„í˜„": { team:"íˆ¬ì–´íŒ¨ìŠ¤ì‚¬ì—…ë¶€", position:"ì´ì‚¬" },
    "ê¹€ìˆ˜ì¸": { team:"íˆ¬ì–´íŒ¨ìŠ¤ì‚¬ì—…ë¶€ ì˜ì—… 1íŒ€", position:"íŒ€ì¥" },
    "ê³ ë‹¤í˜„": { team:"íˆ¬ì–´íŒ¨ìŠ¤ì‚¬ì—…ë¶€ ì˜ì—… 1íŒ€", position:"ì‚¬ì›" },
    "ì‹¬ì¬í¬": { team:"íˆ¬ì–´íŒ¨ìŠ¤ì‚¬ì—…ë¶€ ì˜ì—… 1íŒ€", position:"ë§¤ë‹ˆì €" },
    "íŒí‹°ë‹ˆì•ˆ": { team:"íˆ¬ì–´íŒ¨ìŠ¤ì‚¬ì—…ë¶€ ì˜ì—… 1íŒ€", position:"ë§¤ë‹ˆì €" },
    "ê¹€í˜„ì² ": { team:"íˆ¬ì–´íŒ¨ìŠ¤ì‚¬ì—…ë¶€ ì˜ì—… 2íŒ€", position:"íŒ€ì¥" },
    "ì´ìœ ì§„": { team:"íˆ¬ì–´íŒ¨ìŠ¤ì‚¬ì—…ë¶€ ì˜ì—… 2íŒ€", position:"ì‚¬ì›" },
    "ì •ì–´ì§„": { team:"íˆ¬ì–´íŒ¨ìŠ¤ì‚¬ì—…ë¶€ ì˜ì—… 2íŒ€", position:"ì‚¬ì›" },
    "ì¥ì›ì¤€": { team:"íˆ¬ì–´íŒ¨ìŠ¤ì‚¬ì—…ë¶€ ì˜ì—… 2íŒ€", position:"ì‚¬ì›" },
    "ê¹€ëŒ€ì§„": { team:"íˆ¬ì–´íŒ¨ìŠ¤ì‚¬ì—…ë¶€ ì˜ì—… 2íŒ€", position:"íŒ€ì¥" },
    "ì†í˜„ìš°": { team:"íˆ¬ì–´íŒ¨ìŠ¤ì‚¬ì—…ë¶€ ì˜ì—… 2íŒ€", position:"ëŒ€ë¦¬" },
    "ì´ì£¼ì•„": { team:"íˆ¬ì–´íŒ¨ìŠ¤ì‚¬ì—…ë¶€ ì˜ì—… 2íŒ€", position:"ì£¼ì„" },
    "ì¥ì€ì§„": { team:"íˆ¬ì–´íŒ¨ìŠ¤ì‚¬ì—…ë¶€ ì˜ì—… 2íŒ€", position:"ì£¼ì„" }
  };

  /***** ìœ í‹¸ *****/
  function escapeHtml(s=''){
    return String(s)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#39;');
  }

  function showAlert(message, type='success') {
    const alert = document.getElementById('alertMessage');
    alert.className = 'alert ' + (type === 'error' ? 'alert-error' : 'alert-success');
    alert.textContent = message;
    alert.classList.remove('hidden');
    setTimeout(() => alert.classList.add('hidden'), 2500);
  }

  function fmt(ms){
    const total = Math.max(0, Math.floor(ms/1000));
    const h = String(Math.floor(total/3600)).padStart(2,'0');
    const m = String(Math.floor((total%3600)/60)).padStart(2,'0');
    const s = String(total%60).padStart(2,'0');
    return `${h}:${m}:${s}`;
  }

  function normalizeUrl(u=''){
    let url = (u||'').trim();
    if (!url) return '';
    if (!/^https?:\/\//i.test(url)) url = 'https://' + url;
    return url;
  }

  // confetti
  function confettiBurst(ms=1200){
    let c = document.getElementById('confettiCanvas');
    if(!c){
      c = document.createElement('canvas');
      c.id = 'confettiCanvas';
      document.body.appendChild(c);
    }
    const ctx = c.getContext('2d');
    const dpr = window.devicePixelRatio || 1;
    c.width = innerWidth * dpr;
    c.height = innerHeight * dpr;
    ctx.scale(dpr,dpr);
    const n=120, parts=[];
    for(let i=0;i<n;i++){
      parts.push({x: Math.random()*innerWidth, y: -20-Math.random()*100, r: 3+Math.random()*4, vx: -1+Math.random()*2, vy: 2+Math.random()*2, a: Math.random()*Math.PI, col: `hsl(${Math.random()*360},90%,65%)`});
    }
    c.classList.add('on');
    const t0 = performance.now();
    (function tick(t){
      const dt = (t-(tick.t||t))/16; tick.t=t;
      ctx.clearRect(0,0,innerWidth,innerHeight);
      parts.forEach(p=>{
        p.x+=p.vx*dt; p.y+=p.vy*dt; p.a+=0.1*dt;
        ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.a);
        ctx.fillStyle=p.col; ctx.fillRect(-p.r,-p.r,p.r*2,p.r*2);
        ctx.restore();
      });
      if(t-t0 < ms) requestAnimationFrame(tick); else {
        c.classList.remove('on'); ctx.clearRect(0,0,innerWidth,innerHeight);
      }
    })(t0);
  }

  // ì‹œë“œ RNG (í¬ì¶˜ìš©)
  function seededRng(seedStr='seed'){
    let t = 0; for (let i=0;i<seedStr.length;i++) t = (t * 31 + seedStr.charCodeAt(i)) >>> 0;
    return function(){
      t = (t + 0x6D2B79F5) >>> 0; let r = Math.imul(t ^ (t>>>15), 1 | t);
      r ^= r + Math.imul(r ^ (r>>>7), 61 | r);
      return ((r ^ (r>>>14)) >>> 0) / 4294967296;
    }
  }
  function pick(rng, arr){ return arr[Math.floor(rng()*arr.length)] }

  /***** API *****/
  async function apiRequest(action, data = {}) {
    try {
      const res = await fetch(API_URL, {
        method: 'POST', headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action, sessionId, ...data })
      });
      if (!res.ok) return { success: false, error: `HTTP ${res.status}` };
      return await res.json();
    } catch (e) { return { success: false, error: e.message }; }
  }

  /***** ë¡œê·¸ì¸/ë©”ì¸ *****/
  async function handleLogin() {
    const userName = document.getElementById('userName').value;
    const userMBTI = document.getElementById('userMBTI').value;
    if (!userName || !userMBTI) return showAlert('ì´ë¦„ê³¼ MBTIë¥¼ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”','error');
    currentUser = userName;
    sessionId = 'session_' + Date.now();
    const userInfo = TEMP_USER_DATA[userName];
    const res = await apiRequest('login', { userName, mbti: userMBTI, team: userInfo.team, position: userInfo.position });
    if (!res.success) return showAlert('ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + (res.error || ''), 'error');

    localStorage.setItem('currentUser', userName);
    localStorage.setItem('userMBTI', userMBTI);
    localStorage.setItem('sessionId', sessionId);

    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainScreen').classList.remove('hidden');
    document.getElementById('userNameDisplay').textContent = currentUser;
    document.getElementById('userTeamDisplay').textContent = `${userInfo.team} | ${userInfo.position}`;

    showAlert(`í™˜ì˜í•©ë‹ˆë‹¤, ${currentUser}ë‹˜!`);

    const storedEnd = localStorage.getItem('workshopEndAt');
    if (storedEnd) beginTimerInterval();
    updateVaultDesc();
  }

  async function handleLogout() {
    if (!currentUser) return location.reload();
    if (!confirm('ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    await apiRequest('updateUserStatus', { userName: currentUser, status: 'offline' });
    localStorage.removeItem('workshopEndAt');
    if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
    timerRunning = false;
    localStorage.clear();
    location.reload();
  }

  /***** íƒ€ì´ë¨¸ *****/
  function startTimer() {
    const stored = localStorage.getItem('workshopEndAt');
    if (stored) { showAlert('ì´ë¯¸ ì¹´ìš´íŠ¸ë‹¤ìš´ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.'); beginTimerInterval(); return; }
    const endTs = Date.now() + 48*60*60*1000;
    localStorage.setItem('workshopEndAt', String(endTs));
    workshopEndAt = new Date(endTs);
    beginTimerInterval();
    showAlert('ì¹´ìš´íŠ¸ë‹¤ìš´ì„ ì‹œì‘í•©ë‹ˆë‹¤.');
  }

  function beginTimerInterval(){
    if (timerRunning) return;
    const stored = localStorage.getItem('workshopEndAt');
    if (!stored) return;
    workshopEndAt = new Date(parseInt(stored, 10));
    timerRunning = true;
    const btn = document.getElementById('startBtn');
    if (btn){ btn.disabled = true; btn.textContent = 'ì¹´ìš´íŠ¸ë‹¤ìš´ ì§„í–‰ ì¤‘'; }
    function tick(){
      const remain = workshopEndAt - Date.now();
      document.getElementById('timerDisplay').textContent = fmt(remain);
      if (remain <= 0) {
        clearInterval(timerInterval); timerInterval = null; timerRunning = false;
        localStorage.removeItem('workshopEndAt');
        if (btn){ btn.disabled = false; btn.textContent = 'ì›Œí¬ìˆ ì°¸ì—¬í•˜ê¸°'; }
        endFlow();
      }
    }
    tick();
    timerInterval = setInterval(tick, 1000);
  }

  function endFlow(){
    document.getElementById('blurTarget').classList.add('blurred');
    document.getElementById('overlay').style.display = 'flex';
    openSurvey();
  }

  /***** MBTI í†µê³„(ë³´ì¡´) *****/
  async function loadMBTIStats() {
    document.getElementById('mbtiModal').style.display = 'block';
    const res = await apiRequest('getMBTIStats');
    if (!res.success) return showAlert('í†µê³„ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤','error');
    document.getElementById('totalParticipants').textContent = res.totalParticipants || 0;
    document.getElementById('onlineCount').textContent = res.onlineUsers || 0;

    const grid = document.getElementById('mbtiDistribution');
    grid.innerHTML = '';
    const all = ['INTJ','INTP','ENTJ','ENTP','INFJ','INFP','ENFJ','ENFP','ISTJ','ISFJ','ESTJ','ESFJ','ISTP','ISFP','ESTP','ESFP'];
    all.forEach(t=>{
      const c = (res.mbtiDistribution && res.mbtiDistribution[t]) || 0;
      const el = document.createElement('div');
      el.className = 'mbti-item';
      if (c>0){ el.style.background='rgba(59,130,246,.1)'; el.style.borderColor='var(--secondary-brand)'; }
      el.innerHTML = `<div class="mbti-type">${t}</div><div class="mbti-count">${c}</div>`;
      grid.appendChild(el);
    });

    const btn = document.getElementById('relationBtn');
    btn.href = RELATION_URL ? RELATION_URL : '#';
    if (!RELATION_URL) btn.textContent = 'MBTI ê´€ê³„ë„ (URL ì¤€ë¹„ ì¤‘)';
  }

  /***** íˆ¬ì–´íŒ¨ìŠ¤ í‹°ì¼“ - ë§í¬ ì„¤ì •/ì„ íƒ/ì´ë™ *****/
  function getPresetTickets(){
    const t9403 = localStorage.getItem('ticket_url_9403') || '';
    const t8027 = localStorage.getItem('ticket_url_8027') || '';
    const t1402 = localStorage.getItem('ticket_url_1402') || '';
    return [
      { code:'9403', name:'9403', url:t9403 },
      { code:'8027', name:'8027', url:t8027 },
      { code:'1402', name:'1402', url:t1402 }
    ];
  }

  function getSelectedTicketCode(){ return localStorage.getItem('selectedTicketCode') || ''; }
  function setSelectedTicketCode(code){ localStorage.setItem('selectedTicketCode', code || ''); updateVaultDesc(); }
  function findTicketByCode(code){ return getPresetTickets().find(t => t.code === code); }

  function updateVaultDesc(){
    const desc = document.getElementById('vaultDesc');
    const code = getSelectedTicketCode();
    if (!code) { desc.textContent = 'í‹°ì¼“ ì„ íƒ í›„ ë°”ë¡œ ì´ë™'; return; }
    const t = findTicketByCode(code);
    if (t && t.url) desc.textContent = `ì„ íƒë¨: ${t.code} Â· ë§í¬ ì„¤ì •ë¨`;
    else if (t && !t.url) desc.textContent = `ì„ íƒë¨: ${t.code} Â· (ë§í¬ ë¯¸ì„¤ì •)`;
    else desc.textContent = 'í‹°ì¼“ ì„ íƒ í›„ ë°”ë¡œ ì´ë™';
  }

  function renderPresetList(){
    const wrap = document.getElementById('presetList');
    const selected = getSelectedTicketCode();
    const tickets = getPresetTickets();
    wrap.innerHTML = tickets.map(t=>{
      const checked = t.code === selected ? 'checked' : '';
      const urlText = t.url ? escapeHtml(t.url) : '(ë§í¬ ë¯¸ì„¤ì •)';
      return `
        <label class="q-card" style="display:flex;align-items:center;gap:.8rem;cursor:pointer">
          <input type="radio" name="presetTicket" value="${t.code}" ${checked} style="width:18px;height:18px">
          <div>
            <div class="q-title">ì½”ë“œ ${t.code}</div>
            <div style="color:var(--text-secondary)">${urlText}</div>
          </div>
        </label>`;
    }).join('');
    document.getElementById('currentChoiceTip').textContent = selected ? `í˜„ì¬ ì„ íƒ: ${selected}` : 'ì•„ì§ ì„ íƒëœ í‹°ì¼“ì´ ì—†ìŠµë‹ˆë‹¤.';
  }

  function openVaultModal(){ renderPresetList(); document.getElementById('vaultModal').style.display = 'block'; }

  function gotoSelectedTicket(){
    const code = getSelectedTicketCode();
    const t = findTicketByCode(code);
    if (!t) { openVaultModal(); showAlert('ë¨¼ì € í‹°ì¼“ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error'); return; }
    if (!t.url) { showAlert('ì„ íƒí•œ í‹°ì¼“ì˜ ë§í¬ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. "ë§í¬ ì„¤ì •"ì—ì„œ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error'); openVaultModal(); return; }
    window.open(normalizeUrl(t.url), '_blank', 'noopener');
  }

  // ë§í¬ ì„¤ì • ëª¨ë‹¬ ì±„ìš°ê¸°/ì €ì¥
  function openTicketConfig(){
    document.getElementById('cfg_9403').value = localStorage.getItem('ticket_url_9403') || '';
    document.getElementById('cfg_8027').value = localStorage.getItem('ticket_url_8027') || '';
    document.getElementById('cfg_1402').value = localStorage.getItem('ticket_url_1402') || '';
    document.getElementById('ticketConfigModal').style.display = 'block';
  }
  function saveTicketConfig(){
    const u9403 = document.getElementById('cfg_9403').value.trim();
    const u8027 = document.getElementById('cfg_8027').value.trim();
    const u1402 = document.getElementById('cfg_1402').value.trim();
    if (u9403) localStorage.setItem('ticket_url_9403', u9403); else localStorage.removeItem('ticket_url_9403');
    if (u8027) localStorage.setItem('ticket_url_8027', u8027); else localStorage.removeItem('ticket_url_8027');
    if (u1402) localStorage.setItem('ticket_url_1402', u1402); else localStorage.removeItem('ticket_url_1402');
    showAlert('ë§í¬ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    document.getElementById('ticketConfigModal').style.display = 'none';
    renderPresetList();
    updateVaultDesc();
  }

  /***** ì„¤ë¬¸ *****/
  function openSurvey(){ document.getElementById('surveyModal')?.classList.add('show') || (document.getElementById('surveyModal') && (document.getElementById('surveyModal').style.display='block')); }

  /***** ì‹¬ë¦¬í…ŒìŠ¤íŠ¸ (ìœ ì§€) *****/
  const psyQuestions = [
    { t:'ìƒˆë¡œìš´ ì¥ì†Œë¥¼ ë³´ë©´ ê³„íš ì—†ì´ë„ ë°”ë¡œ ë“¤ì–´ê°€ ë³¸ë‹¤.', axis:'E' },
    { t:'ì—¬í–‰ì€ ì´˜ì´˜í•œ ì¼ì •í‘œê°€ ìˆì–´ì•¼ ë§ˆìŒì´ í¸í•˜ë‹¤.', axis:'J' },
    { t:'ë©”ë‰´ ê³ ë¥¼ ë•Œ ì§ê´€ì ìœ¼ë¡œ ëŒë¦¬ëŠ” ê±¸ ê³ ë¥¸ë‹¤.', axis:'N' },
    { t:'í• ì¸/í˜œíƒì„ ê¼¼ê¼¼íˆ ë”°ì ¸ë³¸ ë’¤ ê²°ì •í•œë‹¤.', axis:'S' },
    { t:'íŒ€ ì˜ê²¬ì„ ì¡°ìœ¨í•˜ëŠ” ì—­í• ì„ ìì—°ìŠ¤ëŸ½ê²Œ ë§¡ëŠ”ë‹¤.', axis:'E' },
    { t:'ì¦‰í¥ ì œì•ˆì—ë„ ë¶€ë‹´ ì—†ì´ â€œê°€ì!â€ë¼ê³  ë§í•œë‹¤.', axis:'P' },
    { t:'ì‚¬ì§„ë³´ë‹¤ ìˆœê°„ì˜ ê°ì •ì´ ë” ì¤‘ìš”í•˜ë‹¤ê³  ëŠë‚€ë‹¤.', axis:'F' },
    { t:'ë¬¸ì œê°€ ìƒê¸°ë©´ ì¼ë‹¨ ì›ì¸ë¶€í„° ë¶„ì„í•œë‹¤.', axis:'T' },
    { t:'ì‚¬ëŒ ë§ì€ ê³³ì—ì„œ ì—ë„ˆì§€ë¥¼ ì–»ëŠ”ë‹¤.', axis:'E' },
    { t:'ê³„íšì´ ë°”ë€Œë©´ ê¸ˆë°© ëŒ€ì•ˆì„ ë– ì˜¬ë¦°ë‹¤.', axis:'P' },
  ];
  function axisOpp(a){ return ({E:'I', I:'E', S:'N', N:'S', T:'F', F:'T', J:'P', P:'J'})[a] }
  let psyIdx = 0, psyScore = {E:0,I:0,S:0,N:0,T:0,F:0,J:0,P:0};
  function renderPsyProgress(){ const wrap = document.getElementById('psyProgress'); if(!wrap) return; wrap.innerHTML = ''; for(let i=0;i<psyQuestions.length;i++){ const d = document.createElement('div'); d.className = 'dot' + (i<psyIdx ? ' on' : ''); wrap.appendChild(d); } }
  function renderPsyQuestion(){ const qc = document.getElementById('psyQuestionCard'); if(!qc) return; document.getElementById('psyResult')?.classList.add('hidden'); qc.classList.remove('hidden'); renderPsyProgress(); const q = psyQuestions[psyIdx]; const qt = document.getElementById('psyQuestionText'); if(qt) qt.textContent = `${psyIdx+1}. ${q.t}`; }
  function finishPsy(){ const e = psyScore.E >= psyScore.I ? 'E':'I'; const s = psyScore.S >= psyScore.N ? 'S':'N'; const t = psyScore.T >= psyScore.F ? 'T':'F'; const j = psyScore.J >= psyScore.P ? 'J':'P'; let type='íƒí—˜ê°€', headline='ìƒˆë¡œì›€ì„ ì¦ê¸°ëŠ” íƒí—˜ê°€'; if (j==='J' && t==='T') { type='ê³„íšê°€'; headline='ì²´ê³„ë¡œ ì„±ê³¼ ë§Œë“œëŠ” ê³„íšê°€'; } else if (e==='E' && psyScore.P>psyScore.J) { type='ë„ì „ê°€'; headline='ì¦‰í¥ ì—ë„ˆì§€ ê°€ë“í•œ ë„ì „ê°€'; } else if (psyScore.F>psyScore.T && psyScore.N>psyScore.S) { type='ê°ì„±ê°€'; headline='ìŠ¤í† ë¦¬ì— ëª°ì…í•˜ëŠ” ê°ì„±ê°€'; }
    const descMap = { 'íƒí—˜ê°€':'ì§€ê¸ˆ ë‚´ ë§ˆìŒì´ ê°€ëŠ” ê³³ì´ ì§€ë„ì…ë‹ˆë‹¤. ê°€ë²¼ìš´ ì—¬ìœ ì™€ ê¹œì§ ìŠ¤íŒŸì´ í–‰ë³µì„ í¬ê²Œ í‚¤ì›Œì¤˜ìš”.', 'ë„ì „ê°€':'â€œê°€ë³´ì!â€ê°€ ìì—°ìŠ¤ëŸ¬ìš´ íƒ€ì…. ì•¡í‹°ë¹„í‹°ì™€ ì¦‰í¥ ë¯¸ì…˜ì´ ì˜¤ëŠ˜ì˜ ìŠ¤íŒŒí¬ë¥¼ ì¼œìš”.', 'ê³„íšê°€':'íƒ€ì„ë¼ì¸Â·ì˜ˆì‚°Â·ë™ì„ ê¹Œì§€ ì‹¹! ê¹”ë”í•œ í™”ë©´ê³¼ ì²´í¬ë¦¬ìŠ¤íŠ¸ê°€ ìµœê³ ì˜ ë¬´ê¸°.', 'ê°ì„±ê°€':'í•œ ì¥ì˜ ì‚¬ì§„, í•œ ëª¨ê¸ˆì˜ ê³µê¸°. ìŠ¤í† ë¦¬í…”ë§ ì½”ìŠ¤ì™€ êµ¿ì¦ˆê°€ ë§ˆìŒì— ì°©â€”.' };
    const typeEl = document.getElementById('psyType'); if(typeEl) typeEl.textContent = type;
    const emoEl = document.getElementById('psyEmoji'); if(emoEl) emoEl.textContent = {'íƒí—˜ê°€':'ğŸ§­âœ¨','ë„ì „ê°€':'ğŸš€ğŸ”¥','ê³„íšê°€':'ğŸ“’ğŸ§©','ê°ì„±ê°€':'ğŸ€ğŸŒ¸'}[type];
    const headEl = document.getElementById('psyHeadline'); if(headEl) headEl.textContent = headline;
    const descEl = document.getElementById('psyDesc'); if(descEl) descEl.textContent = descMap[type];
    const stickers = Array.from({length:3}, ()=> ['âœ¨','ğŸŒŸ','ğŸ€','ğŸˆ','ğŸ§ƒ','ğŸ­','ğŸ«§','ğŸŒˆ','ğŸ’«','ğŸ©µ'][Math.floor(Math.random()*10)]);
    const stEl = document.getElementById('psyStickers'); if(stEl) stEl.innerHTML = stickers.join(' ');
    const explore = Math.round((psyScore.E+psyScore.P) / (psyScore.E+psyScore.P+psyScore.I+psyScore.J) * 100) || 40;
    const plan = Math.round((psyScore.J+psyScore.S) / (psyScore.J+psyScore.S+psyScore.P+psyScore.N) * 100) || 40;
    const story = Math.round((psyScore.F+psyScore.N) / (psyScore.F+psyScore.N+psyScore.T+psyScore.S) * 100) || 40;
    const b1 = document.getElementById('barExplore'); if(b1) b1.style.width = Math.min(100,Math.max(10,explore))+'%';
    const b2 = document.getElementById('barPlan'); if(b2) b2.style.width = Math.min(100,Math.max(10,plan))+'%';
    const b3 = document.getElementById('barStory'); if(b3) b3.style.width = Math.min(100,Math.max(10,story))+'%';
    document.getElementById('psyQuestionCard')?.classList.add('hidden');
    document.getElementById('psyResult')?.classList.remove('hidden');
    confettiBurst();
  }
  function resetPsy(){ psyIdx = 0; psyScore = {E:0,I:0,S:0,N:0,T:0,F:0,J:0,P:0}; renderPsyQuestion(); }

  /***** ë°ì¼ë¦¬ í¬ì¶˜ *****/
  function openFortune(){
    const name = currentUser || 'ê²ŒìŠ¤íŠ¸';
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth()+1).padStart(2,'0');
    const dd = String(today.getDate()).padStart(2,'0');
    const seed = `${name}-${yyyy}${mm}${dd}`;
    const rng = seededRng(seed);

    const grade = ['â˜…â˜…â˜…â˜…â˜…','â˜…â˜…â˜…â˜…â˜†','â˜…â˜…â˜…â˜†â˜†','â˜…â˜…â˜†â˜†â˜†','â˜…â˜†â˜†â˜†â˜†'];
    const advices = [ 'ì‘ê²Œ ì‹œì‘í•˜ë©´ í¬ê²Œ ëŒì•„ì˜µë‹ˆë‹¤.', 'ê³¼ê°íˆ ëœì–´ë‚´ë©´ ì†ë„ê°€ ë‚©ë‹ˆë‹¤.', 'íƒ€ì´ë°ì€ ì§€ê¸ˆ! ë¯¸ë£¨ì§€ ë§ê¸°.', 'ì‚¬ëŒì„ ë¨¼ì € ì±™ê¸°ë©´ ì¼ì´ í’€ë¦½ë‹ˆë‹¤.', 'ë°ì´í„°ê°€ ë‹µ. ê°ë³´ë‹¤ ìˆ˜ì¹˜ í™•ì¸.' ];
    const areas = ['ì „ì²´ìš´','ì—°ì• ìš´','ê¸ˆì „ìš´','ê±´ê°•ìš´','ì—…ë¬´/í•™ì—…'];
    const colors = ['ë„¤ì´ë¹„','ì½”ë°œíŠ¸ ë¸”ë£¨','ë¯¼íŠ¸','ì˜ë¡œ','ì½”ë„','ë¼ì¼ë½','í™”ì´íŠ¸','ë¸”ë™'];
    const items = ['í…€ë¸”ëŸ¬','ìš°ì‚°','ë³¼íœ','ë…¸íŠ¸','í‚¤ë§','ì¹´ë“œì§€ê°‘','ì–‘ë§','ìŠ¤ì¹´í”„'];
    const places = ['ì¹´í˜ ì°½ê°€','ê°•ë³€ ì‚°ì±…ë¡œ','ë„ì„œê´€','ì‘ì€ ì„œì ','ê³µì› ë²¤ì¹˜','ë°•ë¬¼ê´€','ì „ë§ëŒ€','ì‹œì¥ ê³¨ëª©'];
    const mbti = ['INTJ','INTP','ENTJ','ENTP','INFJ','INFP','ENFJ','ENFP','ISTJ','ISFJ','ESTJ','ESFJ','ISTP','ISFP','ESTP','ESFP'];

    function secBlock(title){
      const g = pick(rng, grade);
      const tip = pick(rng, advices);
      return `<div class="card"><div class="q-title">${title} <span style="float:right">${g}</span></div><div style="color:var(--text-secondary)">${tip}</div></div>`;
    }

    const luckyNumber = Math.floor(rng()*99)+1;
    const luckyColor = pick(rng, colors);
    const luckyItem = pick(rng, items);
    const luckyPlace = pick(rng, places);
    const luckyMBTI = pick(rng, mbti);

    const body = `
      <div class="card" style="text-align:center">
        <div class="result-badge">ì˜¤ëŠ˜ (${yyyy}.${mm}.${dd})</div>
        <h3 style="margin:.5rem 0 .25rem;">${name}ë‹˜ì˜ ë°ì¼ë¦¬ í¬ì¶˜</h3>
        <p style="color:var(--text-secondary)">í•˜ë£¨ ë™ì•ˆ ë™ì¼í•˜ê²Œ ìœ ì§€ë©ë‹ˆë‹¤.</p>
      </div>
      ${areas.map(secBlock).join('')}
      <div class="card" style="display:grid;grid-template-columns:1fr 1fr;gap:.6rem;">
        <div><div class="q-title">ëŸ­í‚¤ ë„˜ë²„</div><div>${luckyNumber}</div></div>
        <div><div class="q-title">ëŸ­í‚¤ ì»¬ëŸ¬</div><div>${luckyColor}</div></div>
        <div><div class="q-title">ëŸ­í‚¤ ì•„ì´í…œ</div><div>${luckyItem}</div></div>
        <div><div class="q-title">ëŸ­í‚¤ ì¥ì†Œ</div><div>${luckyPlace}</div></div>
        <div style="grid-column:1/3"><div class="q-title">ê¶í•© MBTI</div><div>${luckyMBTI}</div></div>
      </div>`;

    const el = document.getElementById('fortuneBody');
    el.innerHTML = body;
    document.getElementById('fortuneModal').style.display = 'block';
  }

  /***** ì´ˆê¸°í™” & ì´ë²¤íŠ¸ *****/
  document.addEventListener('DOMContentLoaded', () => {
    // ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ/ì°¸ì—¬
    document.getElementById('loginBtn').addEventListener('click', handleLogin);
    document.getElementById('logoutBtn').addEventListener('click', handleLogout);
    document.getElementById('startBtn').addEventListener('click', startTimer);

    // ê´€ê³„ë„
    const relationMenu = document.getElementById('relationMenu');
    relationMenu.addEventListener('click', (e)=>{
      const ready = !!RELATION_URL;
      if (!ready) { e.preventDefault(); showAlert('MBTI ê´€ê³„ë„ ë§í¬ê°€ ì•„ì§ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.','error'); }
      else { relationMenu.setAttribute('href', RELATION_URL); relationMenu.setAttribute('target', '_blank'); }
    });

    // ì¼ì •
    document.getElementById('scheduleMenu').addEventListener('click', ()=> document.getElementById('scheduleModal')?.classList.add('show') || (document.getElementById('scheduleModal') && (document.getElementById('scheduleModal').style.display='block')));

    // íˆ¬ì–´íŒ¨ìŠ¤ í‹°ì¼“: í´ë¦­=ì´ë™, ë¡±í”„ë ˆìŠ¤=ë³€ê²½
    const vault = document.getElementById('vaultMenu');
    let pressTimer=null; const longPressMs = 700;
    vault.addEventListener('mousedown', ()=>{ pressTimer = setTimeout(()=>{ openVaultModal(); }, longPressMs); });
    vault.addEventListener('touchstart', ()=>{ pressTimer = setTimeout(()=>{ openVaultModal(); }, longPressMs); }, {passive:true});
    ['mouseup','mouseleave','touchend','touchcancel'].forEach(ev=> vault.addEventListener(ev, ()=>{
      if (pressTimer){ clearTimeout(pressTimer); pressTimer=null; gotoSelectedTicket(); }
    }, {passive:true}));

    // ë³´ê´€í•¨ ëª¨ë‹¬ ë²„íŠ¼
    document.getElementById('savePresetBtn').addEventListener('click', ()=>{
      const chosen = document.querySelector('input[name="presetTicket"]:checked');
      if (!chosen) { showAlert('í‹°ì¼“ì„ ì„ íƒí•´ì£¼ì„¸ìš”','error'); return; }
      setSelectedTicketCode(chosen.value);
      showAlert('ì„ íƒì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
      document.getElementById('vaultModal').style.display='none';
      gotoSelectedTicket();
    });
    document.getElementById('goPresetBtn').addEventListener('click', ()=>{
      const chosen = document.querySelector('input[name="presetTicket"]:checked');
      if (!chosen) { showAlert('í‹°ì¼“ì„ ì„ íƒí•´ì£¼ì„¸ìš”','error'); return; }
      const t = findTicketByCode(chosen.value);
      if (!t.url) { showAlert('ì„ íƒí•œ í‹°ì¼“ì˜ ë§í¬ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.','error'); return; }
      window.open(normalizeUrl(t.url), '_blank', 'noopener');
    });
    document.getElementById('vaultClearBtn').addEventListener('click', ()=>{ setSelectedTicketCode(''); showAlert('ì„ íƒì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤'); updateVaultDesc(); });

    // í‹°ì¼“ ë§í¬ ì„¤ì • ì—´ê¸°/ì €ì¥
    document.getElementById('ticketConfigOpen').addEventListener('click', (e)=>{ e.stopPropagation(); openTicketConfig(); });
    document.getElementById('ticketConfigOpen2').addEventListener('click', openTicketConfig);
    document.getElementById('saveTicketConfig').addEventListener('click', saveTicketConfig);

    // ì„¤ë¬¸
    document.getElementById('surveyMenu').addEventListener('click', openSurvey);
    document.getElementById('openSurveyFromOverlay').addEventListener('click', ()=>{ document.getElementById('surveyModal')?.classList.add('show') || (document.getElementById('surveyModal') && (document.getElementById('surveyModal').style.display='block')); });

    // ë°ì¼ë¦¬ í¬ì¶˜
    document.getElementById('fortuneMenu').addEventListener('click', openFortune);

    // íˆ¬ì–´íŒ¨ìŠ¤ v3 ì´ˆì•ˆ
    document.getElementById('tpv3Menu').addEventListener('click', ()=>{
      if (TPV3_URL && TPV3_URL.trim().length > 0) { window.open(TPV3_URL, '_blank', 'noopener'); }
      else { document.getElementById('tpv3Modal').style.display = 'block'; }
    });

    // ëª¨ë°”ì¼í‹°ì¼“ v3 (ì‹ ê·œ)
    document.getElementById('mtv3Menu').addEventListener('click', ()=>{
      if (MOBILE_TICKET_V3_URL && MOBILE_TICKET_V3_URL.trim().length > 0) { window.open(MOBILE_TICKET_V3_URL, '_blank', 'noopener'); }
      else { showAlert('ëª¨ë°”ì¼í‹°ì¼“ v3 ë§í¬ê°€ ì•„ì§ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.','error'); }
    });

    // AI ì±—ë´‡
    const ai = document.getElementById('aiMenu');
    ai.href = AI_CHATBOT_URL;

    // ê³µí†µ: ëª¨ë‹¬ ë‹«ê¸° & ì™¸ë¶€ í´ë¦­ ë‹«ê¸°
    document.querySelectorAll('.close-btn').forEach(btn=>{
      btn.addEventListener('click', function(){
        const id = this.getAttribute('data-close');
        if (id) document.getElementById(id).style.display='none';
        else this.closest('.modal').style.display='none';
      })
    });
    window.addEventListener('click', e=>{ if (e.target.classList && e.target.classList.contains('modal')) e.target.style.display='none'; });

    // ì„¸ì…˜ ë³µì›
    const savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
      currentUser = savedUser; sessionId = localStorage.getItem('sessionId');
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('mainScreen').classList.remove('hidden');
      const info = TEMP_USER_DATA[currentUser] || {team:'', position:''};
      document.getElementById('userNameDisplay').textContent = currentUser;
      document.getElementById('userTeamDisplay').textContent = `${info.team} | ${info.position}`;
    }

    // íƒ€ì´ë¨¸ ìë™ ë³µì› + ë¼ë²¨ ì—…ë°ì´íŠ¸
    const storedEnd = localStorage.getItem('workshopEndAt');
    if (storedEnd) beginTimerInterval();
    updateVaultDesc();
  });
</script>
</body>
</html>
