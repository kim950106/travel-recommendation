<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>íˆ¬ì–´íŒ¨ìŠ¤ì‚¬ì—…ë¶€ 2025 ì›Œí¬ìˆ</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" rel="stylesheet">
<style>
  :root{
    --brand-1:#1e3a8a;        /* ë³´ì¡° ë„¤ì´ë¹„(íƒ€ì´í‹€) */
    --brand-2:#e97357;        /* ë©”ì¸ í¬ì¸íŠ¸(ì²¨ë¶€ìƒ‰) */
    --brand-3:#f08b68;        /* ë³´ì¡° í¬ì¸íŠ¸(ê·¸ë¼ë°ì´ì…˜ ìƒë‹¨) */
    --text:#0f172a; --muted:#64748b; --line:#e2e8f0;
  }
  body{
    font-family:'Pretendard',sans-serif;
    background:linear-gradient(180deg,#fff6f2 0%,#ffffff 100%);
    min-height:100vh;
    color:var(--text);
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:start;
    padding:2rem 1rem 4rem
  }
  .header{text-align:center;margin-bottom:1.1rem}
  .header h1{font-weight:800;font-size:1.8rem;color:var(--brand-1)}
  .header p{color:#94a3b8}
  .card{
    background:#fff;
    border-radius:1.25rem;
    box-shadow:0 8px 24px rgba(0,0,0,.08);
    padding:1.5rem;
    width:100%;
    max-width:420px;
    margin-bottom:1rem;
    transition:.25s
  }
  .card:hover{transform:translateY(-2px)}
  label{
    display:block;
    font-weight:600;
    font-size:.9rem;
    color:#334155;
    margin-bottom:.35rem
  }
  select,input{
    width:100%;
    border:1px solid var(--line);
    border-radius:.9rem;
    padding:.85rem 1rem;
    background:#f9fafb;
    transition:.2s
  }
  select:focus,input:focus{
    background:#fff;
    border-color:var(--brand-3);
    box-shadow:0 0 0 3px rgba(240,139,104,.22);
    outline:0
  }
  .btn{
    display:inline-block;
    width:100%;
    border-radius:.9rem;
    font-weight:800;
    padding:.9rem;
    text-align:center;
    transition:.25s
  }
  .btn-primary{
    background:linear-gradient(90deg,var(--brand-2),var(--brand-3));
    color:#fff;
    box-shadow:0 4px 14px rgba(233,115,87,.28)
  }
  .btn-primary:hover{
    background:linear-gradient(90deg,#df6444,var(--brand-2));
    transform:translateY(-1px)
  }
  .btn-outline{
    background:#fff;
    border:1px solid var(--line);
    color:var(--brand-1)
  }
  .menu-grid{
    display:grid;
    grid-template-columns:repeat(2,1fr);
    gap:.9rem
  }
  .menu-item{
    border:1px solid var(--line);
    border-radius:1rem;
    background:#fff;
    padding:1rem;
    text-align:center;
    color:#0f172a;
    font-weight:700;
    box-shadow:0 2px 8px rgba(0,0,0,.04);
    cursor:pointer;
    transition:.25s
  }
  .menu-item:hover{
    background:#fff7f4;
    border-color:var(--brand-3);
    transform:translateY(-2px)
  }
  .timer-box{
    background:linear-gradient(90deg,var(--brand-2),var(--brand-3));
    color:#fff;
    border-radius:1rem;
    padding:1rem;
    text-align:center;
    box-shadow:0 6px 16px rgba(233,115,87,.28);
    user-select:none
  }
  .timer-display{font-size:2rem;font-weight:900}
  .logout{max-width:420px;margin-top:.9rem}

  /* ê²Œì´íŠ¸ */
  #mainScreen.gated .menu-grid{filter:blur(3px);pointer-events:none}
  #gatedNote{display:none;text-align:center;color:var(--muted);margin:.4rem 0 -.2rem}
  #gatedNote.on{display:block}

  /* ëª¨ë‹¬ ê³µí†µ */
  .modal{
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.55);
    z-index:50;
    align-items:center;
    justify-content:center;
    padding:1rem
  }
  .modal-content{
    background:#fff;
    border-radius:1rem;
    max-width:600px;
    width:100%;
    max-height:85vh;
    overflow:auto;
    padding:1rem 1.1rem
  }
  .modal-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:.6rem
  }
  .close{
    border:0;
    background:transparent;
    font-size:1.6rem;
    color:#94a3b8;
    cursor:pointer
  }

  /* ì•Œë¦¼ */
  #alertMessage{
    position:fixed;
    bottom:16px;
    left:50%;
    transform:translateX(-50%);
    background:var(--brand-2);
    color:#fff;
    padding:.7rem 1rem;
    border-radius:.7rem;
    box-shadow:0 3px 10px rgba(0,0,0,.15);
    opacity:0;
    transition:.25s;
    z-index:60
  }
  #alertMessage.show{opacity:1}

  /* ì‹¬ë¦¬í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì¹´ë“œ(ì˜¤ë Œì§€ í†¤) */
  #psyResultCard{animation:fadeIn .45s ease forwards;}
  @keyframes fadeIn{
    from{opacity:0;transform:translateY(10px)}
    to{opacity:1;transform:translateY(0)}
  }
  .psy-card{
    background:#fff;
    border-radius:1rem;
    box-shadow:0 6px 18px rgba(0,0,0,.08);
    padding:1.2rem;
    text-align:center;
    margin-top:1rem
  }
  .psy-title{
    font-weight:900;
    font-size:1.15rem;
    color:#ffffff;
    background:linear-gradient(90deg,var(--brand-2),var(--brand-3));
    border-radius:.75rem;
    padding:.5rem 1rem;
    display:inline-block;
    margin-top:.35rem
  }
  .psy-desc{
    background:#fff7f4;
    border:1px dashed #f3b39d;
    border-radius:.9rem;
    padding:.8rem;
    margin-top:.8rem;
    color:#6b7280;
    line-height:1.55
  }
  .psy-tags{
    display:flex;
    flex-wrap:wrap;
    gap:.4rem;
    justify-content:center;
    margin-top:.6rem
  }
  .psy-tags span{
    background:#ffe0d6;
    color:#8a4b38;
    border:1px solid #ffc6b6;
    border-radius:9999px;
    padding:.2rem .7rem;
    font-size:.8rem
  }
</style>
</head>
<body>

  <div class="header">
    <h1>íˆ¬ì–´íŒ¨ìŠ¤ì‚¬ì—…ë¶€</h1>
    <p>2025 ì›Œí¬ìˆ</p>
  </div>

  <!-- ë¡œê·¸ì¸ -->
  <div id="loginScreen" class="card">
    <div class="mb-4">
      <label>ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”</label>
      <input
        id="userName"
        type="text"
        placeholder="ì´ë¦„ì„ 2~4ê¸€ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”."
      />
    </div>
    <div class="mb-4">
      <label>MBTIë¥¼ ì„ íƒí•˜ì„¸ìš”</label>
      <select id="userMBTI">
        <option value="">MBTIë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</option>
        <option>ENTJ</option><option>ENFJ</option><option>ENFP</option><option>ENTP</option>
        <option>ESTJ</option><option>ESFJ</option><option>ESFP</option><option>ESTP</option>
        <option>INTJ</option><option>INFJ</option><option>INFP</option><option>INTP</option>
        <option>ISTJ</option><option>ISFJ</option><option>ISFP</option><option>ISTP</option>
      </select>
    </div>
    <button id="loginBtn" class="btn btn-primary mt-3">ë¡œê·¸ì¸</button>
  </div>

  <!-- ë©”ì¸ -->
  <div id="mainScreen" class="hidden">
    <div class="card text-center">
      <div style="font-size:1.3rem;font-weight:800;color:var(--brand-1)" id="userNameDisplay">-</div>
      <div style="color:var(--muted)" id="userTeamDisplay">íˆ¬ì–´íŒ¨ìŠ¤ì‚¬ì—…ë¶€</div>
      <div class="flex gap-2 mt-3">
        <button id="logoutBtn" class="btn btn-outline">ë¡œê·¸ì•„ì›ƒ</button>
        <button id="startBtn" class="btn btn-primary">ì›Œí¬ìˆ ì°¸ì—¬í•˜ê¸°</button>
      </div>
      <div id="gatedNote">ğŸ”’ ì•„ë˜ ë©”ë‰´ëŠ” <b>â€œì›Œí¬ìˆ ì°¸ì—¬í•˜ê¸°â€</b> ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì—´ë¦½ë‹ˆë‹¤.</div>
    </div>

    <div class="timer-box w-full max-w-md mb-3" id="timerBox" title="ê¸¸ê²Œ ëˆ„ë¥´ë©´ ì°¸ì—¬ ì´ì „ ìƒíƒœë¡œ ë˜ëŒë¦¬ê¸°">
      <div class="text-sm opacity-90">ì›Œí¬ìˆ ë‚¨ì€ ì‹œê°„</div>
      <div id="timerDisplay" class="timer-display">48:00:00</div>
    </div>

    <div class="card">
      <!-- ë©”ë‰´ ìˆœì„œ -->
      <div class="menu-grid">
        <div class="menu-item" id="menuMbti">ğŸ”— MBTI ê´€ê³„ë„</div>
        <div class="menu-item" id="menuDraft">ğŸ“± íšŒì‚¬ì†Œê°œì„œ ë°›ê¸°</div>
        <!-- í‹°ì¼“v3 ì´ˆì•ˆ ì œê±° -->
        <div class="menu-item" id="menuSchedule">ğŸ“… ì›Œí¬ìˆ ì¼ì •</div>
        <div class="menu-item" id="menuFortune">ğŸ”® ë°ì¼ë¦¬ í¬ì¶˜</div>
        <div class="menu-item" id="menuAI">ğŸ¤– AI ì±—ë´‡</div>
        <div class="menu-item" id="menuPsy">ğŸ§  ì‹¬ë¦¬í…ŒìŠ¤íŠ¸</div>
        <!-- ì›Œí¬ìˆìë£Œ ë²„íŠ¼ ì œê±° -->
      </div>
    </div>

    <button id="menuSurvey" class="btn btn-primary max-w-md">ë§Œì¡±ë„ ì¡°ì‚¬</button>
    <button class="btn btn-outline logout">ë¡œê·¸ì•„ì›ƒ</button>
  </div>

  <!-- ë°ì¼ë¦¬ í¬ì¶˜ -->
  <div id="fortuneModal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h3>ë°ì¼ë¦¬ í¬ì¶˜</h3><button class="close" data-close="fortuneModal">Ã—</button></div>
      <div id="fortuneBody"></div>
    </div>
  </div>

  <!-- ì‹¬ë¦¬í…ŒìŠ¤íŠ¸ -->
  <div id="psyModal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h3>O/X ì‹¬ë¦¬í…ŒìŠ¤íŠ¸ (5ë¬¸í•­)</h3><button class="close" data-close="psyModal">Ã—</button></div>
      <div id="psyStep">
        <div class="text-sm text-gray-500" id="psyTitle">1/5</div>
        <div id="psyQuestion" class="mt-1 mb-3"></div>
        <div class="grid grid-cols-2 gap-2">
          <button class="btn btn-primary" id="btnO">O (ê·¸ë ‡ë‹¤)</button>
          <button class="btn btn-outline" id="btnX">X (ì•„ë‹ˆë‹¤)</button>
        </div>
      </div>
      <div id="psyResult" class="hidden">
        <div id="psyResultCard" class="psy-card max-w-md mx-auto">
          <div style="font-size:2.2rem" id="resEmoji">ğŸ¦Š</div>
          <div class="psy-title" id="resTitle">ë˜‘ë˜‘í•œ ì—¬ìš°í˜• ë¦¬ë”</div>
          <div class="psy-desc" id="resDesc">ë…¼ë¦¬ì ì´ì§€ë§Œ ë”°ëœ»í•œ í†µì°°ì„ ê°€ì§„ ì¶”ì§„í˜• ë¦¬ë”</div>
          <div class="psy-tags" id="resTags"></div>
          <div class="mt-3"><button class="btn btn-outline" id="psyRetry">ë‹¤ì‹œ í•˜ê¸°</button></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ì›Œí¬ìˆ ì¼ì • -->
  <div id="scheduleModal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h3>ì›Œí¬ìˆ ì¼ì •</h3><button class="close" data-close="scheduleModal">Ã—</button></div>
      <div id="scheduleBody"></div>
    </div>
  </div>

  <!-- ë§Œì¡±ë„ ì¡°ì‚¬ -->
  <div id="surveyModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>ì›Œí¬ìˆ ë§Œì¡±ë„ ì¡°ì‚¬</h3>
        <button class="close" data-close="surveyModal">Ã—</button>
      </div>

      <form id="surveyForm">
        <div class="border border-gray-200 rounded-lg p-3 mb-3">
          <div class="font-bold mb-2">1) ì „ì²´ ë§Œì¡±ë„ (5ì  ë§Œì )</div>
          <div class="grid grid-cols-5 gap-2 text-center">
            <label><input type="radio" name="satisfaction" value="1" required> 1</label>
            <label><input type="radio" name="satisfaction" value="2"> 2</label>
            <label><input type="radio" name="satisfaction" value="3"> 3</label>
            <label><input type="radio" name="satisfaction" value="4"> 4</label>
            <label><input type="radio" name="satisfaction" value="5"> 5</label>
          </div>
        </div>

        <div class="border border-gray-200 rounded-lg p-3 mb-3">
          <div class="font-bold mb-2">2) ê°€ì¥ ë§Œì¡±í–ˆë˜ í™œë™</div>
          <select id="bestProgram" class="w-full border border-gray-200 rounded-lg p-2">
            <option value="">ì„ íƒí•´ì£¼ì„¸ìš”</option>
            <option>ìˆ™ì†Œ</option><option>ìŒì‹</option><option>ì„±ê³¼ ë° ì¶”ì§„ë³´ê³ </option>
            <option>ììœ ì‹œê°„</option><option>ì•„ë¡œë§ˆ ë§Œë“¤ê¸°</option><option>ë„ìŠ¨íŠ¸ íˆ¬ì–´</option>
            <option>íšŒì‹ ì´ë²¤íŠ¸</option><option>ê¸°íƒ€(ì•„ë˜ ì§ì ‘ì…ë ¥)</option>
          </select>
          <input id="bestProgramEtc" class="w-full border border-gray-200 rounded-lg p-2 mt-2" placeholder="ê¸°íƒ€ ì„ íƒ ì‹œ ì…ë ¥ (ì„ íƒ)" />
        </div>

        <div class="border border-gray-200 rounded-lg p-3 mb-3">
          <div class="font-bold mb-2">3) ê°œì„  ìš”ì²­ ì‚¬í•­</div>
          <textarea id="improve" rows="4" class="w-full border border-gray-200 rounded-lg p-2" placeholder="ì˜ˆ) ì¼ì • ê°„ê²©, ì´ë™ ë™ì„ , í”„ë¡œê·¸ë¨ ì¶”ê°€ ë“±"></textarea>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <button type="button" class="btn btn-outline" data-close="surveyModal">ë‹«ê¸°</button>
          <button type="submit" class="btn btn-primary">ì œì¶œí•˜ê¸°</button>
        </div>
        <p class="text-sm text-gray-500 mt-2">â€» ì œì¶œ ì¦‰ì‹œ ë°±ì—”ë“œ(GAS)ì— ì €ì¥ë©ë‹ˆë‹¤.</p>
      </form>

      <div id="surveyDone" class="hidden">
        <div class="text-center">
          <div style="font-size:2rem">ğŸ‰</div>
          <div class="font-bold text-lg mt-1">ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤!</div>
        </div>
        <div id="surveySummary" class="border border-gray-200 rounded-lg p-3 mt-3 text-sm text-gray-600"></div>
        <button class="btn btn-primary mt-3" data-close="surveyModal">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- íšŒì‚¬ì†Œê°œì„œ ë°›ê¸° ëª¨ë‹¬ -->
  <div id="brochureModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>íšŒì‚¬ì†Œê°œì„œ ë°›ê¸°</h3>
        <button class="close" data-close="brochureModal">Ã—</button>
      </div>
      <div class="mb-3 text-sm text-gray-600">
        ì´ë©”ì¼ì„ ì…ë ¥í•˜ì‹œë©´ íˆ¬ì–´íŒ¨ìŠ¤ ì‚¬ì—…ì†Œê°œì„œë¥¼ ìë™ìœ¼ë¡œ ë³´ë‚´ë“œë¦½ë‹ˆë‹¤.
      </div>
      <div class="mb-3">
        <label>ì´ë©”ì¼ ì£¼ì†Œ</label>
        <input
          id="brochureEmail"
          type="email"
          class="w-full border border-gray-200 rounded-lg p-2"
          placeholder="example@company.com"
        />
      </div>
      <div class="grid grid-cols-2 gap-2">
        <button type="button" class="btn btn-outline" data-close="brochureModal">ì·¨ì†Œ</button>
        <button type="button" class="btn btn-primary" id="brochureSendBtn">ë³´ë‚´ê¸°</button>
      </div>
      <p class="text-xs text-gray-400 mt-2">
        â€» ì…ë ¥í•˜ì‹  ì´ë©”ì¼ì€ íšŒì‚¬ì†Œê°œì„œ ë°œì†¡ ë° í†µê³„ ìš©ë„ë¡œë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤.
      </p>
    </div>
  </div>

  <div id="alertMessage"></div>

<script>
/* ====== CONFIG ====== */
const API_URL = "https://script.google.com/macros/s/AKfycbxP7oI1CUK7vvga2HJbUp6r_U5bOsFWwFzcIAhIrRjKfCbUf7Mwlu56Ayqa3EokUJXz/exec";
const RELATION_URL = "https://kim950106.github.io/tour/";
const AI_CHATBOT_URL = "https://opal.withgoogle.com/?flow=drive:/1tNBoV8E0pmfhYOkX7trfcCGnZeHi-XPD&shared&mode=app";

/* ====== STATE ====== */
let currentUser="", sessionId="", workshopEndAt=null, timerInterval=null;
let serverSyncInterval=null;

/* ====== UTILS ====== */
async function apiRequest(action, payload={}){
  try{
    const r = await fetch(API_URL,{
      method:'POST',
      headers:{'Content-Type':'text/plain;charset=utf-8'}, // CORS preflight íšŒí”¼
      body: JSON.stringify({ action, ...payload })
    });
    return await r.json();
  }catch(e){ return {success:false,error:String(e)} }
}

function toast(msg,type="info",ms=2000){
  const el=document.getElementById('alertMessage');
  el.textContent=msg;
  el.style.background = type==="error"?"#ef4444":type==="success"?"#10b981":"var(--brand-2)";
  el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'),ms);
}
function normalizeUrl(u){ return /^https?:\/\//i.test(u)?u:'https://'+u; }
function fmt(ms){
  const t=Math.max(0,Math.floor(ms/1000));
  const h=String(Math.floor(t/3600)).padStart(2,'0');
  const m=String(Math.floor((t%3600)/60)).padStart(2,'0');
  const s=String(t%60).padStart(2,'0');
  return `${h}:${m}:${s}`;
}
async function track(event,meta={}){ try{ await apiRequest('trackEvent',{sessionId,userName:currentUser,event,meta}); }catch(_){} }

/* ====== GATE & TIMER ====== */
function applyGate(){
  document.getElementById('mainScreen').classList.add('gated');
  document.getElementById('gatedNote').classList.add('on');
}
function clearGate(){
  document.getElementById('mainScreen').classList.remove('gated');
  document.getElementById('gatedNote').classList.remove('on');
}

/* ì°¸ì—¬ ì‹œì‘(ì„œë²„ ìš°ì„ , ì‹¤íŒ¨ ì‹œ ë¡œì»¬ 48ì‹œê°„ìœ¼ë¡œ ê°•í–‰) */
async function beginTimer(){
  if(!currentUser || !sessionId){
    toast('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”','error');
    return;
  }

  // ê¸°ë³¸ê°’: ë¡œì»¬ 48ì‹œê°„
  let endTs = Date.now() + 48*60*60*1000;

  try{
    const rsp = await apiRequest('startWorkshop', {
      sessionId,
      userName: currentUser,
      durationHours: 48
    });
    if (rsp && rsp.success && rsp.endAt) {
      endTs = Number(rsp.endAt); // ì„œë²„ ê¸°ì¤€ endAt ì‚¬ìš©
    }
  }catch(_){ /* ì„œë²„ ì‹¤íŒ¨ ë¬´ì‹œí•˜ê³  ë¡œì»¬ë¡œ ì§„í–‰ */ }

  workshopEndAt = new Date(endTs);
  localStorage.setItem('workshopEndAt', String(endTs));
  clearGate();
  runTick();
  startServerSync();
  toast('ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘!','success');
  track('start');
}

function runTick(){
  if(timerInterval) clearInterval(timerInterval);
  const disp=document.getElementById('timerDisplay');
  const tick=()=>{
    const remain=(workshopEndAt?workshopEndAt.getTime():Date.now())-Date.now();
    disp.textContent=fmt(remain);
    if(remain<=0){
      clearInterval(timerInterval);
      disp.textContent="00:00:00";
    }
  };
  tick();
  timerInterval=setInterval(tick,1000);
}

/* 30ì´ˆë§ˆë‹¤ ì„œë²„ ê¸°ì¤€ ë‚¨ì€ ì‹œê°„ ë™ê¸°í™” */
function startServerSync(){
  if(serverSyncInterval) clearInterval(serverSyncInterval);
  serverSyncInterval = setInterval(refreshRemainingFromServer, 30000);
  refreshRemainingFromServer(); // ì¦‰ì‹œ 1íšŒ
}
async function refreshRemainingFromServer(){
  if(!currentUser || !sessionId) return;
  const r = await apiRequest('getRemaining', { sessionId, userName: currentUser });
  if(!r || !r.success) return;
  if(r.status === 'nostart'){ applyGate(); return; }
  workshopEndAt = new Date(r.endAt);
  localStorage.setItem('workshopEndAt', String(r.endAt));
  if(r.status === 'ended' || r.remainingMs <= 0) onTimerEnd();
}
function onTimerEnd(){
  if(serverSyncInterval){ clearInterval(serverSyncInterval); serverSyncInterval=null; }
  applyGate();
  const disp=document.getElementById('timerDisplay'); if(disp) disp.textContent='00:00:00';
  toast('ì›Œí¬ìˆì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì„¤ë¬¸ì— ì°¸ì—¬í•´ì£¼ì„¸ìš”.','success');
  openSurvey();
  track('timer_end');
}

/* ì°¸ì—¬ ì´ì „ ìƒíƒœë¡œ ë˜ëŒë¦¬ê¸° */
function revertToPreStart(){
  try{
    if (timerInterval) { clearInterval(timerInterval); timerInterval=null; }
    localStorage.removeItem('workshopEndAt');
    workshopEndAt=null;
    const disp=document.getElementById('timerDisplay'); if(disp) disp.textContent='48:00:00';
    const btn=document.getElementById('startBtn');
    if(btn){
      btn.disabled=false;
      btn.textContent='ì›Œí¬ìˆ ì°¸ì—¬í•˜ê¸°';
    }
    applyGate();
    track('revert:pre_start');
    toast('ì°¸ì—¬ ì´ì „ ìƒíƒœë¡œ ë˜ëŒë ¸ìŠµë‹ˆë‹¤.','success');
  }catch(e){
    console.error(e);
    toast('ë˜ëŒë¦¬ê¸° ì‹¤íŒ¨','error');
  }
}

/* ====== LOGIN ====== */
async function doLogin(){
  const name = document.getElementById('userName').value.trim();
  const mbti = document.getElementById('userMBTI').value.trim();

  if (!name || !mbti) {
    return toast('ì´ë¦„ê³¼ MBTIë¥¼ ì…ë ¥/ì„ íƒí•˜ì„¸ìš”', 'error');
  }

  // ì´ë¦„ 2~4ê¸€ì ì œí•œ
  if (name.length < 2 || name.length > 4) {
    return toast('ì´ë¦„ì€ 2~4ê¸€ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
  }

  currentUser = name;
  sessionId = 'session_' + Date.now();

  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('mainScreen').classList.remove('hidden');
  document.getElementById('userNameDisplay').textContent = currentUser;
  document.getElementById('userTeamDisplay').textContent = 'íˆ¬ì–´íŒ¨ìŠ¤ì‚¬ì—…ë¶€';

  // ë¡œê·¸ì¸ ìºì‹œ (ì´ë¦„/MBTIë§Œ ì €ì¥)
  localStorage.setItem('loginCache', JSON.stringify({ name, mbti }));
  localStorage.setItem('sessionId', sessionId);

  apiRequest('login', { sessionId, userName: name, mbti, team:'íˆ¬ì–´íŒ¨ìŠ¤ì‚¬ì—…ë¶€', position:'' });
  track('login', { mbti });

  const stored = localStorage.getItem('workshopEndAt');
  if (stored) {
    workshopEndAt = new Date(Number(stored));
    runTick();
    clearGate();
    startServerSync();
  } else {
    applyGate();
  }

  toast(`í™˜ì˜í•©ë‹ˆë‹¤, ${name}ë‹˜!`, 'success');
}

async function doLogout(){
  await apiRequest('updateUserStatus',{sessionId,userName:currentUser,status:'offline'});
  localStorage.removeItem('loginCache');
  localStorage.removeItem('sessionId');
  // localStorage.removeItem('workshopEndAt'); // ìœ ì§€í•˜ë ¤ë©´ ê·¸ëŒ€ë¡œ ë‘ 
  location.reload();
}

function restore(){
  const cache = localStorage.getItem('loginCache');
  if (!cache) return;
  try{
    const data = JSON.parse(cache);
    const name = data.name;
    const mbti = data.mbti;

    if (!name || !mbti) return;

    currentUser = name;
    sessionId = localStorage.getItem('sessionId') || ('session_' + Date.now());

    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainScreen').classList.remove('hidden');
    document.getElementById('userNameDisplay').textContent = currentUser;
    document.getElementById('userTeamDisplay').textContent = 'íˆ¬ì–´íŒ¨ìŠ¤ì‚¬ì—…ë¶€';

    const stored = localStorage.getItem('workshopEndAt');
    if (stored) {
      workshopEndAt = new Date(Number(stored));
      runTick();
      clearGate();
      startServerSync();
    } else {
      applyGate();
    }

    toast(`ìë™ë¡œê·¸ì¸: ${name}`,'success');
  }catch(_){}
}

/* ====== ë°ì¼ë¦¬ í¬ì¶˜ ====== */
function seeded(name){
  let t=0;
  for(let i=0;i<name.length;i++) t=(t*31+name.charCodeAt(i))>>>0;
  return ()=>{
    t=(t+0x6D2B79F5)>>>0;
    let r=Math.imul(t^(t>>>15),1|t);
    r^=r+Math.imul(r^(r>>>7),61|r);
    return((r^(r>>>14))>>>0)/4294967296;
  };
}
function openFortune(){
  const rng=seeded(currentUser + new Date().toISOString().slice(0,10));
  const grade=['â˜…â˜…â˜…â˜…â˜…','â˜…â˜…â˜…â˜…â˜†','â˜…â˜…â˜…â˜†â˜†','â˜…â˜…â˜†â˜†â˜†','â˜…â˜†â˜†â˜†â˜†'];
  const pick=a=>a[Math.floor(rng()*a.length)];
  const lucky=Math.floor(rng()*99)+1;
  const sec=(tit)=>`<div class="border border-gray-200 rounded-lg p-3 mb-2"><div class="font-bold">${tit}<span class="float-right">${pick(grade)}</span></div><div class="text-gray-600 mt-1">`+
    `${pick(['ì‘ê²Œ ì‹œì‘í•˜ë©´ í¬ê²Œ ëŒì•„ì˜µë‹ˆë‹¤.','ê³¼ê°íˆ ëœì–´ë‚´ë©´ ì†ë„ê°€ ë‚©ë‹ˆë‹¤.','íƒ€ì´ë°ì€ ì§€ê¸ˆ! ë¯¸ë£¨ì§€ ë§ê¸°.','ì‚¬ëŒì„ ë¨¼ì € ì±™ê¸°ë©´ ì¼ì´ í’€ë¦½ë‹ˆë‹¤.','ë°ì´í„°ë¡œ í™•ì¸í•˜ì„¸ìš”.'])}</div></div>`;
  document.getElementById('fortuneBody').innerHTML=
    `<div class="text-center mb-2"><div class="text-sm text-gray-500">ì˜¤ëŠ˜</div><div class="font-bold text-lg">${currentUser}ë‹˜ì˜ ë°ì¼ë¦¬ í¬ì¶˜</div></div>`+
    sec('ì „ì²´ìš´')+sec('ì—°ì• ìš´')+sec('ê¸ˆì „ìš´')+sec('ê±´ê°•ìš´')+sec('ì—…ë¬´/í•™ì—…')+
    `<div class="grid grid-cols-2 gap-2 mt-2">
       <div class="border border-gray-200 rounded-lg p-3"><div class="font-bold">ëŸ­í‚¤ ë„˜ë²„</div><div>${lucky}</div></div>
       <div class="border border-gray-200 rounded-lg p-3"><div class="font-bold">ëŸ­í‚¤ ì»¬ëŸ¬</div><div>${pick(['ì½”ë„','ì˜¤ë Œì§€','ë¼ì´íŠ¸ í”¼ì¹˜','ì•„ì´ë³´ë¦¬','ëª¨ì¹´'])}</div></div>
     </div>`;
  showModal('fortuneModal');
  track('click:menu_fortune');
}

/* ====== ì‹¬ë¦¬í…ŒìŠ¤íŠ¸ ====== */
const PSY_QUESTIONS=[
  {text:'ì‚¬ëŒ ë§ì€ í™œë™ì—ì„œ ì—ë„ˆì§€ê°€ ìƒê¸´ë‹¤.',pos:'E'},
  {text:'ê³„íšëŒ€ë¡œ ì›€ì§ì¼ ë•Œ ì•ˆì •ê°ì„ ëŠë‚€ë‹¤.',pos:'J'},
  {text:'ê²°ì •ë³´ë‹¤ ê´€ê³„ì˜ ì¡°í™”ê°€ ë” ì¤‘ìš”í•˜ë‹¤.',pos:'F'},
  {text:'ì˜ˆìƒì¹˜ ëª»í•œ ì œì•ˆë„ ì¦‰í¥ì ìœ¼ë¡œ ìˆ˜ë½í•œë‹¤.',pos:'P'},
  {text:'í˜¼ìë§Œì˜ ì‹œê°„ì—ì„œ ì§‘ì¤‘ë ¥ì´ ì˜¤ë¥¸ë‹¤.',pos:'I'}
];
let psyIdx=0, score={E:0,I:0,J:0,P:0,F:0,T:0};
function renderPsy(){
  document.getElementById('psyTitle').textContent=`${psyIdx+1}/${PSY_QUESTIONS.length}`;
  document.getElementById('psyQuestion').textContent=PSY_QUESTIONS[psyIdx].text;
}
function answerPsy(isO){
  const q=PSY_QUESTIONS[psyIdx];
  if(isO) score[q.pos]=(score[q.pos]||0)+1;
  else score[{E:'I',I:'E',J:'P',P:'J',F:'T',T:'F'}[q.pos]]++;
  psyIdx++;
  if(psyIdx<PSY_QUESTIONS.length) renderPsy();
  else showPsyResult();
}
function showPsyResult(){
  const EI=(score.E||0)>=(score.I||0)?'E':'I';
  const JP=(score.J||0)>=(score.P||0)?'J':'P';
  const FT=(score.F||0)>=(score.T||0)?'F':'T';
  let animal={emoji:'ğŸ¶',title:'í™œë°œí•œ ê°•ì•„ì§€',desc:'ì‚¬êµì„±Â·ì¦‰í¥ë ¥ì´ ê°•ì !'};
  if(EI==='E'&&JP==='J') animal={emoji:'ğŸ¦Š',title:'ë˜‘ë˜‘í•œ ì—¬ìš°í˜• ë¦¬ë”',desc:'ê³„íšì  ì†Œí†µí˜• ë¦¬ë”'};
  if(EI==='I'&&JP==='P') animal={emoji:'ğŸ±',title:'ê³ ì–‘ì´ íƒí—˜ê°€',desc:'í˜¼ì ì¶©ì „Â·ë²ˆëœ©ì„'};
  if(EI==='I'&&JP==='J') animal={emoji:'ğŸ¦‰',title:'í˜„ì ì˜¬ë¹¼ë¯¸',desc:'ë¶„ì„Â·ì²´ê³„ ì „ëµê°€'};
  if(FT==='F'&&EI==='E') animal={emoji:'ğŸ¦¦',title:'ì‚¬êµì ì¸ ìˆ˜ë‹¬',desc:'íŒ€ ë¶„ìœ„ê¸° ë©”ì´ì»¤'};
  document.getElementById('psyStep').classList.add('hidden');
  document.getElementById('psyResult').classList.remove('hidden');
  document.getElementById('resEmoji').textContent=animal.emoji;
  document.getElementById('resTitle').textContent=animal.title;
  document.getElementById('resDesc').textContent=animal.desc;
  document.getElementById('resTags').innerHTML=['E/I','J/P','F/T'].map(t=>`<span>#${t}</span>`).join(' ');
}
function resetPsy(){
  psyIdx=0;
  score={E:0,I:0,J:0,P:0,F:0,T:0};
  document.getElementById('psyStep').classList.remove('hidden');
  document.getElementById('psyResult').classList.add('hidden');
  renderPsy();
}
function openPsy(){
  resetPsy();
  showModal('psyModal');
  track('click:menu_psy');
}

/* ====== ì›Œí¬ìˆ ì¼ì • ====== */
const SCHEDULE=[
  { dayTitle:'ì²«ì§¸ ë‚  (10ì›” 16ì¼)', rows:[
    {time:'14:50',act:'ë¡œë¹„ ì§‘í•©',place:'ë¡¯ë°ë¦¬ì¡°íŠ¸ë¶€ì—¬'},
    {time:'15:30',act:'ì²´í¬ì¸ ë° ë°©ë°°ì •',place:'ë¡¯ë°ë¦¬ì¡°íŠ¸ë¶€ì—¬'},
    {time:'15:30',act:'ì•„ë¡œë§ˆ ë²„ë¬¼ë¦¬ ë§Œë“¤ê¸°',place:'ìˆ˜ë³µë¡œ1945'},
    {time:'16:00',act:'ì›ì¤€ë‹˜ ë„ìŠ¨íŠ¸ íˆ¬ì–´',place:'ë°±ì œë¬¸í™”ë‹¨ì§€'},
    {time:'17:30',act:'ììœ ì‹œê°„',place:'ì°¨ëŸ‰ë³„'},
    {time:'18:30',act:'ì €ë…ì‹ì‚¬',place:'ì„œë™í•œìš° ê·œì•”ì '},
    {time:'21:00',act:'íšŒì‹ (ê²½í’ˆ ì´ë²¤íŠ¸)\n*ë¶€ì—¬í†µë‹­/ë³´ë ¹ë§¥ì£¼',place:'ë¶€ì—¬ë¦¬ì¡°íŠ¸ë¶€ì—¬'},
    {time:'22:00',act:'ììœ íšŒì‹/íœ´ì‹',place:'-'},
  ]},
  { dayTitle:'ë‘˜ì§¸ ë‚  (10ì›” 17ì¼)', rows:[
    {time:'11:00',act:'ì•„ì¹¨ ê²¸ ì ì‹¬ì‹ì‚¬',place:'ì¥ì›ë§‰êµ­ìˆ˜'},
    {time:'12:30',act:'ì›Œí¬ìˆ ì¥ì†Œ ì§‘í•©',place:'ì‚¬ë¹„123ì°½ì°©ì„¼í„°'},
    {time:'12:30',act:'2026 íˆ¬ì–´íŒ¨ìŠ¤ì‚¬ì—…ë¶€ ì‚¬ì—… ì¶”ì§„ê³„íš / ë‚¨ë„í˜„ ì´ì‚¬',place:'ë‚¨ë„í˜„'},
    {time:'13:10',act:'3íŒ€ ì„±ê³¼ ë° ì¶”ì§„ê³„íš',place:'ê¹€ëŒ€ì§„'},
    {time:'13:30',act:'2íŒ€ ì„±ê³¼ ë° ì¶”ì§„ê³„íš',place:'ê¹€í˜„ì² '},
    {time:'13:50',act:'1íŒ€ ì„±ê³¼ ë° ì¶”ì§„ê³„íš',place:'ê¹€ìˆ˜ì¸'},
    {time:'14:10',act:'ê·€ê°€',place:'-'},
  ]},
];
function renderSchedule(){
  const body=document.getElementById('scheduleBody');
  body.innerHTML=SCHEDULE.map(day=>{
    const rows=day.rows.map(r=>`<tr>
      <td class="py-2 px-2 font-bold" style="color:#df6444">${r.time}</td>
      <td class="py-2 px-2">${r.act.replaceAll('\\n','<br>')}</td>
      <td class="py-2 px-2 text-gray-600">${r.place}</td></tr>`).join('');
    return `<div class="px-3 py-2 font-extrabold" style="background:#fff2ec;border-radius:.75rem;margin:.25rem 0 .5rem;color:#c04e32"> ${day.dayTitle}</div>
      <table class="w-full border-collapse">
        <thead><tr class="text-left text-gray-500"><th class="py-2 px-2 w-20">ì‹œê°„</th><th class="py-2 px-2">í™œë™</th><th class="py-2 px-2 w-32">ì¥ì†Œ</th></tr></thead>
        <tbody class="border-t border-gray-200">${rows}</tbody>
      </table>`;
  }).join('');
}
function openSchedule(){
  renderSchedule();
  showModal('scheduleModal');
  track('click:menu_schedule');
}

/* ====== ë§Œì¡±ë„ ì¡°ì‚¬ ====== */
function openSurvey(){
  document.getElementById('surveyForm').reset();
  document.getElementById('surveyForm').classList.remove('hidden');
  document.getElementById('surveyDone').classList.add('hidden');
  showModal('surveyModal');
  track('click:menu_survey');
}
async function submitSurvey(e){
  e.preventDefault();
  const fd = new FormData(e.target);
  const satisfaction = fd.get('satisfaction');
  let best = document.getElementById('bestProgram').value || '';
  const etc = document.getElementById('bestProgramEtc').value.trim();
  if (best.startsWith('ê¸°íƒ€') && etc) best = `ê¸°íƒ€(${etc})`;
  const feedback = (document.getElementById('improve').value || '').trim();

  if(!satisfaction){
    toast('ë§Œì¡±ë„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”','error');
    return;
  }

  const res = await apiRequest('saveSurvey', {
    user: currentUser || 'ê²ŒìŠ¤íŠ¸',
    satisfaction,
    useful_program: best,
    feedback
  });

  if(res && res.success){
    toast('ì œì¶œ ì™„ë£Œ!','success');
    track('submit:survey',{satisfaction, best});
    const box = document.getElementById('surveySummary');
    box.innerHTML = `
      <div><b>ë§Œì¡±ë„</b> : ${satisfaction} / 5</div>
      <div><b>ê°€ì¥ ë§Œì¡±</b> : ${best || '-'}</div>
      <div><b>ê°œì„ ì‚¬í•­</b> : ${feedback ? feedback.replaceAll('<','&lt;') : '-'}</div>
    `;
    document.getElementById('surveyForm').classList.add('hidden');
    document.getElementById('surveyDone').classList.remove('hidden');
  } else {
    toast('ì €ì¥ ì‹¤íŒ¨. ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.','error');
  }
}

/* ====== íšŒì‚¬ì†Œê°œì„œ ë°›ê¸° ====== */
function openBrochure(){
  if(!currentUser){
    toast('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”','error');
    return;
  }
  const input=document.getElementById('brochureEmail');
  if(input) input.value='';
  showModal('brochureModal');
  track('click:brochure');
}

async function sendBrochure(){
  const input=document.getElementById('brochureEmail');
  if(!input) return;
  const email=input.value.trim();

  if(!email){
    toast('ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”','error');
    return;
  }
  // ê°„ë‹¨ ì´ë©”ì¼ í˜•ì‹ ê²€ì¦
  if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){
    toast('ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”','error');
    return;
  }

  const res = await apiRequest('requestBrochure',{
    sessionId,
    userName: currentUser || '',
    email
  });

  if(res && res.success){
    toast('íšŒì‚¬ì†Œê°œì„œë¥¼ ë©”ì¼ë¡œ ë°œì†¡í–ˆìŠµë‹ˆë‹¤.','success');
    hideModal('brochureModal');
    track('send:brochure',{email});
  }else{
    toast('ë°œì†¡ ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.','error');
  }
}

/* ====== MODAL HELPERS ====== */
function showModal(id){document.getElementById(id).style.display='flex';}
function hideModal(id){document.getElementById(id).style.display='none';}
document.querySelectorAll('.close').forEach(btn=>btn.addEventListener('click',()=>hideModal(btn.dataset.close)));
window.addEventListener('click',e=>{
  document.querySelectorAll('.modal').forEach(m=>{
    if(e.target===m) m.style.display='none';
  });
});

/* ====== EVENTS ====== */
document.getElementById('loginBtn').addEventListener('click',doLogin);
document.getElementById('logoutBtn').addEventListener('click',doLogout);
document.querySelector('.logout').addEventListener('click',doLogout);
document.getElementById('startBtn').addEventListener('click',beginTimer);

document.getElementById('menuMbti').addEventListener('click',()=>{
  window.open(RELATION_URL,'_blank');
  track('click:mbti');
});
document.getElementById('menuFortune').addEventListener('click',openFortune);
document.getElementById('menuAI').addEventListener('click',()=>{
  window.open(AI_CHATBOT_URL,'_blank');
  track('click:ai');
});
document.getElementById('menuPsy').addEventListener('click',openPsy);
document.getElementById('btnO').addEventListener('click',()=>answerPsy(true));
document.getElementById('btnX').addEventListener('click',()=>answerPsy(false));
document.getElementById('psyRetry').addEventListener('click',resetPsy);
document.getElementById('menuSchedule').addEventListener('click',openSchedule);

document.getElementById('menuSurvey').addEventListener('click',openSurvey);
document.getElementById('surveyForm').addEventListener('submit',submitSurvey);

/* íšŒì‚¬ì†Œê°œì„œ ë°›ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ */
document.getElementById('menuDraft').addEventListener('click',openBrochure);
document.getElementById('brochureSendBtn').addEventListener('click',sendBrochure);

/* íƒ€ì´ë¨¸ ì¹´ë“œ ë¡±í”„ë ˆìŠ¤ â†’ revert */
(function setupLongPressRevert(){
  const box=document.getElementById('timerBox'); if(!box) return;
  let t=null;
  const start=()=>{ t=setTimeout(()=>revertToPreStart(),800); };
  const clear=()=>{ if(t){clearTimeout(t);t=null;} };
  box.addEventListener('mousedown',start);
  box.addEventListener('touchstart',start,{passive:true});
  ['mouseup','mouseleave','touchend','touchcancel'].forEach(ev=>box.addEventListener(ev,clear,{passive:true}));
})();

/* ====== INIT ====== */
(function init(){
  document.querySelectorAll('[data-close]').forEach(b=>b.addEventListener('click',()=>hideModal(b.getAttribute('data-close'))));
  restore();

  if(currentUser && sessionId){
    startServerSync();
  } else {
    applyGate();
  }

  const params = new URLSearchParams(location.search);
  if (params.get('reset') === '1') revertToPreStart();

  const end=localStorage.getItem('workshopEndAt');
  if(end){
    workshopEndAt=new Date(Number(end));
    runTick();
    clearGate();
  }
})();
</script>
</body>
</html>
